

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\alembic.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\env.py =====

import os
import sys
from logging.config import fileConfig

from sqlalchemy import engine_from_config, pool
from alembic import context

# Добавляем корень проекта в sys.path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Загружаем .env (если используете)
from dotenv import load_dotenv
load_dotenv(os.path.join(os.path.dirname(__file__), '..', '.env'))

# Конфигурация Alembic
config = context.config

# Если в .env есть DATABASE_URL, подставляем его в конфиг alembic
db_url = os.getenv("DATABASE_URL") or os.getenv("DATABASE_URL_LOCAL")
if db_url:
    config.set_main_option("sqlalchemy.url", db_url)

# Логирование
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Импортируем Base и модели, чтобы метаданные были зарегистрированы
from app.db.base import Base
import app.models.popular_quotes
import app.models.genre
import app.models.books_editions
import app.models.literature_works
import app.models.users_book_notes
import app.models.users_book_quotes
import app.models.users_reading_records
import app.models.users_book_rating
import app.models.users_top_characters
import app.models.users_challenge_books_alphabet
import app.models.users_challenge_book_of_year
import app.models.users_challenges
import app.models.users_statistics
import app.models.users_personal_data
import app.models.users_book_review_genres
import app.models.books_categories
import app.models.users_book_review

target_metadata = Base.metadata

def run_migrations_online():
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )
    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)
        with context.begin_transaction():
            context.run_migrations()

if context.is_offline_mode():
    context.configure(url=config.get_main_option("sqlalchemy.url"), target_metadata=target_metadata)
    with context.begin_transaction():
        context.run_migrations()
else:
    run_migrations_online()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\alembic_versions.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\17d062ffd73f_add_language_to_books_editions.py =====

"""add language to books_editions

Revision ID: 17d062ffd73f
Revises: f67d12b7990d
Create Date: 2025-11-29 21:48:52.214101

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '17d062ffd73f'
down_revision: Union[str, Sequence[str], None] = 'f67d12b7990d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('books_editions', sa.Column('language', sa.String(length=50), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('books_editions', 'language')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\22a7d740fe08_create_users_top_characters.py =====

"""create users_top_characters

Revision ID: 22a7d740fe08
Revises: bd8b55d6e45d
Create Date: 2025-11-29 23:49:10.208795

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '22a7d740fe08'
down_revision: Union[str, Sequence[str], None] = 'bd8b55d6e45d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_top_characters',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('top_1', sa.String(length=255), nullable=True),
    sa.Column('top_2', sa.String(length=255), nullable=True),
    sa.Column('top_3', sa.String(length=255), nullable=True),
    sa.Column('top_4', sa.String(length=255), nullable=True),
    sa.Column('top_5', sa.String(length=255), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_top_characters_id'), 'users_top_characters', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_top_characters_id'), table_name='users_top_characters')
    op.drop_table('users_top_characters')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\2fd3813264e1_add_relations_with_users_personal_data.py =====

"""add relations with users_personal_data

Revision ID: 2fd3813264e1
Revises: 908f851b98ac
Create Date: 2025-11-30 20:38:29.599006

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '2fd3813264e1'
down_revision: Union[str, Sequence[str], None] = '908f851b98ac'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users_challenge_book_of_year', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_book_of_year', 'users_personal_data', ['user_id'], ['id'])
    op.add_column('users_challenge_books_alphabet', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_books_alphabet', 'users_personal_data', ['user_id'], ['id'])
    op.add_column('users_challenges', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenges', 'users_personal_data', ['user_id'], ['id'])
    op.add_column('users_statistics', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_statistics', 'users_personal_data', ['user_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'users_statistics', type_='foreignkey')
    op.drop_column('users_statistics', 'user_id')
    op.drop_constraint(None, 'users_challenges', type_='foreignkey')
    op.drop_column('users_challenges', 'user_id')
    op.drop_constraint(None, 'users_challenge_books_alphabet', type_='foreignkey')
    op.drop_column('users_challenge_books_alphabet', 'user_id')
    op.drop_constraint(None, 'users_challenge_book_of_year', type_='foreignkey')
    op.drop_column('users_challenge_book_of_year', 'user_id')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\316574416a9d_create_genres_table.py =====

"""create genres table

Revision ID: 316574416a9d
Revises: f8f32195f7ff
Create Date: 2025-11-29 20:21:30.042282

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '316574416a9d'
down_revision: Union[str, Sequence[str], None] = 'f8f32195f7ff'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    op.create_table(
        'genres',
        sa.Column('id', sa.Integer(), primary_key=True, nullable=False),
        sa.Column('name', sa.String(length=200), nullable=False),
    )
    op.create_unique_constraint('uq_genres_name', 'genres', ['name'])

    genres = [
        "Young adult",
        "Античная литература",
        "Белорусская литература",
        "Биография, мемуары",
        "Бизнес-книги",
        "Боевик",
        "Детектив",
        "Детская литература",
        "Журнал, газета, статья",
        "Зарубежная литература",
        "Здоровье, медицина",
        "Историческая литература",
        "Комедия",
        "Комикс, манга, манхва, вебтун",
        "Культура, искусство",
        "Мифы, легенды, эпос",
        "На иностранном языке",
        "Научно-популярная литература",
        "Научная фантастика",
        "Нон-фикшн",
        "Приключения",
        "Психология",
        "Пьеса",
        "Религия",
        "Роман",
        "Русская классика",
        "Стихи, поэзия",
        "Техническая литература",
        "Триллер",
        "Ужасы, мистика",
        "Учебная литература",
        "Фантастика",
        "Философия",
        "Фэнтези",
        "Энциклопедия, справочник",
        "18+"
    ]
    for g in genres:
        op.execute(
            sa.text("INSERT INTO genres (name) VALUES (:name) ON CONFLICT (name) DO NOTHING")
            .bindparams(name=g)
        )

def downgrade() -> None:
    op.drop_table('genres')


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\33202f8c22ce_add_users_book_review_and_related_tables.py =====

"""add users_book_review and related tables

Revision ID: 33202f8c22ce
Revises: 2fd3813264e1
Create Date: 2025-11-30 22:43:41.622983

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '33202f8c22ce'
down_revision: Union[str, Sequence[str], None] = '2fd3813264e1'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('books_categories',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_index(op.f('ix_books_categories_id'), 'books_categories', ['id'], unique=False)
    op.create_table('users_book_review',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('book_id', sa.Integer(), nullable=False),
    sa.Column('category_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['book_id'], ['books_editions.id'], ),
    sa.ForeignKeyConstraint(['category_id'], ['books_categories.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users_personal_data.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_review_id'), 'users_book_review', ['id'], unique=False)
    op.create_table('users_book_review_genres',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('review_id', sa.Integer(), nullable=False),
    sa.Column('genre_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['genre_id'], ['genres.id'], ),
    sa.ForeignKeyConstraint(['review_id'], ['users_book_review.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_review_genres_id'), 'users_book_review_genres', ['id'], unique=False)
    op.add_column('users_book_notes', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_book_notes', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_book_quotes', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_book_quotes', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_book_rating', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_unique_constraint(None, 'users_book_rating', ['review_id'])
    op.create_foreign_key(None, 'users_book_rating', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_challenge_book_of_year', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_book_of_year', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_challenge_books_alphabet', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_books_alphabet', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_reading_records', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_reading_records', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_top_characters', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_unique_constraint(None, 'users_top_characters', ['review_id'])
    op.create_foreign_key(None, 'users_top_characters', 'users_book_review', ['review_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'users_top_characters', type_='foreignkey')
    op.drop_constraint(None, 'users_top_characters', type_='unique')
    op.drop_column('users_top_characters', 'review_id')
    op.drop_constraint(None, 'users_reading_records', type_='foreignkey')
    op.drop_column('users_reading_records', 'review_id')
    op.drop_constraint(None, 'users_challenge_books_alphabet', type_='foreignkey')
    op.drop_column('users_challenge_books_alphabet', 'review_id')
    op.drop_constraint(None, 'users_challenge_book_of_year', type_='foreignkey')
    op.drop_column('users_challenge_book_of_year', 'review_id')
    op.drop_constraint(None, 'users_book_rating', type_='foreignkey')
    op.drop_constraint(None, 'users_book_rating', type_='unique')
    op.drop_column('users_book_rating', 'review_id')
    op.drop_constraint(None, 'users_book_quotes', type_='foreignkey')
    op.drop_column('users_book_quotes', 'review_id')
    op.drop_constraint(None, 'users_book_notes', type_='foreignkey')
    op.drop_column('users_book_notes', 'review_id')
    op.drop_index(op.f('ix_users_book_review_genres_id'), table_name='users_book_review_genres')
    op.drop_table('users_book_review_genres')
    op.drop_index(op.f('ix_users_book_review_id'), table_name='users_book_review')
    op.drop_table('users_book_review')
    op.drop_index(op.f('ix_books_categories_id'), table_name='books_categories')
    op.drop_table('books_categories')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\725b1d704ec7_create_users_book_notes.py =====

"""create users_book_notes

Revision ID: 725b1d704ec7
Revises: 17d062ffd73f
Create Date: 2025-11-29 22:46:22.336812

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '725b1d704ec7'
down_revision: Union[str, Sequence[str], None] = '17d062ffd73f'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_book_notes',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('text', sa.Text(), nullable=False),
    sa.Column('date', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_notes_id'), 'users_book_notes', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_book_notes_id'), table_name='users_book_notes')
    op.drop_table('users_book_notes')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\758366379bad_create_users_reading_records.py =====

"""create users_reading_records

Revision ID: 758366379bad
Revises: ecb9ff41ebcb
Create Date: 2025-11-29 23:27:16.076853

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '758366379bad'
down_revision: Union[str, Sequence[str], None] = 'ecb9ff41ebcb'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_reading_records',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('start_date', sa.Date(), nullable=True),
    sa.Column('end_date', sa.Date(), nullable=True),
    sa.Column('result', sa.String(length=50), nullable=False),
    sa.Column('comment', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_reading_records_id'), 'users_reading_records', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_reading_records_id'), table_name='users_reading_records')
    op.drop_table('users_reading_records')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\7588e4eda91c_create_users_challenge_books_alphabet.py =====

"""create users_challenge_books_alphabet

Revision ID: 7588e4eda91c
Revises: 22a7d740fe08
Create Date: 2025-11-30 19:47:08.556049

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '7588e4eda91c'
down_revision: Union[str, Sequence[str], None] = '22a7d740fe08'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_challenge_books_alphabet',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('letter', sa.String(length=1), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_challenge_books_alphabet_id'), 'users_challenge_books_alphabet', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_challenge_books_alphabet_id'), table_name='users_challenge_books_alphabet')
    op.drop_table('users_challenge_books_alphabet')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\7fe66b3c43c0_add_colors_to_genres_and_categories.py =====

"""add_colors_to_genres_and_categories

Revision ID: 7fe66b3c43c0
Revises: de8061a41eee
Create Date: 2026-02-02 11:47:58.917023

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '7fe66b3c43c0'
down_revision: Union[str, Sequence[str], None] = 'de8061a41eee'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('books_categories', sa.Column('color', sa.String(length=7), server_default='#AB66FF', nullable=False))
    op.add_column('genres', sa.Column('color', sa.String(length=7), server_default='#AB66FF', nullable=False))

    op.execute("UPDATE books_categories SET color = '#E0C217' WHERE name = 'Хочу прочитать'")
    op.execute("UPDATE books_categories SET color = '#46AC16' WHERE name = 'Читаю'")
    op.execute("UPDATE books_categories SET color = '#1AB7E3' WHERE name = 'Брошено'")
    op.execute("UPDATE books_categories SET color = '#EE619E' WHERE name = 'Любимые'")
    op.execute("UPDATE books_categories SET color = '#AB66FF' WHERE name = 'Прочитано'")

    op.execute("UPDATE genres SET color = '#FFA2C4' WHERE name = 'Young adult'")
    op.execute("UPDATE genres SET color = '#D4B483' WHERE name = 'Античная литература'")
    op.execute("UPDATE genres SET color = '#069947' WHERE name = 'Белорусская литература'")
    op.execute("UPDATE genres SET color = '#8F4C19' WHERE name = 'Биография, мемуары'")
    op.execute("UPDATE genres SET color = '#0A66C2' WHERE name = 'Бизнес-книги'")
    op.execute("UPDATE genres SET color = '#C62828' WHERE name = 'Боевик'")
    op.execute("UPDATE genres SET color = '#FF8800' WHERE name = 'Детектив'")
    op.execute("UPDATE genres SET color = '#FFDA61' WHERE name = 'Детская литература'")
    op.execute("UPDATE genres SET color = '#416692' WHERE name = 'Журнал, газета, статья'")
    op.execute("UPDATE genres SET color = '#89E835' WHERE name = 'Зарубежная литература'")
    op.execute("UPDATE genres SET color = '#4ABCA1' WHERE name = 'Здоровье, медицина'")
    op.execute("UPDATE genres SET color = '#816E5A' WHERE name = 'Историческая литература'")
    op.execute("UPDATE genres SET color = '#FFB400' WHERE name = 'Комедия'")
    op.execute("UPDATE genres SET color = '#FF9F7C' WHERE name = 'Комикс, манга, манхва, вебтун'")
    op.execute("UPDATE genres SET color = '#B015EF' WHERE name = 'Культура, искусство'")
    op.execute("UPDATE genres SET color = '#7F48CD' WHERE name = 'Мифы, легенды, эпос'")
    op.execute("UPDATE genres SET color = '#008369' WHERE name = 'На иностранном языке'")
    op.execute("UPDATE genres SET color = '#00D9FF' WHERE name = 'Научно-популярная литература'")
    op.execute("UPDATE genres SET color = '#90CBFE' WHERE name = 'Научная фантастика'")
    op.execute("UPDATE genres SET color = '#96B463' WHERE name = 'Нон-фикшн'")
    op.execute("UPDATE genres SET color = '#FF3D00' WHERE name = 'Приключения'")
    op.execute("UPDATE genres SET color = '#7361FF' WHERE name = 'Психология'")
    op.execute("UPDATE genres SET color = '#89EAC8' WHERE name = 'Пьеса'")
    op.execute("UPDATE genres SET color = '#4604A2' WHERE name = 'Религия'")
    op.execute("UPDATE genres SET color = '#FF6565' WHERE name = 'Роман'")
    op.execute("UPDATE genres SET color = '#BEAA12' WHERE name = 'Русская классика'")
    op.execute("UPDATE genres SET color = '#FF2CF1' WHERE name = 'Стихи, поэзия'")
    op.execute("UPDATE genres SET color = '#8E8E8E' WHERE name = 'Техническая литература'")
    op.execute("UPDATE genres SET color = '#222222' WHERE name = 'Триллер'")
    op.execute("UPDATE genres SET color = '#680000' WHERE name = 'Ужасы, мистика'")
    op.execute("UPDATE genres SET color = '#DD96D8' WHERE name = 'Учебная литература'")
    op.execute("UPDATE genres SET color = '#000FB2' WHERE name = 'Фантастика'")
    op.execute("UPDATE genres SET color = '#B68AEB' WHERE name = 'Философия'")
    op.execute("UPDATE genres SET color = '#57B168' WHERE name = 'Фэнтези'")
    op.execute("UPDATE genres SET color = '#145816' WHERE name = 'Энциклопедия, справочник'")
    op.execute("UPDATE genres SET color = '#FF0037' WHERE name = '18+'")

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('genres', 'color')
    op.drop_column('books_categories', 'color')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\908f851b98ac_create_users_personal_data.py =====

"""create users_personal_data

Revision ID: 908f851b98ac
Revises: da48215a7e8f
Create Date: 2025-11-30 20:29:01.713327

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '908f851b98ac'
down_revision: Union[str, Sequence[str], None] = 'da48215a7e8f'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_personal_data',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('username', sa.String(length=50), nullable=False),
    sa.Column('email', sa.String(length=255), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=False),
    sa.Column('agreement_accepted', sa.Boolean(), nullable=True),
    sa.Column('registered_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('profile_photo', sa.String(length=255), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email'),
    sa.UniqueConstraint('username')
    )
    op.create_index(op.f('ix_users_personal_data_id'), 'users_personal_data', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_personal_data_id'), table_name='users_personal_data')
    op.drop_table('users_personal_data')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\bb018fe2ae50_create_users_challenge_book_of_year.py =====

"""create users_challenge_book_of_year

Revision ID: bb018fe2ae50
Revises: 7588e4eda91c
Create Date: 2025-11-30 19:56:55.401962

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'bb018fe2ae50'
down_revision: Union[str, Sequence[str], None] = '7588e4eda91c'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_challenge_book_of_year',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('month', sa.Integer(), nullable=True),
    sa.Column('stage', sa.String(length=50), nullable=False),
    sa.Column('is_winner', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_challenge_book_of_year_id'), 'users_challenge_book_of_year', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_challenge_book_of_year_id'), table_name='users_challenge_book_of_year')
    op.drop_table('users_challenge_book_of_year')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\bd8b55d6e45d_create_users_book_rating.py =====

"""create users_book_rating

Revision ID: bd8b55d6e45d
Revises: 758366379bad
Create Date: 2025-11-29 23:41:46.150237

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'bd8b55d6e45d'
down_revision: Union[str, Sequence[str], None] = '758366379bad'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_book_rating',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('total_rating', sa.Integer(), nullable=False),
    sa.Column('characters_rating', sa.Integer(), nullable=True),
    sa.Column('plot_rating', sa.Integer(), nullable=True),
    sa.Column('relations_rating', sa.Integer(), nullable=True),
    sa.Column('emotionality_rating', sa.Integer(), nullable=True),
    sa.Column('ending_rating', sa.Integer(), nullable=True),
    sa.Column('easy_reading_rating', sa.Integer(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_rating_id'), 'users_book_rating', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_book_rating_id'), table_name='users_book_rating')
    op.drop_table('users_book_rating')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\da48215a7e8f_create_users_statistics.py =====

"""create users_statistics

Revision ID: da48215a7e8f
Revises: ddfa1f232766
Create Date: 2025-11-30 20:20:49.550020

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'da48215a7e8f'
down_revision: Union[str, Sequence[str], None] = 'ddfa1f232766'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_statistics',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('books_in_library', sa.Integer(), nullable=True),
    sa.Column('books_read', sa.Integer(), nullable=True),
    sa.Column('books_favorites', sa.Integer(), nullable=True),
    sa.Column('favorite_author', sa.String(length=255), nullable=True),
    sa.Column('favorite_genre', sa.String(length=100), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_statistics_id'), 'users_statistics', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_statistics_id'), table_name='users_statistics')
    op.drop_table('users_statistics')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\ddfa1f232766_add_fk_from_challenges_to_alphabet_and_.py =====

"""add FK from challenges to alphabet and book_of_year

Revision ID: ddfa1f232766
Revises: e44138ccdf6a
Create Date: 2025-11-30 20:08:41.767755

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'ddfa1f232766'
down_revision: Union[str, Sequence[str], None] = 'e44138ccdf6a'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users_challenge_book_of_year', sa.Column('challenge_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_book_of_year', 'users_challenges', ['challenge_id'], ['id'])
    op.add_column('users_challenge_books_alphabet', sa.Column('challenge_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_books_alphabet', 'users_challenges', ['challenge_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'users_challenge_books_alphabet', type_='foreignkey')
    op.drop_column('users_challenge_books_alphabet', 'challenge_id')
    op.drop_constraint(None, 'users_challenge_book_of_year', type_='foreignkey')
    op.drop_column('users_challenge_book_of_year', 'challenge_id')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\de8061a41eee_add_verification_fields.py =====

"""add verification fields

Revision ID: de8061a41eee
Revises: 33202f8c22ce
Create Date: 2025-12-15 01:17:33.290890

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'de8061a41eee'
down_revision: Union[str, Sequence[str], None] = '33202f8c22ce'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users_personal_data', sa.Column('verification_code', sa.String(length=6), nullable=True))
    op.add_column('users_personal_data', sa.Column('is_verified', sa.Boolean(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users_personal_data', 'is_verified')
    op.drop_column('users_personal_data', 'verification_code')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\e44138ccdf6a_create_users_challenges.py =====

"""create users_challenges

Revision ID: e44138ccdf6a
Revises: bb018fe2ae50
Create Date: 2025-11-30 20:02:13.612813

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'e44138ccdf6a'
down_revision: Union[str, Sequence[str], None] = 'bb018fe2ae50'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_challenges',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('challenge_type', sa.String(length=50), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('finished_at', sa.DateTime(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_challenges_id'), 'users_challenges', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_challenges_id'), table_name='users_challenges')
    op.drop_table('users_challenges')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\ecb9ff41ebcb_create_users_book_quotes.py =====

"""create users_book_quotes

Revision ID: ecb9ff41ebcb
Revises: 725b1d704ec7
Create Date: 2025-11-29 23:10:13.421630

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'ecb9ff41ebcb'
down_revision: Union[str, Sequence[str], None] = '725b1d704ec7'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_book_quotes',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('text', sa.Text(), nullable=False),
    sa.Column('quote_author', sa.String(length=255), nullable=True),
    sa.Column('date', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_quotes_id'), 'users_book_quotes', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_book_quotes_id'), table_name='users_book_quotes')
    op.drop_table('users_book_quotes')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\f67d12b7990d_create_literature_works_and_books_.py =====

"""create literature_works and books_editions

Revision ID: f67d12b7990d
Revises: 316574416a9d
Create Date: 2025-11-29 21:45:44.102699

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'f67d12b7990d'
down_revision: Union[str, Sequence[str], None] = '316574416a9d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('literature_works',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('author', sa.String(length=255), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_literature_works_id'), 'literature_works', ['id'], unique=False)
    op.create_table('books_editions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('literature_work_id', sa.Integer(), nullable=False),
    sa.Column('original_year', sa.Integer(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('publisher', sa.String(length=255), nullable=True),
    sa.Column('year', sa.Integer(), nullable=True),
    sa.Column('pages', sa.Integer(), nullable=True),
    sa.Column('cover_url', sa.String(length=500), nullable=True),
    sa.Column('isbn', sa.String(length=20), nullable=True),
    sa.ForeignKeyConstraint(['literature_work_id'], ['literature_works.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('isbn')
    )
    op.create_index(op.f('ix_books_editions_id'), 'books_editions', ['id'], unique=False)
    op.create_index(op.f('ix_genres_id'), 'genres', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_genres_id'), table_name='genres')
    op.drop_index(op.f('ix_books_editions_id'), table_name='books_editions')
    op.drop_table('books_editions')
    op.drop_index(op.f('ix_literature_works_id'), table_name='literature_works')
    op.drop_table('literature_works')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\f8f32195f7ff_create_popular_quotes_table.py =====

from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision: str = 'f8f32195f7ff'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    op.create_table(
        'popular_quotes',
        sa.Column('id', sa.Integer(), primary_key=True, nullable=False),
        sa.Column('text', sa.Text(), nullable=False),
        sa.Column('book_title', sa.String(length=255), nullable=False),
    )


def downgrade() -> None:
    op.drop_table('popular_quotes')


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\main.py =====

# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.api import (
    popular_quotes,
    genre,
    literature,
    users_book_notes,
    users_book_quotes,
    users_reading_records,
    users_book_rating,
    users_top_characters,
    users_challenge_books_alphabet,
    users_challenge_book_of_year,
    users_challenges,
    users_statistics,
    users_personal_data,
    users_book_review_genres,
    books_categories,
    users_book_review,
    auth,
)

app = FastAPI(title="OwlReads API")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Единообразие: каждый сегмент — ровно один раз
app.include_router(popular_quotes.router, prefix="/api/quotes", tags=["quotes"])
app.include_router(genre.router,             prefix="/api/genres", tags=["genres"])
app.include_router(literature.router,        prefix="/api/literature", tags=["literature"])

app.include_router(users_book_notes.router,          prefix="/api/users_book_notes", tags=["users_book_notes"])
app.include_router(users_book_quotes.router,         prefix="/api/users_book_quotes", tags=["users_book_quotes"])
app.include_router(users_reading_records.router,     prefix="/api/users_reading_records", tags=["users_reading_records"])
app.include_router(users_book_rating.router,         prefix="/api/users_book_rating", tags=["users_book_rating"])
app.include_router(users_top_characters.router,      prefix="/api/users_top_characters", tags=["users_top_characters"])
app.include_router(users_challenge_books_alphabet.router, prefix="/api/users_challenge_books_alphabet", tags=["users_challenge_books_alphabet"])
app.include_router(users_challenge_book_of_year.router,   prefix="/api/users_challenge_book_of_year", tags=["users_challenge_book_of_year"])
app.include_router(users_challenges.router,          prefix="/api/users_challenges", tags=["users_challenges"])
app.include_router(users_statistics.router,          prefix="/api/users_statistics", tags=["users_statistics"])
app.include_router(users_personal_data.router,       prefix="/api/users_personal_data", tags=["users_personal_data"])
app.include_router(users_book_review_genres.router,  prefix="/api/users_book_review_genres", tags=["users_book_review_genres"])
app.include_router(books_categories.router,          prefix="/api/books_categories", tags=["books_categories"])
app.include_router(users_book_review.router,         prefix="/api/users_book_review", tags=["users_book_review"])

app.include_router(auth.router, prefix="/api/auth", tags=["auth"])

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_api.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\auth.py =====

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from pydantic import BaseModel, EmailStr

from app.db.session import get_db
from app.crud import users_personal_data as crud
from app.core.security import verify_password, create_access_token

router = APIRouter()

class LoginSchema(BaseModel):
    email: EmailStr
    password: str


@router.post("/login")
def login(login_data: LoginSchema, db: Session = Depends(get_db)):
    # 1. Ищем пользователя по email
    user = crud.get_user_by_email(db, email=login_data.email)

    # 2. Если пользователя нет ИЛИ пароль не подходит
    if not user or not verify_password(login_data.password, user.password_hash):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Неверный email или пароль",
            headers={"WWW-Authenticate": "Bearer"},
        )

    # 3. Если всё ок, создаем токен
    access_token = create_access_token(data={"sub": str(user.id)})

    return {
        "access_token": access_token,
        "token_type": "bearer",
        "user_id": user.id,
        "username": user.username
    }

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\books_categories.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.books_categories import BookCategory, BookCategoryCreate
from app.crud import books_categories as crud

router = APIRouter()

@router.post("/", response_model=BookCategory, status_code=201)
def create_category(category: BookCategoryCreate, db: Session = Depends(get_db)):
    db_category = crud.get_category_by_name(db, category.name)
    if db_category:
        raise HTTPException(status_code=400, detail="Category already exists")
    return crud.create_category(db, category)

@router.get("/", response_model=List[BookCategory])
def read_categories(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_categories(db, skip=skip, limit=limit)


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\genre.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import get_db   # <-- теперь импортируем отсюда
from app.models.genre import Genre as GenreModel
from app.schemas.genre import GenreRead

router = APIRouter()

@router.get("/", response_model=list[GenreRead])
def list_genres(db: Session = Depends(get_db)):
    return db.query(GenreModel).order_by(GenreModel.id).all()

@router.get("/{genre_id}/", response_model=GenreRead)
def get_genre(genre_id: int, db: Session = Depends(get_db)):
    genre = db.query(GenreModel).get(genre_id)
    if not genre:
        raise HTTPException(status_code=404, detail="Genre not found")
    return genre


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\literature.py =====

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from typing import List
from app.schemas.literature import LiteratureWork, LiteratureWorkCreate, BookEdition, BookEditionCreate
from app.crud import literature as crud
from app.db.session import get_db
from app.schemas.literature import BookSearchResponse

router = APIRouter()

# --- LiteratureWork ---
@router.post("/works", response_model=LiteratureWork)
def create_work(work: LiteratureWorkCreate, db: Session = Depends(get_db)):
    return crud.create_literature_work(db, work)

@router.get("/works", response_model=List[LiteratureWork])
def read_works(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_literature_works(db, skip=skip, limit=limit)

@router.get("/works/{work_id}", response_model=LiteratureWork)
def read_work(work_id: int, db: Session = Depends(get_db)):
    return crud.get_literature_work(db, work_id)


# --- BookEdition ---
@router.post("/editions", response_model=BookEdition)
def create_edition(edition: BookEditionCreate, db: Session = Depends(get_db)):
    return crud.create_book_edition(db, edition)

@router.get("/editions", response_model=List[BookEdition])
def read_editions(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_book_editions(db, skip=skip, limit=limit)

@router.get("/editions/{edition_id}", response_model=BookEdition)
def read_edition(edition_id: int, db: Session = Depends(get_db)):
    return crud.get_book_edition(db, edition_id)

@router.get("/search", response_model=List[BookSearchResponse])
def search_books_endpoint(q: str, db: Session = Depends(get_db)):
    if not q:
        return []

    books = crud.search_books(db, query=q)

    # Преобразуем ORM модели в Pydantic схему вручную или автоматически
    results = []
    for book in books:
        results.append(BookSearchResponse(
            id=book.id,
            title=book.work.title,  # Берем название из связанной таблицы
            author=book.work.author,  # Берем автора из связанной таблицы
            cover_url=book.cover_url,
            year=book.year,
            source="local"
        ))
    return results

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\popular_quotes.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy.sql.expression import func  # <--- Импортируем func для SQL функций

from app.db.session import get_db
from app.models.popular_quotes import PopularQuote as PopularQuoteModel
from app.schemas.popular_quotes import PopularQuoteCreate, PopularQuote as PopularQuoteSchema

router = APIRouter()


@router.post("/", response_model=PopularQuoteSchema, status_code=201)
def create_quote(quote: PopularQuoteCreate, db: Session = Depends(get_db)):
    db_quote = PopularQuoteModel(**quote.dict())
    db.add(db_quote)
    db.commit()
    db.refresh(db_quote)
    return db_quote


@router.get("/", response_model=list[PopularQuoteSchema])
def get_quotes(db: Session = Depends(get_db)):
    return db.query(PopularQuoteModel).all()


@router.get("/{quote_id}/", response_model=PopularQuoteSchema)
def get_quote(quote_id: int, db: Session = Depends(get_db)):
    quote = db.query(PopularQuoteModel).get(quote_id)
    if not quote:
        raise HTTPException(status_code=404, detail="Quote not found")
    return quote

@router.get("/random", response_model=PopularQuoteSchema)
def get_random_quote(db: Session = Depends(get_db)):
    quote = db.query(PopularQuoteModel).order_by(func.random()).first()

    if not quote:
        raise HTTPException(status_code=404, detail="No quotes found in database")

    return quote

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_notes.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_notes import UserBookNote, UserBookNoteCreate
from app.crud import users_book_notes as crud

router = APIRouter()

@router.post("/", response_model=UserBookNote, status_code=201)
def create_note(note: UserBookNoteCreate, db: Session = Depends(get_db)):
    return crud.create_note(db, note)

@router.get("/", response_model=List[UserBookNote])
def read_notes(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_notes(db, skip=skip, limit=limit)

@router.get("/{note_id}/", response_model=UserBookNote)
def read_note(note_id: int, db: Session = Depends(get_db)):
    note = crud.get_note(db, note_id)
    if not note:
        raise HTTPException(status_code=404, detail="Note not found")
    return note

@router.delete("/{note_id}/", status_code=204)
def delete_note(note_id: int, db: Session = Depends(get_db)):
    success = crud.delete_note(db, note_id)
    if not success:
        raise HTTPException(status_code=404, detail="Note not found")
    return None

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_quotes.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_quotes import UserBookQuote, UserBookQuoteCreate
from app.crud import users_book_quotes as crud

router = APIRouter()

@router.post("/", response_model=UserBookQuote, status_code=201)
def create_quote(quote: UserBookQuoteCreate, db: Session = Depends(get_db)):
    return crud.create_quote(db, quote)

@router.get("/", response_model=List[UserBookQuote])
def read_quotes(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_quotes(db, skip=skip, limit=limit)

@router.get("/{quote_id}/", response_model=UserBookQuote)
def read_quote(quote_id: int, db: Session = Depends(get_db)):
    quote = crud.get_quote(db, quote_id)
    if not quote:
        raise HTTPException(status_code=404, detail="Quote not found")
    return quote

@router.delete("/{quote_id}/", status_code=204)
def delete_quote(quote_id: int, db: Session = Depends(get_db)):
    success = crud.delete_quote(db, quote_id)
    if not success:
        raise HTTPException(status_code=404, detail="Quote not found")
    return None

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_rating.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_rating import UserBookRating, UserBookRatingCreate
from app.crud import users_book_rating as crud

router = APIRouter()

@router.post("/", response_model=UserBookRating, status_code=201)
def create_rating(rating: UserBookRatingCreate, db: Session = Depends(get_db)):
    return crud.create_rating(db, rating)

@router.get("/", response_model=List[UserBookRating])
def read_ratings(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_ratings(db, skip=skip, limit=limit)

@router.get("/{rating_id}/", response_model=UserBookRating)
def read_rating(rating_id: int, db: Session = Depends(get_db)):
    rating = crud.get_rating(db, rating_id)
    if not rating:
        raise HTTPException(status_code=404, detail="Rating not found")
    return rating


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_review.py =====

# app/api/users_book_review.py
import logging
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_review import UserBookReview, UserBookReviewCreate, LibraryBookRead, BookReviewDetail, UserBookReviewUpdateCategory, UserBookReviewUpdateGenres
from app.crud import users_book_review as crud
from app.schemas.custom_book import BookManualCreate

# Настройка логгера для отладки ошибок 500
logger = logging.getLogger(__name__)

router = APIRouter()


@router.post("/reviews", response_model=UserBookReview, status_code=201)
def create_review(review: UserBookReviewCreate, db: Session = Depends(get_db)):
    return crud.create_review(db, review)


@router.get("/reviews", response_model=List[UserBookReview])
def read_reviews(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_reviews(db, skip=skip, limit=limit)


@router.get("/reviews/{review_id}/", response_model=UserBookReview)
def read_review(review_id: int, db: Session = Depends(get_db)):
    review = crud.get_review_by_id(db, review_id)
    if not review:
        raise HTTPException(status_code=404, detail="Review not found")
    return review


@router.get("/users/{user_id}/reviews/by_category", response_model=List[UserBookReview])
def read_user_reviews_by_category(
        user_id: int,
        category_name: str = Query(..., description="Название категории, например: Прочитано"),
        db: Session = Depends(get_db),
):
    results = crud.get_user_reviews_by_category_name(db, user_id, category_name)
    return results

@router.patch("/reviews/{review_id}/category", response_model=UserBookReview)
def update_category(
    review_id: int,
    update_data: UserBookReviewUpdateCategory,
    db: Session = Depends(get_db)
):
    review = crud.update_review_category(db, review_id, update_data.category_name)
    if not review:
        raise HTTPException(status_code=404, detail="Review or Category not found")
    return review

@router.put("/reviews/{review_id}/genres")
def update_genres(
    review_id: int,
    update_data: UserBookReviewUpdateGenres,
    db: Session = Depends(get_db)
):
    crud.update_review_genres(db, review_id, update_data.genres)
    return {"message": "Genres updated successfully"}

@router.delete("/reviews/{review_id}/", status_code=204)
def delete_review(review_id: int, db: Session = Depends(get_db)):
    ok = crud.delete_review(db, review_id)
    if not ok:
        raise HTTPException(status_code=404, detail="Review not found")
    return None


@router.post("/manual", status_code=201)
def add_book_manually(
        book_data: BookManualCreate,
        user_id: int = Query(..., description="ID пользователя"),
        db: Session = Depends(get_db)
):
    review = crud.create_manual_book_review(db, user_id, book_data)
    if not review:
        raise HTTPException(status_code=400, detail="Category not found or error creating book")

    return {"message": "Book added successfully", "review_id": review.id}


@router.get("/library/{user_id}", response_model=List[LibraryBookRead])
def read_user_library(user_id: int, skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    reviews = crud.get_user_library(db, user_id, skip, limit)

    results = []
    for review in reviews:
        # Защита от ошибок, если вдруг данных нет
        book_title = review.book.work.title if review.book and review.book.work else "Без названия"
        book_author = review.book.work.author if review.book and review.book.work else "Неизвестный автор"
        cover = review.book.cover_url if review.book else None
        cat_name = review.category.name if review.category else "Без категории"
        cat_color = review.category.color if review.category else "#AB66FF"
        rating_val = review.rating.total_rating if review.rating else 0

        results.append(LibraryBookRead(
            review_id=review.id,
            book_id=review.book_id,
            title=book_title,
            author=book_author,
            cover_url=cover,
            category_name=cat_name,
            category_color=cat_color,
            rating=rating_val
        ))
    return results


@router.get("/{review_id}", response_model=BookReviewDetail)
def read_review_detail(review_id: int, db: Session = Depends(get_db)):
    try:
        review = crud.get_review_detail(db, review_id)
        if not review:
            raise HTTPException(status_code=404, detail="Review not found")

        # Безопасное получение данных книги
        if not review.book:
            print(f"ERROR: Review {review_id} has no book associated!")
            raise HTTPException(status_code=500, detail="Data integrity error: Book missing")

        if not review.book.work:
            print(f"ERROR: Book {review.book.id} has no LiteratureWork associated!")
            # Можно вернуть заглушку или ошибку
            work_title = "Unknown Title"
            work_author = "Unknown Author"
        else:
            work_title = review.book.work.title
            work_author = review.book.work.author

        # Собираем жанры из связующей таблицы
        # Проверяем, что review.genres не None
        genres_list = []
        if review.genres:
            for g in review.genres:
                if g.genre:
                    genres_list.append(g.genre)

        return BookReviewDetail(
            review_id=review.id,
            book_id=review.book.id,
            title=work_title,
            author=work_author,
            pages=review.book.pages,
            year=review.book.year,
            description=review.book.description,
            cover_url=review.book.cover_url,
            category_name=review.category.name if review.category else "Без категории",
            rating=review.rating,  # Pydantic сам обработает None
            quotes=review.quotes if review.quotes else [],
            notes=review.notes if review.notes else [],
            genres=genres_list
        )
    except Exception as e:
        # Логируем ошибку в консоль сервера, чтобы видеть причину 500
        logger.error(f"Error fetching review detail {review_id}: {str(e)}", exc_info=True)
        # Пробрасываем ошибку дальше, чтобы фронт получил 500
        raise e

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_review_genres.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_review_genres import UserBookReviewGenre, UserBookReviewGenreCreate
from app.crud import users_book_review_genres as crud

router = APIRouter()

@router.post("/", response_model=UserBookReviewGenre, status_code=201)
def create_review_genre(entry: UserBookReviewGenreCreate, db: Session = Depends(get_db)):
    return crud.create_review_genre(db, entry)

@router.get("/", response_model=List[UserBookReviewGenre])
def read_review_genres(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_review_genres(db, skip=skip, limit=limit)

@router.get("/{entry_id}/", response_model=UserBookReviewGenre)
def read_review_genre(entry_id: int, db: Session = Depends(get_db)):
    entry = crud.get_review_genre(db, entry_id)
    if not entry:
        raise HTTPException(status_code=404, detail="ReviewGenre entry not found")
    return entry


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_challenges.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_challenges import UserChallenge, UserChallengeCreate
from app.crud import users_challenges as crud

router = APIRouter()

@router.post("/", response_model=UserChallenge, status_code=201)
def create_challenge(challenge: UserChallengeCreate, db: Session = Depends(get_db)):
    return crud.create_challenge(db, challenge)

@router.get("/", response_model=List[UserChallenge])
def read_challenges(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_challenges(db, skip=skip, limit=limit)

@router.get("/{challenge_id}/", response_model=UserChallenge)
def read_challenge(challenge_id: int, db: Session = Depends(get_db)):
    challenge = crud.get_challenge(db, challenge_id)
    if not challenge:
        raise HTTPException(status_code=404, detail="Challenge not found")
    return challenge


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_challenge_books_alphabet.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_challenge_books_alphabet import UserChallengeBooksAlphabet, UserChallengeBooksAlphabetCreate
from app.crud import users_challenge_books_alphabet as crud

router = APIRouter()

@router.post("/alphabet", response_model=UserChallengeBooksAlphabet, status_code=201)
def create_alphabet_entry(entry: UserChallengeBooksAlphabetCreate, db: Session = Depends(get_db)):
    return crud.create_alphabet_entry(db, entry)

@router.get("/alphabet", response_model=List[UserChallengeBooksAlphabet])
def read_alphabet_entries(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_alphabet_entries(db, skip=skip, limit=limit)

@router.get("/alphabet/{entry_id}/", response_model=UserChallengeBooksAlphabet)
def read_alphabet_entry(entry_id: int, db: Session = Depends(get_db)):
    entry = crud.get_alphabet_entry(db, entry_id)
    if not entry:
        raise HTTPException(status_code=404, detail="Alphabet entry not found")
    return entry


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_challenge_book_of_year.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_challenge_book_of_year import UserChallengeBookOfYear, UserChallengeBookOfYearCreate
from app.crud import users_challenge_book_of_year as crud

router = APIRouter()

@router.post("/book_of_year", response_model=UserChallengeBookOfYear, status_code=201)
def create_entry(entry: UserChallengeBookOfYearCreate, db: Session = Depends(get_db)):
    return crud.create_entry(db, entry)

@router.get("/book_of_year", response_model=List[UserChallengeBookOfYear])
def read_entries(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_entries(db, skip=skip, limit=limit)

@router.get("/book_of_year/{entry_id}/", response_model=UserChallengeBookOfYear)
def read_entry(entry_id: int, db: Session = Depends(get_db)):
    entry = crud.get_entry(db, entry_id)
    if not entry:
        raise HTTPException(status_code=404, detail="Book of Year entry not found")
    return entry


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_personal_data.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_personal_data import UserPersonalData, UserPersonalDataCreate, UserVerifyEmail
from app.crud import users_personal_data as crud

router = APIRouter()


@router.post("/", response_model=UserPersonalData, status_code=201)
def create_user(user: UserPersonalDataCreate, db: Session = Depends(get_db)):
    db_user = crud.get_user_by_email(db, user.email)
    if db_user:
        # Если пользователь есть, но не подтвержден - можно пересоздать код (опционально)
        # Но пока просто вернем ошибку
        raise HTTPException(status_code=400, detail="Email already registered")
    return crud.create_user(db, user)

@router.post("/verify", status_code=200)
def verify_email(data: UserVerifyEmail, db: Session = Depends(get_db)):
    result = crud.verify_user_email(db, data.email, data.code)

    if result is None:
        raise HTTPException(status_code=404, detail="User not found")

    if result is False:
        raise HTTPException(status_code=400, detail="Invalid verification code")

    return {"message": "Email verified successfully"}

@router.get("/", response_model=List[UserPersonalData])
def read_users(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_users(db, skip=skip, limit=limit)


@router.get("/{user_id}/", response_model=UserPersonalData)
def read_user(user_id: int, db: Session = Depends(get_db)):
    user = crud.get_user_by_id(db, user_id)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_reading_records.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_reading_records import UserReadingRecord, UserReadingRecordCreate
from app.crud import users_reading_records as crud

router = APIRouter()

@router.post("/", response_model=UserReadingRecord, status_code=201)
def create_record(record: UserReadingRecordCreate, db: Session = Depends(get_db)):
    return crud.create_record(db, record)

@router.get("/", response_model=List[UserReadingRecord])
def read_records(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_records(db, skip=skip, limit=limit)

@router.get("/{record_id}/", response_model=UserReadingRecord)
def read_record(record_id: int, db: Session = Depends(get_db)):
    record = crud.get_record(db, record_id)
    if not record:
        raise HTTPException(status_code=404, detail="Record not found")
    return record


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_statistics.py =====

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session, joinedload
from typing import List
from collections import Counter

from app.db.session import get_db
from app.schemas.users_statistics import UserStatistics
from app.models.users_book_review import UserBookReview
from app.models.books_editions import BookEdition
from app.models.literature_works import LiteratureWork
from app.models.users_book_review_genres import UserBookReviewGenre
from app.models.genre import Genre
from app.models.books_categories import BookCategory

router = APIRouter()


@router.get("/user/{user_id}", response_model=UserStatistics)
def read_user_statistics(user_id: int, db: Session = Depends(get_db)):
    # 1. Загружаем все отзывы пользователя вместе с книгами, авторами, категориями и жанрами
    reviews = (
        db.query(UserBookReview)
        .options(
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.book).joinedload(BookEdition.work),
            joinedload(UserBookReview.genres).joinedload(UserBookReviewGenre.genre)
        )
        .filter(UserBookReview.user_id == user_id)
        .all()
    )

    # 2. Инициализируем счетчики
    total_books = 0
    read_count = 0
    favorites_count = 0

    authors_list = []
    genres_list = []

    # 3. Проходимся по всем книгам и считаем
    for review in reviews:
        total_books += 1

        cat_name = review.category.name if review.category else ""

        # Логика подсчета
        if cat_name == "Прочитано":
            read_count += 1
        elif cat_name == "Любимые":
            favorites_count += 1
            # Обычно любимые книги тоже считаются прочитанными
            read_count += 1

            # Собираем автора (если есть)
        if review.book and review.book.work:
            authors_list.append(review.book.work.author)

        # Собираем жанры
        if review.genres:
            for g_link in review.genres:
                if g_link.genre:
                    genres_list.append(g_link.genre.name)

    # 4. Определяем самого популярного автора
    favorite_author = "-"
    if authors_list:
        # Counter создает словарь {автор: кол-во}, most_common(1) берет топ-1
        favorite_author = Counter(authors_list).most_common(1)[0][0]

    # 5. Определяем самый популярный жанр
    favorite_genre = "-"
    if genres_list:
        favorite_genre = Counter(genres_list).most_common(1)[0][0]

    # 6. Возвращаем объект статистики
    # id=0, так как это вычисляемая "на лету" сущность, а не запись из таблицы users_statistics
    return UserStatistics(
        id=0,
        user_id=user_id,
        books_in_library=total_books,
        books_read=read_count,
        books_favorites=favorites_count,
        favorite_author=favorite_author,
        favorite_genre=favorite_genre
    )


# Остальные эндпоинты можно оставить или закомментировать,
# так как фронтенд использует только этот.
@router.post("/", response_model=UserStatistics, status_code=201)
def create_statistics(stats: UserStatistics, db: Session = Depends(get_db)):
    # Заглушка, чтобы не ломать старый код, если он где-то используется
    return stats


@router.get("/", response_model=List[UserStatistics])
def read_statistics(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return []

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_top_characters.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_top_characters import UserTopCharacters, UserTopCharactersCreate
from app.crud import users_top_characters as crud

router = APIRouter()

@router.post("/", response_model=UserTopCharacters, status_code=201)
def create_top_characters(top_chars: UserTopCharactersCreate, db: Session = Depends(get_db)):
    return crud.create_top_characters(db, top_chars)

@router.get("/", response_model=List[UserTopCharacters])
def read_top_characters(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_top_characters(db, skip=skip, limit=limit)

@router.get("/{record_id}/", response_model=UserTopCharacters)
def read_top_characters_by_id(record_id: int, db: Session = Depends(get_db)):
    record = crud.get_top_characters_by_id(db, record_id)
    if not record:
        raise HTTPException(status_code=404, detail="Top characters record not found")
    return record


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_core.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\core\config.py =====

import os
from dotenv import load_dotenv

load_dotenv()

class Settings:
    DATABASE_URL: str = os.getenv("DATABASE_URL") or os.getenv("DATABASE_URL_LOCAL")

settings = Settings()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\core\security.py =====

from datetime import datetime, timedelta
from typing import Optional
from jose import jwt
from passlib.context import CryptContext

# Настройки (в идеале вынести в .env, но для диплома можно так)
SECRET_KEY = "secret_key_for_owlreads_diploma"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)


def get_password_hash(password):
    return pwd_context.hash(password)


def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)

    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\core\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_crud.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\books_categories.py =====

from sqlalchemy.orm import Session
from app.models.books_categories import BookCategory
from app.schemas.books_categories import BookCategoryCreate

def create_category(db: Session, category: BookCategoryCreate):
    db_category = BookCategory(**category.dict())
    db.add(db_category)
    db.commit()
    db.refresh(db_category)
    return db_category

def get_categories(db: Session, skip: int = 0, limit: int = 100):
    return db.query(BookCategory).offset(skip).limit(limit).all()

def get_category_by_name(db: Session, name: str):
    return db.query(BookCategory).filter(BookCategory.name == name).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\literature.py =====

from sqlalchemy.orm import Session
from app.models.literature_works import LiteratureWork
from app.models.books_editions import BookEdition
from app.schemas.literature import LiteratureWorkCreate, BookEditionCreate
from sqlalchemy import or_

# --- LiteratureWork ---
def create_literature_work(db: Session, work: LiteratureWorkCreate):
    db_work = LiteratureWork(**work.dict())
    db.add(db_work)
    db.commit()
    db.refresh(db_work)
    return db_work

def get_literature_work(db: Session, work_id: int):
    return db.query(LiteratureWork).filter(LiteratureWork.id == work_id).first()

def get_literature_works(db: Session, skip: int = 0, limit: int = 100):
    return db.query(LiteratureWork).offset(skip).limit(limit).all()


# --- BookEdition ---
def create_book_edition(db: Session, edition: BookEditionCreate):
    db_edition = BookEdition(**edition.dict())
    db.add(db_edition)
    db.commit()
    db.refresh(db_edition)
    return db_edition

def get_book_edition(db: Session, edition_id: int):
    return db.query(BookEdition).filter(BookEdition.id == edition_id).first()

def get_book_editions(db: Session, skip: int = 0, limit: int = 100):
    return db.query(BookEdition).offset(skip).limit(limit).all()

def search_books(db: Session, query: str, limit: int = 10):
    search_term = f"%{query}%"

    return (
        db.query(BookEdition)
        .join(LiteratureWork)
        .filter(
            or_(
                LiteratureWork.title.ilike(search_term),
                LiteratureWork.author.ilike(search_term)
            )
        )
        .limit(limit)
        .all()
    )

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_notes.py =====

from sqlalchemy.orm import Session
from app.models.users_book_notes import UserBookNote
from app.schemas.users_book_notes import UserBookNoteCreate

def create_note(db: Session, note: UserBookNoteCreate):
    db_note = UserBookNote(**note.dict())
    db.add(db_note)
    db.commit()
    db.refresh(db_note)
    return db_note

def get_notes(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookNote).offset(skip).limit(limit).all()

def get_note(db: Session, note_id: int):
    return db.query(UserBookNote).filter(UserBookNote.id == note_id).first()

def delete_note(db: Session, note_id: int):
    obj = db.query(UserBookNote).filter(UserBookNote.id == note_id).first()
    if obj:
        db.delete(obj)
        db.commit()
        return True
    return False

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_quotes.py =====

from sqlalchemy.orm import Session
from app.models.users_book_quotes import UserBookQuote
from app.schemas.users_book_quotes import UserBookQuoteCreate

def create_quote(db: Session, quote: UserBookQuoteCreate):
    db_quote = UserBookQuote(**quote.dict())
    db.add(db_quote)
    db.commit()
    db.refresh(db_quote)
    return db_quote

def get_quotes(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookQuote).offset(skip).limit(limit).all()

def get_quote(db: Session, quote_id: int):
    return db.query(UserBookQuote).filter(UserBookQuote.id == quote_id).first()

def delete_quote(db: Session, quote_id: int):
    obj = db.query(UserBookQuote).filter(UserBookQuote.id == quote_id).first()
    if obj:
        db.delete(obj)
        db.commit()
        return True
    return False

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_rating.py =====

# app/crud/users_book_rating.py
from sqlalchemy.orm import Session
from app.models.users_book_rating import UserBookRating
from app.schemas.users_book_rating import UserBookRatingCreate


def create_rating(db: Session, rating: UserBookRatingCreate):
    # Ищем, есть ли уже рейтинг у этого отзыва
    existing_rating = db.query(UserBookRating).filter(UserBookRating.review_id == rating.review_id).first()

    if existing_rating:
        # ОБНОВЛЕНИЕ: Если нашли, меняем поля
        rating_data = rating.dict(exclude_unset=True)
        for key, value in rating_data.items():
            setattr(existing_rating, key, value)

        db.commit()
        db.refresh(existing_rating)
        return existing_rating
    else:
        # СОЗДАНИЕ: Если не нашли, создаем новый
        db_rating = UserBookRating(**rating.dict())
        db.add(db_rating)
        db.commit()
        db.refresh(db_rating)
        return db_rating


def get_ratings(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookRating).offset(skip).limit(limit).all()


def get_rating(db: Session, rating_id: int):
    return db.query(UserBookRating).filter(UserBookRating.id == rating_id).first()

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_review.py =====

# app/crud/users_book_review.py
from sqlalchemy.orm import Session
from sqlalchemy.orm import joinedload
from app.models.users_book_review import UserBookReview
from app.schemas.users_book_review import UserBookReviewCreate
from app.models.literature_works import LiteratureWork
from app.models.books_editions import BookEdition
from app.models.books_categories import BookCategory
from app.schemas.custom_book import BookManualCreate
from app.models.genre import Genre
from app.models.users_book_review_genres import UserBookReviewGenre

def create_review(db: Session, review: UserBookReviewCreate) -> UserBookReview:
    db_review = UserBookReview(**review.dict())
    db.add(db_review)
    db.commit()
    db.refresh(db_review)
    return db_review

def get_reviews(db: Session, skip: int = 0, limit: int = 100):
    return (
        db.query(UserBookReview)
        .options(
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.rating),
            joinedload(UserBookReview.user),
            joinedload(UserBookReview.quotes),
            joinedload(UserBookReview.notes)
            # Добавь joinedload для всех полей, которые нужны в ответе
        )
        .offset(skip)
        .limit(limit)
        .all()
    )
def get_review_by_id(db: Session, review_id: int):
    return db.query(UserBookReview).filter(UserBookReview.id == review_id).first()

def get_user_reviews_by_category_name(db: Session, user_id: int, category_name: str):
    return (
        db.query(UserBookReview)
        .join(UserBookReview.category)
        .filter(UserBookReview.user_id == user_id)
        .filter(UserBookReview.category.has(name=category_name))
        .all()
    )

def delete_review(db: Session, review_id: int) -> bool:
    obj = db.query(UserBookReview).filter(UserBookReview.id == review_id).first()
    if not obj:
        return False
    db.delete(obj)
    db.commit()
    return True

def get_user_library(db: Session, user_id: int, skip: int = 0, limit: int = 100):
    return (
        db.query(UserBookReview)
        .options(
            # Теперь Python знает, что такое BookEdition
            joinedload(UserBookReview.book).joinedload(BookEdition.work),
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.rating)
        )
        .filter(UserBookReview.user_id == user_id)
        .offset(skip)
        .limit(limit)
        .all()
    )

def create_manual_book_review(db: Session, user_id: int, data: BookManualCreate):
    # 1. Ищем категорию (она должна существовать)
    category = db.query(BookCategory).filter(BookCategory.name == data.category_name).first()
    if not category:
        # Если категории нет, можно либо вернуть ошибку, либо создать дефолтную.
        # Для надежности вернем None, фронт должен слать правильные названия.
        return None

    # 2. Создаем Литературное произведение
    # (В будущем здесь можно добавить проверку: если такое название+автор есть, не создавать дубль)
    new_work = LiteratureWork(
        title=data.title,
        author=data.author
    )
    db.add(new_work)
    db.flush()  # flush позволяет получить id созданного объекта до commit

    # 3. Создаем Издание книги
    new_edition = BookEdition(
        literature_work_id=new_work.id,
        pages=data.pages,
        year=data.year,
        language=data.language,
        description=data.description,
        cover_url=data.cover_url
    )
    db.add(new_edition)
    db.flush()

    # 4. Создаем Отзыв пользователя (связь)
    new_review = UserBookReview(
        user_id=user_id,
        book_id=new_edition.id,
        category_id=category.id
    )
    db.add(new_review)

    db.commit()
    db.refresh(new_review)

    return new_review

def get_review_detail(db: Session, review_id: int):
    return (
        db.query(UserBookReview)
        .options(
            joinedload(UserBookReview.book).joinedload(BookEdition.work),
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.rating),
            joinedload(UserBookReview.quotes),
            joinedload(UserBookReview.notes),
            joinedload(UserBookReview.genres).joinedload(UserBookReviewGenre.genre)
        )
        .filter(UserBookReview.id == review_id)
        .first()
    )


def update_review_category(db: Session, review_id: int, category_name: str):
    # 1. Ищем сам отзыв
    review = db.query(UserBookReview).filter(UserBookReview.id == review_id).first()
    if not review:
        return None

    # 2. Ищем ID категории по названию (например "Читаю" -> id=2)
    category = db.query(BookCategory).filter(BookCategory.name == category_name).first()
    if not category:
        # Если такой категории нет в базе, ничего не делаем (или можно вернуть ошибку)
        return None

    # 3. Обновляем
    review.category_id = category.id
    db.commit()
    db.refresh(review)
    return review


def update_review_genres(db: Session, review_id: int, genre_names: list[str]):
    # 1. Удаляем ВСЕ текущие жанры у этого отзыва
    db.query(UserBookReviewGenre).filter(UserBookReviewGenre.review_id == review_id).delete()

    # 2. Если список пустой, просто сохраняем удаление
    if not genre_names:
        db.commit()
        return []

    # 3. Ищем ID жанров по их названиям
    # (SELECT * FROM genres WHERE name IN (...))
    genres = db.query(Genre).filter(Genre.name.in_(genre_names)).all()

    # 4. Создаем новые связи
    new_entries = []
    for genre in genres:
        entry = UserBookReviewGenre(review_id=review_id, genre_id=genre.id)
        db.add(entry)
        new_entries.append(entry)

    db.commit()

    # Возвращаем список объектов жанров (для удобства, если нужно)
    return genres

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_review_genres.py =====

from sqlalchemy.orm import Session
from app.models.users_book_review_genres import UserBookReviewGenre
from app.schemas.users_book_review_genres import UserBookReviewGenreCreate

def create_review_genre(db: Session, entry: UserBookReviewGenreCreate):
    db_entry = UserBookReviewGenre(**entry.dict())
    db.add(db_entry)
    db.commit()
    db.refresh(db_entry)
    return db_entry

def get_review_genres(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookReviewGenre).offset(skip).limit(limit).all()

def get_review_genre(db: Session, entry_id: int):
    return db.query(UserBookReviewGenre).filter(UserBookReviewGenre.id == entry_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_challenges.py =====

from sqlalchemy.orm import Session
from app.models.users_challenges import UserChallenge
from app.schemas.users_challenges import UserChallengeCreate

def create_challenge(db: Session, challenge: UserChallengeCreate):
    db_challenge = UserChallenge(**challenge.dict())
    db.add(db_challenge)
    db.commit()
    db.refresh(db_challenge)
    return db_challenge

def get_challenges(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserChallenge).offset(skip).limit(limit).all()

def get_challenge(db: Session, challenge_id: int):
    return db.query(UserChallenge).filter(UserChallenge.id == challenge_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_challenge_books_alphabet.py =====

from sqlalchemy.orm import Session
from app.models.users_challenge_books_alphabet import UserChallengeBooksAlphabet
from app.schemas.users_challenge_books_alphabet import UserChallengeBooksAlphabetCreate

def create_alphabet_entry(db: Session, entry: UserChallengeBooksAlphabetCreate):
    db_entry = UserChallengeBooksAlphabet(**entry.dict())
    db.add(db_entry)
    db.commit()
    db.refresh(db_entry)
    return db_entry

def get_alphabet_entries(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserChallengeBooksAlphabet).offset(skip).limit(limit).all()

def get_alphabet_entry(db: Session, entry_id: int):
    return db.query(UserChallengeBooksAlphabet).filter(UserChallengeBooksAlphabet.id == entry_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_challenge_book_of_year.py =====

from sqlalchemy.orm import Session
from app.models.users_challenge_book_of_year import UserChallengeBookOfYear
from app.schemas.users_challenge_book_of_year import UserChallengeBookOfYearCreate

def create_entry(db: Session, entry: UserChallengeBookOfYearCreate):
    db_entry = UserChallengeBookOfYear(**entry.dict())
    db.add(db_entry)
    db.commit()
    db.refresh(db_entry)
    return db_entry

def get_entries(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserChallengeBookOfYear).offset(skip).limit(limit).all()

def get_entry(db: Session, entry_id: int):
    return db.query(UserChallengeBookOfYear).filter(UserChallengeBookOfYear.id == entry_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_personal_data.py =====

from sqlalchemy.orm import Session
from app.models.users_personal_data import UserPersonalData
from app.schemas.users_personal_data import UserPersonalDataCreate
from passlib.context import CryptContext
from app.utils.email import generate_verification_code, send_verification_email

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def create_user(db: Session, user: UserPersonalDataCreate):
    hashed_password = pwd_context.hash(user.password_hash)

    code = generate_verification_code()

    db_user = UserPersonalData(
        username=user.username,
        email=user.email,
        password_hash=hashed_password,
        agreement_accepted=user.agreement_accepted,
        profile_photo=user.profile_photo,
        verification_code=code,
        is_verified=False
    )

    db.add(db_user)
    db.commit()
    db.refresh(db_user)

    send_verification_email(user.email, code)

    return db_user

def verify_user_email(db: Session, email: str, code: str):
    user = get_user_by_email(db, email)
    if not user:
        return None

    if user.verification_code == code:
        user.is_verified = True
        user.verification_code = None
        db.commit()
        db.refresh(user)
        return user

    return False

def get_users(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserPersonalData).offset(skip).limit(limit).all()


def get_user_by_id(db: Session, user_id: int):
    return db.query(UserPersonalData).filter(UserPersonalData.id == user_id).first()


def get_user_by_email(db: Session, email: str):
    return db.query(UserPersonalData).filter(UserPersonalData.email == email).first()

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_reading_records.py =====

from sqlalchemy.orm import Session
from app.models.users_reading_records import UserReadingRecord
from app.schemas.users_reading_records import UserReadingRecordCreate

def create_record(db: Session, record: UserReadingRecordCreate):
    db_record = UserReadingRecord(**record.dict())
    db.add(db_record)
    db.commit()
    db.refresh(db_record)
    return db_record

def get_records(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserReadingRecord).offset(skip).limit(limit).all()

def get_record(db: Session, record_id: int):
    return db.query(UserReadingRecord).filter(UserReadingRecord.id == record_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_statistics.py =====

from sqlalchemy.orm import Session
from app.models.users_statistics import UserStatistics
from app.schemas.users_statistics import UserStatisticsCreate

def create_statistics(db: Session, stats: UserStatisticsCreate):
    db_stats = UserStatistics(**stats.dict())
    db.add(db_stats)
    db.commit()
    db.refresh(db_stats)
    return db_stats

def get_statistics(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserStatistics).offset(skip).limit(limit).all()

def get_statistics_by_id(db: Session, stats_id: int):
    return db.query(UserStatistics).filter(UserStatistics.id == stats_id).first()

def get_statistics_by_user_id(db: Session, user_id: int):
    return db.query(UserStatistics).filter(UserStatistics.user_id == user_id).first()

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_top_characters.py =====

from sqlalchemy.orm import Session
from app.models.users_top_characters import UserTopCharacters
from app.schemas.users_top_characters import UserTopCharactersCreate

def create_top_characters(db: Session, top_chars: UserTopCharactersCreate):
    db_top_chars = UserTopCharacters(**top_chars.dict())
    db.add(db_top_chars)
    db.commit()
    db.refresh(db_top_chars)
    return db_top_chars

def get_top_characters(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserTopCharacters).offset(skip).limit(limit).all()

def get_top_characters_by_id(db: Session, record_id: int):
    return db.query(UserTopCharacters).filter(UserTopCharacters.id == record_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_db.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\db\base.py =====

from sqlalchemy.orm import declarative_base

Base = declarative_base()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\db\session.py =====

from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

from app.core.config import settings

engine = create_engine(settings.DATABASE_URL, pool_pre_ping=True)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\db\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_models.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\books_categories.py =====

from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import relationship
from app.db.base import Base

class BookCategory(Base):
    __tablename__ = "books_categories"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), unique=True, nullable=False)
    color = Column(String(7), nullable=False, server_default="#AB66FF")

    reviews = relationship("UserBookReview", back_populates="category")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\books_editions.py =====

from sqlalchemy import Column, Integer, String, ForeignKey, Text
from sqlalchemy.orm import relationship
from app.db.base import Base

class BookEdition(Base):
    __tablename__ = "books_editions"

    id = Column(Integer, primary_key=True, index=True)
    literature_work_id = Column(Integer, ForeignKey("literature_works.id"), nullable=False)

    original_year = Column(Integer, nullable=True)
    description = Column(Text, nullable=True)
    publisher = Column(String(255), nullable=True)
    year = Column(Integer, nullable=True)
    pages = Column(Integer, nullable=True)
    cover_url = Column(String(500), nullable=True)
    isbn = Column(String(20), unique=True, nullable=True)
    language = Column(String(50), nullable=True)

    # связь с произведением
    work = relationship("LiteratureWork", back_populates="editions")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\genre.py =====

from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import relationship
from app.db.base import Base

class Genre(Base):
    __tablename__ = "genres"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), unique=True, nullable=False)
    color = Column(String(7), nullable=False, server_default="#AB66FF")

    reviews = relationship("UserBookReviewGenre", back_populates="genre")




===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\literature_works.py =====

from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import relationship
from app.db.base import Base

class LiteratureWork(Base):
    __tablename__ = "literature_works"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(255), nullable=False)
    author = Column(String(255), nullable=False)

    # связь с изданиями
    editions = relationship("BookEdition", back_populates="work", cascade="all, delete-orphan")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\popular_quotes.py =====

from sqlalchemy import Column, Integer, String, Text
from app.db.base import Base

class PopularQuote(Base):
    __tablename__ = "popular_quotes"

    id = Column(Integer, primary_key=True, index=True)
    text = Column(Text, nullable=False)
    book_title = Column(String(255), nullable=False)


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_notes.py =====

from sqlalchemy import Column, Integer, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserBookNote(Base):
    __tablename__ = "users_book_notes"

    id = Column(Integer, primary_key=True, index=True)
    text = Column(Text, nullable=False)

    # связь с users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    date = Column(DateTime, default=datetime.utcnow)

    review = relationship("UserBookReview", back_populates="notes")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_quotes.py =====

from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserBookQuote(Base):
    __tablename__ = "users_book_quotes"

    id = Column(Integer, primary_key=True, index=True)
    text = Column(Text, nullable=False)
    quote_author = Column(String(255), nullable=True)

    # связь с users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    date = Column(DateTime, default=datetime.utcnow)


    review = relationship("UserBookReview", back_populates="quotes")




===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_rating.py =====

from sqlalchemy import Column, Integer, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserBookRating(Base):
    __tablename__ = "users_book_rating"

    id = Column(Integer, primary_key=True, index=True)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), unique=True, nullable=False)

    total_rating = Column(Integer, nullable=False)
    characters_rating = Column(Integer, nullable=True)
    plot_rating = Column(Integer, nullable=True)
    relations_rating = Column(Integer, nullable=True)
    emotionality_rating = Column(Integer, nullable=True)
    ending_rating = Column(Integer, nullable=True)
    easy_reading_rating = Column(Integer, nullable=True)

    review = relationship("UserBookReview", back_populates="rating")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_review.py =====

from sqlalchemy import Column, Integer, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base


class UserBookReview(Base):
    __tablename__ = "users_book_review"

    id = Column(Integer, primary_key=True, index=True)

    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)
    book_id = Column(Integer, ForeignKey("books_editions.id"), nullable=False)
    category_id = Column(Integer, ForeignKey("books_categories.id"), nullable=False)

    # --- СВЯЗИ ---
    user = relationship("UserPersonalData", back_populates="book_reviews")
    category = relationship("BookCategory", back_populates="reviews")

    # !!! ВОТ ЭТОЙ СТРОКИ НЕ ХВАТАЛО !!!
    book = relationship("BookEdition")

    # многие ко многим через join-таблицу
    genres = relationship("UserBookReviewGenre", back_populates="review", cascade="all, delete-orphan")

    # один к одному
    rating = relationship("UserBookRating", back_populates="review", uselist=False, cascade="all, delete-orphan")
    top_characters = relationship("UserTopCharacters", back_populates="review", uselist=False,
                                  cascade="all, delete-orphan")

    # один ко многим
    quotes = relationship("UserBookQuote", back_populates="review", cascade="all, delete-orphan")
    notes = relationship("UserBookNote", back_populates="review", cascade="all, delete-orphan")
    reading_records = relationship("UserReadingRecord", back_populates="review", cascade="all, delete-orphan")
    alphabet_challenges = relationship("UserChallengeBooksAlphabet", back_populates="review",
                                       cascade="all, delete-orphan")
    book_of_year_challenges = relationship("UserChallengeBookOfYear", back_populates="review",
                                           cascade="all, delete-orphan")

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_review_genres.py =====

from sqlalchemy import Column, Integer, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserBookReviewGenre(Base):
    __tablename__ = "users_book_review_genres"

    id = Column(Integer, primary_key=True, index=True)
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)
    genre_id = Column(Integer, ForeignKey("genres.id"), nullable=False)

    review = relationship("UserBookReview", back_populates="genres")
    genre = relationship("Genre", back_populates="reviews")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_challenges.py =====

from sqlalchemy import Column, Integer, String, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserChallenge(Base):
    __tablename__ = "users_challenges"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    challenge_type = Column(String(50), nullable=False)
    started_at = Column(DateTime, default=datetime.utcnow)
    finished_at = Column(DateTime, nullable=True)
    status = Column(String(50), default="В процессе")

    user = relationship("UserPersonalData", back_populates="challenges")
    alphabet_entries = relationship("UserChallengeBooksAlphabet", back_populates="challenge")
    book_of_year_entries = relationship("UserChallengeBookOfYear", back_populates="challenge")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_challenge_books_alphabet.py =====

from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserChallengeBooksAlphabet(Base):
    __tablename__ = "users_challenge_books_alphabet"

    id = Column(Integer, primary_key=True, index=True)
    challenge_id = Column(Integer, ForeignKey("users_challenges.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    letter = Column(String(1), nullable=False)

    challenge = relationship("UserChallenge", back_populates="alphabet_entries")
    user = relationship("UserPersonalData", back_populates="alphabet_challenges")
    review = relationship("UserBookReview", back_populates="alphabet_challenges")




===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_challenge_book_of_year.py =====

from sqlalchemy import Column, Integer, String, Boolean, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserChallengeBookOfYear(Base):
    __tablename__ = "users_challenge_book_of_year"

    id = Column(Integer, primary_key=True, index=True)

    # связь с users_challenges
    challenge_id = Column(Integer, ForeignKey("users_challenges.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    month = Column(Integer, nullable=True)   # месяц (1–12)
    stage = Column(String(50), nullable=False)  # этап: month/pair/group/final
    is_winner = Column(Boolean, default=False)

    challenge = relationship("UserChallenge", back_populates="book_of_year_entries")
    user = relationship("UserPersonalData", back_populates="book_of_year_challenges")
    review = relationship("UserBookReview", back_populates="book_of_year_challenges")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_personal_data.py =====

from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserPersonalData(Base):
    __tablename__ = "users_personal_data"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(255), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)

    agreement_accepted = Column(Boolean, default=False)
    registered_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    profile_photo = Column(String(255), nullable=True)

    # --- НОВЫЕ ПОЛЯ ---
    verification_code = Column(String(6), nullable=True)
    is_verified = Column(Boolean, default=False)
    # ------------------

    # обратные связи
    statistics = relationship("UserStatistics", back_populates="user", uselist=False)
    challenges = relationship("UserChallenge", back_populates="user")
    alphabet_challenges = relationship("UserChallengeBooksAlphabet", back_populates="user")
    book_of_year_challenges = relationship("UserChallengeBookOfYear", back_populates="user")
    book_reviews = relationship("UserBookReview", back_populates="user")

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_reading_records.py =====

from sqlalchemy import Column, Integer, String, Text, Date, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserReadingRecord(Base):
    __tablename__ = "users_reading_records"

    id = Column(Integer, primary_key=True, index=True)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    start_date = Column(Date, nullable=True)   # дата начала (может быть пустой)
    end_date = Column(Date, nullable=True)     # дата конца (может быть пустой)

    result = Column(String(50), nullable=False)  # Брошено / Завершено / В процессе
    comment = Column(Text, nullable=True)

    review = relationship("UserBookReview", back_populates="reading_records")

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_statistics.py =====

from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserStatistics(Base):
    __tablename__ = "users_statistics"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    books_in_library = Column(Integer, default=0)
    books_read = Column(Integer, default=0)
    books_favorites = Column(Integer, default=0)
    favorite_author = Column(String(255), nullable=True)
    favorite_genre = Column(String(100), nullable=True)

    user = relationship("UserPersonalData", back_populates="statistics")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_top_characters.py =====

from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserTopCharacters(Base):
    __tablename__ = "users_top_characters"

    id = Column(Integer, primary_key=True, index=True)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), unique=True, nullable=False)

    top_1 = Column(String(255), nullable=True)
    top_2 = Column(String(255), nullable=True)
    top_3 = Column(String(255), nullable=True)
    top_4 = Column(String(255), nullable=True)
    top_5 = Column(String(255), nullable=True)

    review = relationship("UserBookReview", back_populates="top_characters")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\__init__.py =====

from .popular_quotes import PopularQuote
from .genre import Genre
from .books_editions import BookEdition
from .literature_works import LiteratureWork
from .users_book_notes import UserBookNote
from .users_book_quotes import UserBookQuote
from .users_reading_records import UserReadingRecord
from .users_book_rating import UserBookRating
from .users_top_characters import UserTopCharacters
from .users_challenge_books_alphabet import UserChallengeBooksAlphabet
from .users_challenge_book_of_year import UserChallengeBookOfYear
from .users_challenges import UserChallenge
from .users_statistics import UserStatistics
from .users_personal_data import UserPersonalData
from .users_book_review_genres import UserBookReviewGenre
from .books_categories import BookCategory
from .users_book_review import UserBookReview

__all__ = ["PopularQuote",
           "Genre",
           "BookEdition",
           "LiteratureWork",
           "UserBookNote",
           "UserBookQuote",
           "UserReadingRecord",
           "UserBookRating",
           "UserTopCharacters",
           "UserChallengeBooksAlphabet",
           "UserChallengeBookOfYear",
           "UserChallenge",
           "UserStatistics",
           "UserPersonalData",
           "UserBookReviewGenre",
           "BookCategory",
           "UserBookReview"]


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_schemas.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\books_categories.py =====

from pydantic import BaseModel

class BookCategoryBase(BaseModel):
    name: str
    color: str

class BookCategoryCreate(BookCategoryBase):
    pass

class BookCategory(BookCategoryBase):
    id: int
    color: str

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\custom_book.py =====

from pydantic import BaseModel
from typing import Optional

class BookManualCreate(BaseModel):
    title: str
    author: str
    pages: Optional[int] = None
    year: Optional[int] = None
    language: Optional[str] = None
    description: Optional[str] = None
    cover_url: Optional[str] = None
    category_name: str  # Например: "Читаю", "Прочитано"

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\genre.py =====

# app/schemas/genre.py
from pydantic import BaseModel

class GenreBase(BaseModel):
    name: str
    color: str

class GenreCreate(GenreBase):
    pass

class GenreRead(GenreBase):
    id: int
    color: str

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\literature.py =====

from pydantic import BaseModel
from typing import Optional, List

# --- LiteratureWork ---
class LiteratureWorkBase(BaseModel):
    title: str
    author: str

class LiteratureWorkCreate(LiteratureWorkBase):
    pass

class LiteratureWork(LiteratureWorkBase):
    id: int

    class Config:
        from_attributes = True


# --- BookEdition ---
class BookEditionBase(BaseModel):
    original_year: Optional[int] = None
    description: Optional[str] = None
    publisher: Optional[str] = None
    year: Optional[int] = None
    pages: Optional[int] = None
    cover_url: Optional[str] = None
    isbn: Optional[str] = None
    language: Optional[str] = None

class BookEditionCreate(BookEditionBase):
    literature_work_id: int

class BookEdition(BookEditionBase):
    id: int
    literature_work_id: int

    class Config:
        from_attributes = True

class BookSearchResponse(BaseModel):
    id: int
    title: str
    author: str
    cover_url: Optional[str] = None
    year: Optional[int] = None

    # Поле, чтобы фронт понимал, что это книга из нашей БД
    source: str = "local"

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\popular_quotes.py =====

# app/schemas/popular_quotes.py
from pydantic import BaseModel

class PopularQuoteBase(BaseModel):
    text: str
    book_title: str

class PopularQuoteCreate(PopularQuoteBase):
    pass

class PopularQuote(PopularQuoteBase):
    id: int

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_notes.py =====

from pydantic import BaseModel
from datetime import datetime
from typing import Optional

class UserBookNoteBase(BaseModel):
    text: str

class UserBookNoteCreate(UserBookNoteBase):
    review_id: int

class UserBookNote(UserBookNoteBase):
    id: int
    review_id: int
    date: Optional[datetime] = None

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_quotes.py =====

from pydantic import BaseModel
from datetime import datetime
from typing import Optional

class UserBookQuoteBase(BaseModel):
    text: str
    quote_author: Optional[str] = None

class UserBookQuoteCreate(UserBookQuoteBase):
    review_id: int

class UserBookQuote(UserBookQuoteBase):
    id: int
    review_id: int  # И здесь полезно
    date: Optional[datetime] = None

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_rating.py =====

from pydantic import BaseModel

class UserBookRatingBase(BaseModel):
    total_rating: int
    characters_rating: int | None = None
    plot_rating: int | None = None
    relations_rating: int | None = None
    emotionality_rating: int | None = None
    ending_rating: int | None = None
    easy_reading_rating: int | None = None

class UserBookRatingCreate(UserBookRatingBase):
    review_id: int

class UserBookRating(UserBookRatingBase):
    id: int
    review_id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_review.py =====

from typing import List, Optional
from pydantic import BaseModel

# Импортируем другие схемы (обратите внимание на точки перед названиями файлов)
from .books_categories import BookCategory
from .users_book_rating import UserBookRating
from .users_book_quotes import UserBookQuote
from .users_book_notes import UserBookNote
from .genre import GenreRead

class UserBookReviewBase(BaseModel):
    user_id: int
    book_id: int
    category_id: int

class UserBookReviewCreate(UserBookReviewBase):
    pass

class UserBookReview(UserBookReviewBase):
    id: int
    category: BookCategory
    rating: Optional[UserBookRating] = None
    quotes: List[UserBookQuote] = []
    notes: List[UserBookNote] = []

    class Config:
        from_attributes = True

class LibraryBookRead(BaseModel):
    review_id: int
    book_id: int
    title: str
    author: str
    cover_url: Optional[str] = None
    category_name: str
    category_color: str = "#AB66FF"
    rating: int = 0

    class Config:
        from_attributes = True

class BookReviewDetail(BaseModel):
    review_id: int
    book_id: int

    # Данные книги
    title: str
    author: str
    pages: Optional[int] = None
    year: Optional[int] = None
    description: Optional[str] = None
    cover_url: Optional[str] = None

    # Данные отзыва
    category_name: str

    # Вложенные данные
    rating: Optional[UserBookRating] = None
    quotes: List[UserBookQuote] = []
    notes: List[UserBookNote] = []
    genres: List[GenreRead] = []

    class Config:
        from_attributes = True

class UserBookReviewUpdateCategory(BaseModel):
    category_name: str

class UserBookReviewUpdateGenres(BaseModel):
    genres: List[str]  # Список названий, например ["Фэнтези", "Роман"]

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_review_genres.py =====

from pydantic import BaseModel

class UserBookReviewGenreBase(BaseModel):
    review_id: int
    genre_id: int

class UserBookReviewGenreCreate(UserBookReviewGenreBase):
    pass

class UserBookReviewGenre(UserBookReviewGenreBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_challenges.py =====

from pydantic import BaseModel
from datetime import datetime

class UserChallengeBase(BaseModel):
    challenge_type: str
    started_at: datetime | None = None
    finished_at: datetime | None = None
    status: str = "В процессе"

class UserChallengeCreate(UserChallengeBase):
    pass

class UserChallenge(UserChallengeBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_challenge_books_alphabet.py =====

from pydantic import BaseModel

class UserChallengeBooksAlphabetBase(BaseModel):
    letter: str

class UserChallengeBooksAlphabetCreate(UserChallengeBooksAlphabetBase):
    pass

class UserChallengeBooksAlphabet(UserChallengeBooksAlphabetBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_challenge_book_of_year.py =====

from pydantic import BaseModel

class UserChallengeBookOfYearBase(BaseModel):
    month: int | None = None
    stage: str
    is_winner: bool = False

class UserChallengeBookOfYearCreate(UserChallengeBookOfYearBase):
    pass

class UserChallengeBookOfYear(UserChallengeBookOfYearBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_personal_data.py =====

from pydantic import BaseModel, EmailStr
from datetime import datetime

class UserPersonalDataBase(BaseModel):
    username: str
    email: EmailStr
    password_hash: str
    agreement_accepted: bool = False
    profile_photo: str | None = None

class UserPersonalDataCreate(UserPersonalDataBase):
    pass

class UserVerifyEmail(BaseModel):
    email: EmailStr
    code: str

class UserPersonalData(UserPersonalDataBase):
    id: int
    registered_at: datetime
    updated_at: datetime
    is_verified: bool

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_reading_records.py =====

from pydantic import BaseModel
from datetime import date

class UserReadingRecordBase(BaseModel):
    start_date: date | None = None
    end_date: date | None = None
    result: str
    comment: str | None = None

class UserReadingRecordCreate(UserReadingRecordBase):
    pass

class UserReadingRecord(UserReadingRecordBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_statistics.py =====

from pydantic import BaseModel

class UserStatisticsBase(BaseModel):
    books_in_library: int = 0
    books_read: int = 0
    books_favorites: int = 0
    favorite_author: str | None = None
    favorite_genre: str | None = None

class UserStatisticsCreate(UserStatisticsBase):
    pass

class UserStatistics(UserStatisticsBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_top_characters.py =====

from pydantic import BaseModel

class UserTopCharactersBase(BaseModel):
    top_1: str | None = None
    top_2: str | None = None
    top_3: str | None = None
    top_4: str | None = None
    top_5: str | None = None

class UserTopCharactersCreate(UserTopCharactersBase):
    pass

class UserTopCharacters(UserTopCharactersBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_utils.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\utils\email.py =====

import smtplib
import os
from email.message import EmailMessage
import random
import string
from dotenv import load_dotenv

load_dotenv()


def generate_verification_code(length=6):
    return ''.join(random.choices(string.digits, k=length))


def send_verification_email(to_email: str, code: str):

    SMTP_SERVER = "smtp.gmail.com"
    SMTP_PORT = 465

    SMTP_USER = os.getenv("SMTP_USER")
    SMTP_PASSWORD = os.getenv("SMTP_PASSWORD")

    if not SMTP_USER or not SMTP_PASSWORD:
        print("ОШИБКА: Не настроены SMTP_USER или SMTP_PASSWORD в .env файле!")
        print(f"Код для {to_email} был бы: {code}")  # Выводим в консоль для тестов
        return False

    msg = EmailMessage()
    msg.set_content(f"Добро пожаловать в OwlReads!\n\nВаш код подтверждения: {code}\n\nНикому не сообщайте этот код.")
    msg['Subject'] = "Код подтверждения OwlReads"
    msg['From'] = SMTP_USER
    msg['To'] = to_email

    try:
        with smtplib.SMTP_SSL(SMTP_SERVER, SMTP_PORT) as server:
            server.login(SMTP_USER, SMTP_PASSWORD)
            server.send_message(msg)
        print(f"Письмо успешно отправлено на {to_email}")
        return True
    except Exception as e:
        print(f"Ошибка отправки письма: {e}")
        return False

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\utils\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\project_dump_parts.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\alembic.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\env.py =====

import os
import sys
from logging.config import fileConfig

from sqlalchemy import engine_from_config, pool
from alembic import context

# Добавляем корень проекта в sys.path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Загружаем .env (если используете)
from dotenv import load_dotenv
load_dotenv(os.path.join(os.path.dirname(__file__), '..', '.env'))

# Конфигурация Alembic
config = context.config

# Если в .env есть DATABASE_URL, подставляем его в конфиг alembic
db_url = os.getenv("DATABASE_URL") or os.getenv("DATABASE_URL_LOCAL")
if db_url:
    config.set_main_option("sqlalchemy.url", db_url)

# Логирование
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Импортируем Base и модели, чтобы метаданные были зарегистрированы
from app.db.base import Base
import app.models.popular_quotes
import app.models.genre
import app.models.books_editions
import app.models.literature_works
import app.models.users_book_notes
import app.models.users_book_quotes
import app.models.users_reading_records
import app.models.users_book_rating
import app.models.users_top_characters
import app.models.users_challenge_books_alphabet
import app.models.users_challenge_book_of_year
import app.models.users_challenges
import app.models.users_statistics
import app.models.users_personal_data
import app.models.users_book_review_genres
import app.models.books_categories
import app.models.users_book_review

target_metadata = Base.metadata

def run_migrations_online():
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )
    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)
        with context.begin_transaction():
            context.run_migrations()

if context.is_offline_mode():
    context.configure(url=config.get_main_option("sqlalchemy.url"), target_metadata=target_metadata)
    with context.begin_transaction():
        context.run_migrations()
else:
    run_migrations_online()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\alembic_versions.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\17d062ffd73f_add_language_to_books_editions.py =====

"""add language to books_editions

Revision ID: 17d062ffd73f
Revises: f67d12b7990d
Create Date: 2025-11-29 21:48:52.214101

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '17d062ffd73f'
down_revision: Union[str, Sequence[str], None] = 'f67d12b7990d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('books_editions', sa.Column('language', sa.String(length=50), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('books_editions', 'language')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\22a7d740fe08_create_users_top_characters.py =====

"""create users_top_characters

Revision ID: 22a7d740fe08
Revises: bd8b55d6e45d
Create Date: 2025-11-29 23:49:10.208795

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '22a7d740fe08'
down_revision: Union[str, Sequence[str], None] = 'bd8b55d6e45d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_top_characters',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('top_1', sa.String(length=255), nullable=True),
    sa.Column('top_2', sa.String(length=255), nullable=True),
    sa.Column('top_3', sa.String(length=255), nullable=True),
    sa.Column('top_4', sa.String(length=255), nullable=True),
    sa.Column('top_5', sa.String(length=255), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_top_characters_id'), 'users_top_characters', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_top_characters_id'), table_name='users_top_characters')
    op.drop_table('users_top_characters')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\2fd3813264e1_add_relations_with_users_personal_data.py =====

"""add relations with users_personal_data

Revision ID: 2fd3813264e1
Revises: 908f851b98ac
Create Date: 2025-11-30 20:38:29.599006

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '2fd3813264e1'
down_revision: Union[str, Sequence[str], None] = '908f851b98ac'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users_challenge_book_of_year', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_book_of_year', 'users_personal_data', ['user_id'], ['id'])
    op.add_column('users_challenge_books_alphabet', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_books_alphabet', 'users_personal_data', ['user_id'], ['id'])
    op.add_column('users_challenges', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenges', 'users_personal_data', ['user_id'], ['id'])
    op.add_column('users_statistics', sa.Column('user_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_statistics', 'users_personal_data', ['user_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'users_statistics', type_='foreignkey')
    op.drop_column('users_statistics', 'user_id')
    op.drop_constraint(None, 'users_challenges', type_='foreignkey')
    op.drop_column('users_challenges', 'user_id')
    op.drop_constraint(None, 'users_challenge_books_alphabet', type_='foreignkey')
    op.drop_column('users_challenge_books_alphabet', 'user_id')
    op.drop_constraint(None, 'users_challenge_book_of_year', type_='foreignkey')
    op.drop_column('users_challenge_book_of_year', 'user_id')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\316574416a9d_create_genres_table.py =====

"""create genres table

Revision ID: 316574416a9d
Revises: f8f32195f7ff
Create Date: 2025-11-29 20:21:30.042282

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '316574416a9d'
down_revision: Union[str, Sequence[str], None] = 'f8f32195f7ff'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    op.create_table(
        'genres',
        sa.Column('id', sa.Integer(), primary_key=True, nullable=False),
        sa.Column('name', sa.String(length=200), nullable=False),
    )
    op.create_unique_constraint('uq_genres_name', 'genres', ['name'])

    genres = [
        "Young adult",
        "Античная литература",
        "Белорусская литература",
        "Биография, мемуары",
        "Бизнес-книги",
        "Боевик",
        "Детектив",
        "Детская литература",
        "Журнал, газета, статья",
        "Зарубежная литература",
        "Здоровье, медицина",
        "Историческая литература",
        "Комедия",
        "Комикс, манга, манхва, вебтун",
        "Культура, искусство",
        "Мифы, легенды, эпос",
        "На иностранном языке",
        "Научно-популярная литература",
        "Научная фантастика",
        "Нон-фикшн",
        "Приключения",
        "Психология",
        "Пьеса",
        "Религия",
        "Роман",
        "Русская классика",
        "Стихи, поэзия",
        "Техническая литература",
        "Триллер",
        "Ужасы, мистика",
        "Учебная литература",
        "Фантастика",
        "Философия",
        "Фэнтези",
        "Энциклопедия, справочник",
        "18+"
    ]
    for g in genres:
        op.execute(
            sa.text("INSERT INTO genres (name) VALUES (:name) ON CONFLICT (name) DO NOTHING")
            .bindparams(name=g)
        )

def downgrade() -> None:
    op.drop_table('genres')


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\33202f8c22ce_add_users_book_review_and_related_tables.py =====

"""add users_book_review and related tables

Revision ID: 33202f8c22ce
Revises: 2fd3813264e1
Create Date: 2025-11-30 22:43:41.622983

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '33202f8c22ce'
down_revision: Union[str, Sequence[str], None] = '2fd3813264e1'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('books_categories',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_index(op.f('ix_books_categories_id'), 'books_categories', ['id'], unique=False)
    op.create_table('users_book_review',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('book_id', sa.Integer(), nullable=False),
    sa.Column('category_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['book_id'], ['books_editions.id'], ),
    sa.ForeignKeyConstraint(['category_id'], ['books_categories.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users_personal_data.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_review_id'), 'users_book_review', ['id'], unique=False)
    op.create_table('users_book_review_genres',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('review_id', sa.Integer(), nullable=False),
    sa.Column('genre_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['genre_id'], ['genres.id'], ),
    sa.ForeignKeyConstraint(['review_id'], ['users_book_review.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_review_genres_id'), 'users_book_review_genres', ['id'], unique=False)
    op.add_column('users_book_notes', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_book_notes', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_book_quotes', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_book_quotes', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_book_rating', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_unique_constraint(None, 'users_book_rating', ['review_id'])
    op.create_foreign_key(None, 'users_book_rating', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_challenge_book_of_year', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_book_of_year', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_challenge_books_alphabet', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_books_alphabet', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_reading_records', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_reading_records', 'users_book_review', ['review_id'], ['id'])
    op.add_column('users_top_characters', sa.Column('review_id', sa.Integer(), nullable=False))
    op.create_unique_constraint(None, 'users_top_characters', ['review_id'])
    op.create_foreign_key(None, 'users_top_characters', 'users_book_review', ['review_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'users_top_characters', type_='foreignkey')
    op.drop_constraint(None, 'users_top_characters', type_='unique')
    op.drop_column('users_top_characters', 'review_id')
    op.drop_constraint(None, 'users_reading_records', type_='foreignkey')
    op.drop_column('users_reading_records', 'review_id')
    op.drop_constraint(None, 'users_challenge_books_alphabet', type_='foreignkey')
    op.drop_column('users_challenge_books_alphabet', 'review_id')
    op.drop_constraint(None, 'users_challenge_book_of_year', type_='foreignkey')
    op.drop_column('users_challenge_book_of_year', 'review_id')
    op.drop_constraint(None, 'users_book_rating', type_='foreignkey')
    op.drop_constraint(None, 'users_book_rating', type_='unique')
    op.drop_column('users_book_rating', 'review_id')
    op.drop_constraint(None, 'users_book_quotes', type_='foreignkey')
    op.drop_column('users_book_quotes', 'review_id')
    op.drop_constraint(None, 'users_book_notes', type_='foreignkey')
    op.drop_column('users_book_notes', 'review_id')
    op.drop_index(op.f('ix_users_book_review_genres_id'), table_name='users_book_review_genres')
    op.drop_table('users_book_review_genres')
    op.drop_index(op.f('ix_users_book_review_id'), table_name='users_book_review')
    op.drop_table('users_book_review')
    op.drop_index(op.f('ix_books_categories_id'), table_name='books_categories')
    op.drop_table('books_categories')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\725b1d704ec7_create_users_book_notes.py =====

"""create users_book_notes

Revision ID: 725b1d704ec7
Revises: 17d062ffd73f
Create Date: 2025-11-29 22:46:22.336812

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '725b1d704ec7'
down_revision: Union[str, Sequence[str], None] = '17d062ffd73f'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_book_notes',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('text', sa.Text(), nullable=False),
    sa.Column('date', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_notes_id'), 'users_book_notes', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_book_notes_id'), table_name='users_book_notes')
    op.drop_table('users_book_notes')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\758366379bad_create_users_reading_records.py =====

"""create users_reading_records

Revision ID: 758366379bad
Revises: ecb9ff41ebcb
Create Date: 2025-11-29 23:27:16.076853

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '758366379bad'
down_revision: Union[str, Sequence[str], None] = 'ecb9ff41ebcb'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_reading_records',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('start_date', sa.Date(), nullable=True),
    sa.Column('end_date', sa.Date(), nullable=True),
    sa.Column('result', sa.String(length=50), nullable=False),
    sa.Column('comment', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_reading_records_id'), 'users_reading_records', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_reading_records_id'), table_name='users_reading_records')
    op.drop_table('users_reading_records')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\7588e4eda91c_create_users_challenge_books_alphabet.py =====

"""create users_challenge_books_alphabet

Revision ID: 7588e4eda91c
Revises: 22a7d740fe08
Create Date: 2025-11-30 19:47:08.556049

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '7588e4eda91c'
down_revision: Union[str, Sequence[str], None] = '22a7d740fe08'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_challenge_books_alphabet',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('letter', sa.String(length=1), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_challenge_books_alphabet_id'), 'users_challenge_books_alphabet', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_challenge_books_alphabet_id'), table_name='users_challenge_books_alphabet')
    op.drop_table('users_challenge_books_alphabet')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\7fe66b3c43c0_add_colors_to_genres_and_categories.py =====

"""add_colors_to_genres_and_categories

Revision ID: 7fe66b3c43c0
Revises: de8061a41eee
Create Date: 2026-02-02 11:47:58.917023

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '7fe66b3c43c0'
down_revision: Union[str, Sequence[str], None] = 'de8061a41eee'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('books_categories', sa.Column('color', sa.String(length=7), server_default='#AB66FF', nullable=False))
    op.add_column('genres', sa.Column('color', sa.String(length=7), server_default='#AB66FF', nullable=False))

    op.execute("UPDATE books_categories SET color = '#E0C217' WHERE name = 'Хочу прочитать'")
    op.execute("UPDATE books_categories SET color = '#46AC16' WHERE name = 'Читаю'")
    op.execute("UPDATE books_categories SET color = '#1AB7E3' WHERE name = 'Брошено'")
    op.execute("UPDATE books_categories SET color = '#EE619E' WHERE name = 'Любимые'")
    op.execute("UPDATE books_categories SET color = '#AB66FF' WHERE name = 'Прочитано'")

    op.execute("UPDATE genres SET color = '#FFA2C4' WHERE name = 'Young adult'")
    op.execute("UPDATE genres SET color = '#D4B483' WHERE name = 'Античная литература'")
    op.execute("UPDATE genres SET color = '#069947' WHERE name = 'Белорусская литература'")
    op.execute("UPDATE genres SET color = '#8F4C19' WHERE name = 'Биография, мемуары'")
    op.execute("UPDATE genres SET color = '#0A66C2' WHERE name = 'Бизнес-книги'")
    op.execute("UPDATE genres SET color = '#C62828' WHERE name = 'Боевик'")
    op.execute("UPDATE genres SET color = '#FF8800' WHERE name = 'Детектив'")
    op.execute("UPDATE genres SET color = '#FFDA61' WHERE name = 'Детская литература'")
    op.execute("UPDATE genres SET color = '#416692' WHERE name = 'Журнал, газета, статья'")
    op.execute("UPDATE genres SET color = '#89E835' WHERE name = 'Зарубежная литература'")
    op.execute("UPDATE genres SET color = '#4ABCA1' WHERE name = 'Здоровье, медицина'")
    op.execute("UPDATE genres SET color = '#816E5A' WHERE name = 'Историческая литература'")
    op.execute("UPDATE genres SET color = '#FFB400' WHERE name = 'Комедия'")
    op.execute("UPDATE genres SET color = '#FF9F7C' WHERE name = 'Комикс, манга, манхва, вебтун'")
    op.execute("UPDATE genres SET color = '#B015EF' WHERE name = 'Культура, искусство'")
    op.execute("UPDATE genres SET color = '#7F48CD' WHERE name = 'Мифы, легенды, эпос'")
    op.execute("UPDATE genres SET color = '#008369' WHERE name = 'На иностранном языке'")
    op.execute("UPDATE genres SET color = '#00D9FF' WHERE name = 'Научно-популярная литература'")
    op.execute("UPDATE genres SET color = '#90CBFE' WHERE name = 'Научная фантастика'")
    op.execute("UPDATE genres SET color = '#96B463' WHERE name = 'Нон-фикшн'")
    op.execute("UPDATE genres SET color = '#FF3D00' WHERE name = 'Приключения'")
    op.execute("UPDATE genres SET color = '#7361FF' WHERE name = 'Психология'")
    op.execute("UPDATE genres SET color = '#89EAC8' WHERE name = 'Пьеса'")
    op.execute("UPDATE genres SET color = '#4604A2' WHERE name = 'Религия'")
    op.execute("UPDATE genres SET color = '#FF6565' WHERE name = 'Роман'")
    op.execute("UPDATE genres SET color = '#BEAA12' WHERE name = 'Русская классика'")
    op.execute("UPDATE genres SET color = '#FF2CF1' WHERE name = 'Стихи, поэзия'")
    op.execute("UPDATE genres SET color = '#8E8E8E' WHERE name = 'Техническая литература'")
    op.execute("UPDATE genres SET color = '#222222' WHERE name = 'Триллер'")
    op.execute("UPDATE genres SET color = '#680000' WHERE name = 'Ужасы, мистика'")
    op.execute("UPDATE genres SET color = '#DD96D8' WHERE name = 'Учебная литература'")
    op.execute("UPDATE genres SET color = '#000FB2' WHERE name = 'Фантастика'")
    op.execute("UPDATE genres SET color = '#B68AEB' WHERE name = 'Философия'")
    op.execute("UPDATE genres SET color = '#57B168' WHERE name = 'Фэнтези'")
    op.execute("UPDATE genres SET color = '#145816' WHERE name = 'Энциклопедия, справочник'")
    op.execute("UPDATE genres SET color = '#FF0037' WHERE name = '18+'")

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('genres', 'color')
    op.drop_column('books_categories', 'color')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\908f851b98ac_create_users_personal_data.py =====

"""create users_personal_data

Revision ID: 908f851b98ac
Revises: da48215a7e8f
Create Date: 2025-11-30 20:29:01.713327

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '908f851b98ac'
down_revision: Union[str, Sequence[str], None] = 'da48215a7e8f'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_personal_data',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('username', sa.String(length=50), nullable=False),
    sa.Column('email', sa.String(length=255), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=False),
    sa.Column('agreement_accepted', sa.Boolean(), nullable=True),
    sa.Column('registered_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('profile_photo', sa.String(length=255), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email'),
    sa.UniqueConstraint('username')
    )
    op.create_index(op.f('ix_users_personal_data_id'), 'users_personal_data', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_personal_data_id'), table_name='users_personal_data')
    op.drop_table('users_personal_data')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\bb018fe2ae50_create_users_challenge_book_of_year.py =====

"""create users_challenge_book_of_year

Revision ID: bb018fe2ae50
Revises: 7588e4eda91c
Create Date: 2025-11-30 19:56:55.401962

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'bb018fe2ae50'
down_revision: Union[str, Sequence[str], None] = '7588e4eda91c'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_challenge_book_of_year',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('month', sa.Integer(), nullable=True),
    sa.Column('stage', sa.String(length=50), nullable=False),
    sa.Column('is_winner', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_challenge_book_of_year_id'), 'users_challenge_book_of_year', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_challenge_book_of_year_id'), table_name='users_challenge_book_of_year')
    op.drop_table('users_challenge_book_of_year')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\bd8b55d6e45d_create_users_book_rating.py =====

"""create users_book_rating

Revision ID: bd8b55d6e45d
Revises: 758366379bad
Create Date: 2025-11-29 23:41:46.150237

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'bd8b55d6e45d'
down_revision: Union[str, Sequence[str], None] = '758366379bad'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_book_rating',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('total_rating', sa.Integer(), nullable=False),
    sa.Column('characters_rating', sa.Integer(), nullable=True),
    sa.Column('plot_rating', sa.Integer(), nullable=True),
    sa.Column('relations_rating', sa.Integer(), nullable=True),
    sa.Column('emotionality_rating', sa.Integer(), nullable=True),
    sa.Column('ending_rating', sa.Integer(), nullable=True),
    sa.Column('easy_reading_rating', sa.Integer(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_rating_id'), 'users_book_rating', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_book_rating_id'), table_name='users_book_rating')
    op.drop_table('users_book_rating')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\da48215a7e8f_create_users_statistics.py =====

"""create users_statistics

Revision ID: da48215a7e8f
Revises: ddfa1f232766
Create Date: 2025-11-30 20:20:49.550020

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'da48215a7e8f'
down_revision: Union[str, Sequence[str], None] = 'ddfa1f232766'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_statistics',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('books_in_library', sa.Integer(), nullable=True),
    sa.Column('books_read', sa.Integer(), nullable=True),
    sa.Column('books_favorites', sa.Integer(), nullable=True),
    sa.Column('favorite_author', sa.String(length=255), nullable=True),
    sa.Column('favorite_genre', sa.String(length=100), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_statistics_id'), 'users_statistics', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_statistics_id'), table_name='users_statistics')
    op.drop_table('users_statistics')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\ddfa1f232766_add_fk_from_challenges_to_alphabet_and_.py =====

"""add FK from challenges to alphabet and book_of_year

Revision ID: ddfa1f232766
Revises: e44138ccdf6a
Create Date: 2025-11-30 20:08:41.767755

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'ddfa1f232766'
down_revision: Union[str, Sequence[str], None] = 'e44138ccdf6a'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users_challenge_book_of_year', sa.Column('challenge_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_book_of_year', 'users_challenges', ['challenge_id'], ['id'])
    op.add_column('users_challenge_books_alphabet', sa.Column('challenge_id', sa.Integer(), nullable=False))
    op.create_foreign_key(None, 'users_challenge_books_alphabet', 'users_challenges', ['challenge_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'users_challenge_books_alphabet', type_='foreignkey')
    op.drop_column('users_challenge_books_alphabet', 'challenge_id')
    op.drop_constraint(None, 'users_challenge_book_of_year', type_='foreignkey')
    op.drop_column('users_challenge_book_of_year', 'challenge_id')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\de8061a41eee_add_verification_fields.py =====

"""add verification fields

Revision ID: de8061a41eee
Revises: 33202f8c22ce
Create Date: 2025-12-15 01:17:33.290890

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'de8061a41eee'
down_revision: Union[str, Sequence[str], None] = '33202f8c22ce'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users_personal_data', sa.Column('verification_code', sa.String(length=6), nullable=True))
    op.add_column('users_personal_data', sa.Column('is_verified', sa.Boolean(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users_personal_data', 'is_verified')
    op.drop_column('users_personal_data', 'verification_code')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\e44138ccdf6a_create_users_challenges.py =====

"""create users_challenges

Revision ID: e44138ccdf6a
Revises: bb018fe2ae50
Create Date: 2025-11-30 20:02:13.612813

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'e44138ccdf6a'
down_revision: Union[str, Sequence[str], None] = 'bb018fe2ae50'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_challenges',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('challenge_type', sa.String(length=50), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('finished_at', sa.DateTime(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_challenges_id'), 'users_challenges', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_challenges_id'), table_name='users_challenges')
    op.drop_table('users_challenges')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\ecb9ff41ebcb_create_users_book_quotes.py =====

"""create users_book_quotes

Revision ID: ecb9ff41ebcb
Revises: 725b1d704ec7
Create Date: 2025-11-29 23:10:13.421630

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'ecb9ff41ebcb'
down_revision: Union[str, Sequence[str], None] = '725b1d704ec7'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users_book_quotes',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('text', sa.Text(), nullable=False),
    sa.Column('quote_author', sa.String(length=255), nullable=True),
    sa.Column('date', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_book_quotes_id'), 'users_book_quotes', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_book_quotes_id'), table_name='users_book_quotes')
    op.drop_table('users_book_quotes')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\f67d12b7990d_create_literature_works_and_books_.py =====

"""create literature_works and books_editions

Revision ID: f67d12b7990d
Revises: 316574416a9d
Create Date: 2025-11-29 21:45:44.102699

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'f67d12b7990d'
down_revision: Union[str, Sequence[str], None] = '316574416a9d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('literature_works',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('author', sa.String(length=255), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_literature_works_id'), 'literature_works', ['id'], unique=False)
    op.create_table('books_editions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('literature_work_id', sa.Integer(), nullable=False),
    sa.Column('original_year', sa.Integer(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('publisher', sa.String(length=255), nullable=True),
    sa.Column('year', sa.Integer(), nullable=True),
    sa.Column('pages', sa.Integer(), nullable=True),
    sa.Column('cover_url', sa.String(length=500), nullable=True),
    sa.Column('isbn', sa.String(length=20), nullable=True),
    sa.ForeignKeyConstraint(['literature_work_id'], ['literature_works.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('isbn')
    )
    op.create_index(op.f('ix_books_editions_id'), 'books_editions', ['id'], unique=False)
    op.create_index(op.f('ix_genres_id'), 'genres', ['id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_genres_id'), table_name='genres')
    op.drop_index(op.f('ix_books_editions_id'), table_name='books_editions')
    op.drop_table('books_editions')
    op.drop_index(op.f('ix_literature_works_id'), table_name='literature_works')
    op.drop_table('literature_works')
    # ### end Alembic commands ###


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\alembic\versions\f8f32195f7ff_create_popular_quotes_table.py =====

from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision: str = 'f8f32195f7ff'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    op.create_table(
        'popular_quotes',
        sa.Column('id', sa.Integer(), primary_key=True, nullable=False),
        sa.Column('text', sa.Text(), nullable=False),
        sa.Column('book_title', sa.String(length=255), nullable=False),
    )


def downgrade() -> None:
    op.drop_table('popular_quotes')


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\main.py =====

# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.api import (
    popular_quotes,
    genre,
    literature,
    users_book_notes,
    users_book_quotes,
    users_reading_records,
    users_book_rating,
    users_top_characters,
    users_challenge_books_alphabet,
    users_challenge_book_of_year,
    users_challenges,
    users_statistics,
    users_personal_data,
    users_book_review_genres,
    books_categories,
    users_book_review,
    auth,
)

app = FastAPI(title="OwlReads API")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Единообразие: каждый сегмент — ровно один раз
app.include_router(popular_quotes.router, prefix="/api/quotes", tags=["quotes"])
app.include_router(genre.router,             prefix="/api/genres", tags=["genres"])
app.include_router(literature.router,        prefix="/api/literature", tags=["literature"])

app.include_router(users_book_notes.router,          prefix="/api/users_book_notes", tags=["users_book_notes"])
app.include_router(users_book_quotes.router,         prefix="/api/users_book_quotes", tags=["users_book_quotes"])
app.include_router(users_reading_records.router,     prefix="/api/users_reading_records", tags=["users_reading_records"])
app.include_router(users_book_rating.router,         prefix="/api/users_book_rating", tags=["users_book_rating"])
app.include_router(users_top_characters.router,      prefix="/api/users_top_characters", tags=["users_top_characters"])
app.include_router(users_challenge_books_alphabet.router, prefix="/api/users_challenge_books_alphabet", tags=["users_challenge_books_alphabet"])
app.include_router(users_challenge_book_of_year.router,   prefix="/api/users_challenge_book_of_year", tags=["users_challenge_book_of_year"])
app.include_router(users_challenges.router,          prefix="/api/users_challenges", tags=["users_challenges"])
app.include_router(users_statistics.router,          prefix="/api/users_statistics", tags=["users_statistics"])
app.include_router(users_personal_data.router,       prefix="/api/users_personal_data", tags=["users_personal_data"])
app.include_router(users_book_review_genres.router,  prefix="/api/users_book_review_genres", tags=["users_book_review_genres"])
app.include_router(books_categories.router,          prefix="/api/books_categories", tags=["books_categories"])
app.include_router(users_book_review.router,         prefix="/api/users_book_review", tags=["users_book_review"])

app.include_router(auth.router, prefix="/api/auth", tags=["auth"])

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_api.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\auth.py =====

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from pydantic import BaseModel, EmailStr

from app.db.session import get_db
from app.crud import users_personal_data as crud
from app.core.security import verify_password, create_access_token

router = APIRouter()

class LoginSchema(BaseModel):
    email: EmailStr
    password: str


@router.post("/login")
def login(login_data: LoginSchema, db: Session = Depends(get_db)):
    # 1. Ищем пользователя по email
    user = crud.get_user_by_email(db, email=login_data.email)

    # 2. Если пользователя нет ИЛИ пароль не подходит
    if not user or not verify_password(login_data.password, user.password_hash):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Неверный email или пароль",
            headers={"WWW-Authenticate": "Bearer"},
        )

    # 3. Если всё ок, создаем токен
    access_token = create_access_token(data={"sub": str(user.id)})

    return {
        "access_token": access_token,
        "token_type": "bearer",
        "user_id": user.id,
        "username": user.username
    }

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\books_categories.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.books_categories import BookCategory, BookCategoryCreate
from app.crud import books_categories as crud

router = APIRouter()

@router.post("/", response_model=BookCategory, status_code=201)
def create_category(category: BookCategoryCreate, db: Session = Depends(get_db)):
    db_category = crud.get_category_by_name(db, category.name)
    if db_category:
        raise HTTPException(status_code=400, detail="Category already exists")
    return crud.create_category(db, category)

@router.get("/", response_model=List[BookCategory])
def read_categories(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_categories(db, skip=skip, limit=limit)


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\genre.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import get_db   # <-- теперь импортируем отсюда
from app.models.genre import Genre as GenreModel
from app.schemas.genre import GenreRead

router = APIRouter()

@router.get("/", response_model=list[GenreRead])
def list_genres(db: Session = Depends(get_db)):
    return db.query(GenreModel).order_by(GenreModel.id).all()

@router.get("/{genre_id}/", response_model=GenreRead)
def get_genre(genre_id: int, db: Session = Depends(get_db)):
    genre = db.query(GenreModel).get(genre_id)
    if not genre:
        raise HTTPException(status_code=404, detail="Genre not found")
    return genre


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\literature.py =====

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from typing import List
from app.schemas.literature import LiteratureWork, LiteratureWorkCreate, BookEdition, BookEditionCreate
from app.crud import literature as crud
from app.db.session import get_db
from app.schemas.literature import BookSearchResponse

router = APIRouter()

# --- LiteratureWork ---
@router.post("/works", response_model=LiteratureWork)
def create_work(work: LiteratureWorkCreate, db: Session = Depends(get_db)):
    return crud.create_literature_work(db, work)

@router.get("/works", response_model=List[LiteratureWork])
def read_works(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_literature_works(db, skip=skip, limit=limit)

@router.get("/works/{work_id}", response_model=LiteratureWork)
def read_work(work_id: int, db: Session = Depends(get_db)):
    return crud.get_literature_work(db, work_id)


# --- BookEdition ---
@router.post("/editions", response_model=BookEdition)
def create_edition(edition: BookEditionCreate, db: Session = Depends(get_db)):
    return crud.create_book_edition(db, edition)

@router.get("/editions", response_model=List[BookEdition])
def read_editions(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_book_editions(db, skip=skip, limit=limit)

@router.get("/editions/{edition_id}", response_model=BookEdition)
def read_edition(edition_id: int, db: Session = Depends(get_db)):
    return crud.get_book_edition(db, edition_id)

@router.get("/search", response_model=List[BookSearchResponse])
def search_books_endpoint(q: str, db: Session = Depends(get_db)):
    if not q:
        return []

    books = crud.search_books(db, query=q)

    # Преобразуем ORM модели в Pydantic схему вручную или автоматически
    results = []
    for book in books:
        results.append(BookSearchResponse(
            id=book.id,
            title=book.work.title,  # Берем название из связанной таблицы
            author=book.work.author,  # Берем автора из связанной таблицы
            cover_url=book.cover_url,
            year=book.year,
            source="local"
        ))
    return results

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\popular_quotes.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy.sql.expression import func  # <--- Импортируем func для SQL функций

from app.db.session import get_db
from app.models.popular_quotes import PopularQuote as PopularQuoteModel
from app.schemas.popular_quotes import PopularQuoteCreate, PopularQuote as PopularQuoteSchema

router = APIRouter()


@router.post("/", response_model=PopularQuoteSchema, status_code=201)
def create_quote(quote: PopularQuoteCreate, db: Session = Depends(get_db)):
    db_quote = PopularQuoteModel(**quote.dict())
    db.add(db_quote)
    db.commit()
    db.refresh(db_quote)
    return db_quote


@router.get("/", response_model=list[PopularQuoteSchema])
def get_quotes(db: Session = Depends(get_db)):
    return db.query(PopularQuoteModel).all()


@router.get("/{quote_id}/", response_model=PopularQuoteSchema)
def get_quote(quote_id: int, db: Session = Depends(get_db)):
    quote = db.query(PopularQuoteModel).get(quote_id)
    if not quote:
        raise HTTPException(status_code=404, detail="Quote not found")
    return quote

@router.get("/random", response_model=PopularQuoteSchema)
def get_random_quote(db: Session = Depends(get_db)):
    quote = db.query(PopularQuoteModel).order_by(func.random()).first()

    if not quote:
        raise HTTPException(status_code=404, detail="No quotes found in database")

    return quote

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_notes.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_notes import UserBookNote, UserBookNoteCreate
from app.crud import users_book_notes as crud

router = APIRouter()

@router.post("/", response_model=UserBookNote, status_code=201)
def create_note(note: UserBookNoteCreate, db: Session = Depends(get_db)):
    return crud.create_note(db, note)

@router.get("/", response_model=List[UserBookNote])
def read_notes(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_notes(db, skip=skip, limit=limit)

@router.get("/{note_id}/", response_model=UserBookNote)
def read_note(note_id: int, db: Session = Depends(get_db)):
    note = crud.get_note(db, note_id)
    if not note:
        raise HTTPException(status_code=404, detail="Note not found")
    return note

@router.delete("/{note_id}/", status_code=204)
def delete_note(note_id: int, db: Session = Depends(get_db)):
    success = crud.delete_note(db, note_id)
    if not success:
        raise HTTPException(status_code=404, detail="Note not found")
    return None

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_quotes.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_quotes import UserBookQuote, UserBookQuoteCreate
from app.crud import users_book_quotes as crud

router = APIRouter()

@router.post("/", response_model=UserBookQuote, status_code=201)
def create_quote(quote: UserBookQuoteCreate, db: Session = Depends(get_db)):
    return crud.create_quote(db, quote)

@router.get("/", response_model=List[UserBookQuote])
def read_quotes(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_quotes(db, skip=skip, limit=limit)

@router.get("/{quote_id}/", response_model=UserBookQuote)
def read_quote(quote_id: int, db: Session = Depends(get_db)):
    quote = crud.get_quote(db, quote_id)
    if not quote:
        raise HTTPException(status_code=404, detail="Quote not found")
    return quote

@router.delete("/{quote_id}/", status_code=204)
def delete_quote(quote_id: int, db: Session = Depends(get_db)):
    success = crud.delete_quote(db, quote_id)
    if not success:
        raise HTTPException(status_code=404, detail="Quote not found")
    return None

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_rating.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_rating import UserBookRating, UserBookRatingCreate
from app.crud import users_book_rating as crud

router = APIRouter()

@router.post("/", response_model=UserBookRating, status_code=201)
def create_rating(rating: UserBookRatingCreate, db: Session = Depends(get_db)):
    return crud.create_rating(db, rating)

@router.get("/", response_model=List[UserBookRating])
def read_ratings(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_ratings(db, skip=skip, limit=limit)

@router.get("/{rating_id}/", response_model=UserBookRating)
def read_rating(rating_id: int, db: Session = Depends(get_db)):
    rating = crud.get_rating(db, rating_id)
    if not rating:
        raise HTTPException(status_code=404, detail="Rating not found")
    return rating


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_review.py =====

# app/api/users_book_review.py
import logging
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_review import UserBookReview, UserBookReviewCreate, LibraryBookRead, BookReviewDetail, UserBookReviewUpdateCategory, UserBookReviewUpdateGenres
from app.crud import users_book_review as crud
from app.schemas.custom_book import BookManualCreate

# Настройка логгера для отладки ошибок 500
logger = logging.getLogger(__name__)

router = APIRouter()


@router.post("/reviews", response_model=UserBookReview, status_code=201)
def create_review(review: UserBookReviewCreate, db: Session = Depends(get_db)):
    return crud.create_review(db, review)


@router.get("/reviews", response_model=List[UserBookReview])
def read_reviews(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_reviews(db, skip=skip, limit=limit)


@router.get("/reviews/{review_id}/", response_model=UserBookReview)
def read_review(review_id: int, db: Session = Depends(get_db)):
    review = crud.get_review_by_id(db, review_id)
    if not review:
        raise HTTPException(status_code=404, detail="Review not found")
    return review


@router.get("/users/{user_id}/reviews/by_category", response_model=List[UserBookReview])
def read_user_reviews_by_category(
        user_id: int,
        category_name: str = Query(..., description="Название категории, например: Прочитано"),
        db: Session = Depends(get_db),
):
    results = crud.get_user_reviews_by_category_name(db, user_id, category_name)
    return results

@router.patch("/reviews/{review_id}/category", response_model=UserBookReview)
def update_category(
    review_id: int,
    update_data: UserBookReviewUpdateCategory,
    db: Session = Depends(get_db)
):
    review = crud.update_review_category(db, review_id, update_data.category_name)
    if not review:
        raise HTTPException(status_code=404, detail="Review or Category not found")
    return review

@router.put("/reviews/{review_id}/genres")
def update_genres(
    review_id: int,
    update_data: UserBookReviewUpdateGenres,
    db: Session = Depends(get_db)
):
    crud.update_review_genres(db, review_id, update_data.genres)
    return {"message": "Genres updated successfully"}

@router.delete("/reviews/{review_id}/", status_code=204)
def delete_review(review_id: int, db: Session = Depends(get_db)):
    ok = crud.delete_review(db, review_id)
    if not ok:
        raise HTTPException(status_code=404, detail="Review not found")
    return None


@router.post("/manual", status_code=201)
def add_book_manually(
        book_data: BookManualCreate,
        user_id: int = Query(..., description="ID пользователя"),
        db: Session = Depends(get_db)
):
    review = crud.create_manual_book_review(db, user_id, book_data)
    if not review:
        raise HTTPException(status_code=400, detail="Category not found or error creating book")

    return {"message": "Book added successfully", "review_id": review.id}


@router.get("/library/{user_id}", response_model=List[LibraryBookRead])
def read_user_library(user_id: int, skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    reviews = crud.get_user_library(db, user_id, skip, limit)

    results = []
    for review in reviews:
        # Защита от ошибок, если вдруг данных нет
        book_title = review.book.work.title if review.book and review.book.work else "Без названия"
        book_author = review.book.work.author if review.book and review.book.work else "Неизвестный автор"
        cover = review.book.cover_url if review.book else None
        cat_name = review.category.name if review.category else "Без категории"
        cat_color = review.category.color if review.category else "#AB66FF"
        rating_val = review.rating.total_rating if review.rating else 0

        results.append(LibraryBookRead(
            review_id=review.id,
            book_id=review.book_id,
            title=book_title,
            author=book_author,
            cover_url=cover,
            category_name=cat_name,
            category_color=cat_color,
            rating=rating_val
        ))
    return results


@router.get("/{review_id}", response_model=BookReviewDetail)
def read_review_detail(review_id: int, db: Session = Depends(get_db)):
    try:
        review = crud.get_review_detail(db, review_id)
        if not review:
            raise HTTPException(status_code=404, detail="Review not found")

        # Безопасное получение данных книги
        if not review.book:
            print(f"ERROR: Review {review_id} has no book associated!")
            raise HTTPException(status_code=500, detail="Data integrity error: Book missing")

        if not review.book.work:
            print(f"ERROR: Book {review.book.id} has no LiteratureWork associated!")
            # Можно вернуть заглушку или ошибку
            work_title = "Unknown Title"
            work_author = "Unknown Author"
        else:
            work_title = review.book.work.title
            work_author = review.book.work.author

        # Собираем жанры из связующей таблицы
        # Проверяем, что review.genres не None
        genres_list = []
        if review.genres:
            for g in review.genres:
                if g.genre:
                    genres_list.append(g.genre)

        return BookReviewDetail(
            review_id=review.id,
            book_id=review.book.id,
            title=work_title,
            author=work_author,
            pages=review.book.pages,
            year=review.book.year,
            description=review.book.description,
            cover_url=review.book.cover_url,
            category_name=review.category.name if review.category else "Без категории",
            rating=review.rating,  # Pydantic сам обработает None
            quotes=review.quotes if review.quotes else [],
            notes=review.notes if review.notes else [],
            genres=genres_list
        )
    except Exception as e:
        # Логируем ошибку в консоль сервера, чтобы видеть причину 500
        logger.error(f"Error fetching review detail {review_id}: {str(e)}", exc_info=True)
        # Пробрасываем ошибку дальше, чтобы фронт получил 500
        raise e

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_book_review_genres.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_book_review_genres import UserBookReviewGenre, UserBookReviewGenreCreate
from app.crud import users_book_review_genres as crud

router = APIRouter()

@router.post("/", response_model=UserBookReviewGenre, status_code=201)
def create_review_genre(entry: UserBookReviewGenreCreate, db: Session = Depends(get_db)):
    return crud.create_review_genre(db, entry)

@router.get("/", response_model=List[UserBookReviewGenre])
def read_review_genres(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_review_genres(db, skip=skip, limit=limit)

@router.get("/{entry_id}/", response_model=UserBookReviewGenre)
def read_review_genre(entry_id: int, db: Session = Depends(get_db)):
    entry = crud.get_review_genre(db, entry_id)
    if not entry:
        raise HTTPException(status_code=404, detail="ReviewGenre entry not found")
    return entry


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_challenges.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_challenges import UserChallenge, UserChallengeCreate
from app.crud import users_challenges as crud

router = APIRouter()

@router.post("/", response_model=UserChallenge, status_code=201)
def create_challenge(challenge: UserChallengeCreate, db: Session = Depends(get_db)):
    return crud.create_challenge(db, challenge)

@router.get("/", response_model=List[UserChallenge])
def read_challenges(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_challenges(db, skip=skip, limit=limit)

@router.get("/{challenge_id}/", response_model=UserChallenge)
def read_challenge(challenge_id: int, db: Session = Depends(get_db)):
    challenge = crud.get_challenge(db, challenge_id)
    if not challenge:
        raise HTTPException(status_code=404, detail="Challenge not found")
    return challenge


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_challenge_books_alphabet.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_challenge_books_alphabet import UserChallengeBooksAlphabet, UserChallengeBooksAlphabetCreate
from app.crud import users_challenge_books_alphabet as crud

router = APIRouter()

@router.post("/alphabet", response_model=UserChallengeBooksAlphabet, status_code=201)
def create_alphabet_entry(entry: UserChallengeBooksAlphabetCreate, db: Session = Depends(get_db)):
    return crud.create_alphabet_entry(db, entry)

@router.get("/alphabet", response_model=List[UserChallengeBooksAlphabet])
def read_alphabet_entries(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_alphabet_entries(db, skip=skip, limit=limit)

@router.get("/alphabet/{entry_id}/", response_model=UserChallengeBooksAlphabet)
def read_alphabet_entry(entry_id: int, db: Session = Depends(get_db)):
    entry = crud.get_alphabet_entry(db, entry_id)
    if not entry:
        raise HTTPException(status_code=404, detail="Alphabet entry not found")
    return entry


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_challenge_book_of_year.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_challenge_book_of_year import UserChallengeBookOfYear, UserChallengeBookOfYearCreate
from app.crud import users_challenge_book_of_year as crud

router = APIRouter()

@router.post("/book_of_year", response_model=UserChallengeBookOfYear, status_code=201)
def create_entry(entry: UserChallengeBookOfYearCreate, db: Session = Depends(get_db)):
    return crud.create_entry(db, entry)

@router.get("/book_of_year", response_model=List[UserChallengeBookOfYear])
def read_entries(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_entries(db, skip=skip, limit=limit)

@router.get("/book_of_year/{entry_id}/", response_model=UserChallengeBookOfYear)
def read_entry(entry_id: int, db: Session = Depends(get_db)):
    entry = crud.get_entry(db, entry_id)
    if not entry:
        raise HTTPException(status_code=404, detail="Book of Year entry not found")
    return entry


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_personal_data.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_personal_data import UserPersonalData, UserPersonalDataCreate, UserVerifyEmail
from app.crud import users_personal_data as crud

router = APIRouter()


@router.post("/", response_model=UserPersonalData, status_code=201)
def create_user(user: UserPersonalDataCreate, db: Session = Depends(get_db)):
    db_user = crud.get_user_by_email(db, user.email)
    if db_user:
        # Если пользователь есть, но не подтвержден - можно пересоздать код (опционально)
        # Но пока просто вернем ошибку
        raise HTTPException(status_code=400, detail="Email already registered")
    return crud.create_user(db, user)

@router.post("/verify", status_code=200)
def verify_email(data: UserVerifyEmail, db: Session = Depends(get_db)):
    result = crud.verify_user_email(db, data.email, data.code)

    if result is None:
        raise HTTPException(status_code=404, detail="User not found")

    if result is False:
        raise HTTPException(status_code=400, detail="Invalid verification code")

    return {"message": "Email verified successfully"}

@router.get("/", response_model=List[UserPersonalData])
def read_users(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_users(db, skip=skip, limit=limit)


@router.get("/{user_id}/", response_model=UserPersonalData)
def read_user(user_id: int, db: Session = Depends(get_db)):
    user = crud.get_user_by_id(db, user_id)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_reading_records.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_reading_records import UserReadingRecord, UserReadingRecordCreate
from app.crud import users_reading_records as crud

router = APIRouter()

@router.post("/", response_model=UserReadingRecord, status_code=201)
def create_record(record: UserReadingRecordCreate, db: Session = Depends(get_db)):
    return crud.create_record(db, record)

@router.get("/", response_model=List[UserReadingRecord])
def read_records(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_records(db, skip=skip, limit=limit)

@router.get("/{record_id}/", response_model=UserReadingRecord)
def read_record(record_id: int, db: Session = Depends(get_db)):
    record = crud.get_record(db, record_id)
    if not record:
        raise HTTPException(status_code=404, detail="Record not found")
    return record


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_statistics.py =====

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session, joinedload
from typing import List
from collections import Counter

from app.db.session import get_db
from app.schemas.users_statistics import UserStatistics
from app.models.users_book_review import UserBookReview
from app.models.books_editions import BookEdition
from app.models.literature_works import LiteratureWork
from app.models.users_book_review_genres import UserBookReviewGenre
from app.models.genre import Genre
from app.models.books_categories import BookCategory

router = APIRouter()


@router.get("/user/{user_id}", response_model=UserStatistics)
def read_user_statistics(user_id: int, db: Session = Depends(get_db)):
    # 1. Загружаем все отзывы пользователя вместе с книгами, авторами, категориями и жанрами
    reviews = (
        db.query(UserBookReview)
        .options(
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.book).joinedload(BookEdition.work),
            joinedload(UserBookReview.genres).joinedload(UserBookReviewGenre.genre)
        )
        .filter(UserBookReview.user_id == user_id)
        .all()
    )

    # 2. Инициализируем счетчики
    total_books = 0
    read_count = 0
    favorites_count = 0

    authors_list = []
    genres_list = []

    # 3. Проходимся по всем книгам и считаем
    for review in reviews:
        total_books += 1

        cat_name = review.category.name if review.category else ""

        # Логика подсчета
        if cat_name == "Прочитано":
            read_count += 1
        elif cat_name == "Любимые":
            favorites_count += 1
            # Обычно любимые книги тоже считаются прочитанными
            read_count += 1

            # Собираем автора (если есть)
        if review.book and review.book.work:
            authors_list.append(review.book.work.author)

        # Собираем жанры
        if review.genres:
            for g_link in review.genres:
                if g_link.genre:
                    genres_list.append(g_link.genre.name)

    # 4. Определяем самого популярного автора
    favorite_author = "-"
    if authors_list:
        # Counter создает словарь {автор: кол-во}, most_common(1) берет топ-1
        favorite_author = Counter(authors_list).most_common(1)[0][0]

    # 5. Определяем самый популярный жанр
    favorite_genre = "-"
    if genres_list:
        favorite_genre = Counter(genres_list).most_common(1)[0][0]

    # 6. Возвращаем объект статистики
    # id=0, так как это вычисляемая "на лету" сущность, а не запись из таблицы users_statistics
    return UserStatistics(
        id=0,
        user_id=user_id,
        books_in_library=total_books,
        books_read=read_count,
        books_favorites=favorites_count,
        favorite_author=favorite_author,
        favorite_genre=favorite_genre
    )


# Остальные эндпоинты можно оставить или закомментировать,
# так как фронтенд использует только этот.
@router.post("/", response_model=UserStatistics, status_code=201)
def create_statistics(stats: UserStatistics, db: Session = Depends(get_db)):
    # Заглушка, чтобы не ломать старый код, если он где-то используется
    return stats


@router.get("/", response_model=List[UserStatistics])
def read_statistics(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return []

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\users_top_characters.py =====

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db
from app.schemas.users_top_characters import UserTopCharacters, UserTopCharactersCreate
from app.crud import users_top_characters as crud

router = APIRouter()

@router.post("/", response_model=UserTopCharacters, status_code=201)
def create_top_characters(top_chars: UserTopCharactersCreate, db: Session = Depends(get_db)):
    return crud.create_top_characters(db, top_chars)

@router.get("/", response_model=List[UserTopCharacters])
def read_top_characters(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    return crud.get_top_characters(db, skip=skip, limit=limit)

@router.get("/{record_id}/", response_model=UserTopCharacters)
def read_top_characters_by_id(record_id: int, db: Session = Depends(get_db)):
    record = crud.get_top_characters_by_id(db, record_id)
    if not record:
        raise HTTPException(status_code=404, detail="Top characters record not found")
    return record


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\api\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_core.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\core\config.py =====

import os
from dotenv import load_dotenv

load_dotenv()

class Settings:
    DATABASE_URL: str = os.getenv("DATABASE_URL") or os.getenv("DATABASE_URL_LOCAL")

settings = Settings()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\core\security.py =====

from datetime import datetime, timedelta
from typing import Optional
from jose import jwt
from passlib.context import CryptContext

# Настройки (в идеале вынести в .env, но для диплома можно так)
SECRET_KEY = "secret_key_for_owlreads_diploma"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)


def get_password_hash(password):
    return pwd_context.hash(password)


def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)

    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\core\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_crud.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\books_categories.py =====

from sqlalchemy.orm import Session
from app.models.books_categories import BookCategory
from app.schemas.books_categories import BookCategoryCreate

def create_category(db: Session, category: BookCategoryCreate):
    db_category = BookCategory(**category.dict())
    db.add(db_category)
    db.commit()
    db.refresh(db_category)
    return db_category

def get_categories(db: Session, skip: int = 0, limit: int = 100):
    return db.query(BookCategory).offset(skip).limit(limit).all()

def get_category_by_name(db: Session, name: str):
    return db.query(BookCategory).filter(BookCategory.name == name).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\literature.py =====

from sqlalchemy.orm import Session
from app.models.literature_works import LiteratureWork
from app.models.books_editions import BookEdition
from app.schemas.literature import LiteratureWorkCreate, BookEditionCreate
from sqlalchemy import or_

# --- LiteratureWork ---
def create_literature_work(db: Session, work: LiteratureWorkCreate):
    db_work = LiteratureWork(**work.dict())
    db.add(db_work)
    db.commit()
    db.refresh(db_work)
    return db_work

def get_literature_work(db: Session, work_id: int):
    return db.query(LiteratureWork).filter(LiteratureWork.id == work_id).first()

def get_literature_works(db: Session, skip: int = 0, limit: int = 100):
    return db.query(LiteratureWork).offset(skip).limit(limit).all()


# --- BookEdition ---
def create_book_edition(db: Session, edition: BookEditionCreate):
    db_edition = BookEdition(**edition.dict())
    db.add(db_edition)
    db.commit()
    db.refresh(db_edition)
    return db_edition

def get_book_edition(db: Session, edition_id: int):
    return db.query(BookEdition).filter(BookEdition.id == edition_id).first()

def get_book_editions(db: Session, skip: int = 0, limit: int = 100):
    return db.query(BookEdition).offset(skip).limit(limit).all()

def search_books(db: Session, query: str, limit: int = 10):
    search_term = f"%{query}%"

    return (
        db.query(BookEdition)
        .join(LiteratureWork)
        .filter(
            or_(
                LiteratureWork.title.ilike(search_term),
                LiteratureWork.author.ilike(search_term)
            )
        )
        .limit(limit)
        .all()
    )

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_notes.py =====

from sqlalchemy.orm import Session
from app.models.users_book_notes import UserBookNote
from app.schemas.users_book_notes import UserBookNoteCreate

def create_note(db: Session, note: UserBookNoteCreate):
    db_note = UserBookNote(**note.dict())
    db.add(db_note)
    db.commit()
    db.refresh(db_note)
    return db_note

def get_notes(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookNote).offset(skip).limit(limit).all()

def get_note(db: Session, note_id: int):
    return db.query(UserBookNote).filter(UserBookNote.id == note_id).first()

def delete_note(db: Session, note_id: int):
    obj = db.query(UserBookNote).filter(UserBookNote.id == note_id).first()
    if obj:
        db.delete(obj)
        db.commit()
        return True
    return False

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_quotes.py =====

from sqlalchemy.orm import Session
from app.models.users_book_quotes import UserBookQuote
from app.schemas.users_book_quotes import UserBookQuoteCreate

def create_quote(db: Session, quote: UserBookQuoteCreate):
    db_quote = UserBookQuote(**quote.dict())
    db.add(db_quote)
    db.commit()
    db.refresh(db_quote)
    return db_quote

def get_quotes(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookQuote).offset(skip).limit(limit).all()

def get_quote(db: Session, quote_id: int):
    return db.query(UserBookQuote).filter(UserBookQuote.id == quote_id).first()

def delete_quote(db: Session, quote_id: int):
    obj = db.query(UserBookQuote).filter(UserBookQuote.id == quote_id).first()
    if obj:
        db.delete(obj)
        db.commit()
        return True
    return False

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_rating.py =====

# app/crud/users_book_rating.py
from sqlalchemy.orm import Session
from app.models.users_book_rating import UserBookRating
from app.schemas.users_book_rating import UserBookRatingCreate


def create_rating(db: Session, rating: UserBookRatingCreate):
    # Ищем, есть ли уже рейтинг у этого отзыва
    existing_rating = db.query(UserBookRating).filter(UserBookRating.review_id == rating.review_id).first()

    if existing_rating:
        # ОБНОВЛЕНИЕ: Если нашли, меняем поля
        rating_data = rating.dict(exclude_unset=True)
        for key, value in rating_data.items():
            setattr(existing_rating, key, value)

        db.commit()
        db.refresh(existing_rating)
        return existing_rating
    else:
        # СОЗДАНИЕ: Если не нашли, создаем новый
        db_rating = UserBookRating(**rating.dict())
        db.add(db_rating)
        db.commit()
        db.refresh(db_rating)
        return db_rating


def get_ratings(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookRating).offset(skip).limit(limit).all()


def get_rating(db: Session, rating_id: int):
    return db.query(UserBookRating).filter(UserBookRating.id == rating_id).first()

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_review.py =====

# app/crud/users_book_review.py
from sqlalchemy.orm import Session
from sqlalchemy.orm import joinedload
from app.models.users_book_review import UserBookReview
from app.schemas.users_book_review import UserBookReviewCreate
from app.models.literature_works import LiteratureWork
from app.models.books_editions import BookEdition
from app.models.books_categories import BookCategory
from app.schemas.custom_book import BookManualCreate
from app.models.genre import Genre
from app.models.users_book_review_genres import UserBookReviewGenre

def create_review(db: Session, review: UserBookReviewCreate) -> UserBookReview:
    db_review = UserBookReview(**review.dict())
    db.add(db_review)
    db.commit()
    db.refresh(db_review)
    return db_review

def get_reviews(db: Session, skip: int = 0, limit: int = 100):
    return (
        db.query(UserBookReview)
        .options(
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.rating),
            joinedload(UserBookReview.user),
            joinedload(UserBookReview.quotes),
            joinedload(UserBookReview.notes)
            # Добавь joinedload для всех полей, которые нужны в ответе
        )
        .offset(skip)
        .limit(limit)
        .all()
    )
def get_review_by_id(db: Session, review_id: int):
    return db.query(UserBookReview).filter(UserBookReview.id == review_id).first()

def get_user_reviews_by_category_name(db: Session, user_id: int, category_name: str):
    return (
        db.query(UserBookReview)
        .join(UserBookReview.category)
        .filter(UserBookReview.user_id == user_id)
        .filter(UserBookReview.category.has(name=category_name))
        .all()
    )

def delete_review(db: Session, review_id: int) -> bool:
    obj = db.query(UserBookReview).filter(UserBookReview.id == review_id).first()
    if not obj:
        return False
    db.delete(obj)
    db.commit()
    return True

def get_user_library(db: Session, user_id: int, skip: int = 0, limit: int = 100):
    return (
        db.query(UserBookReview)
        .options(
            # Теперь Python знает, что такое BookEdition
            joinedload(UserBookReview.book).joinedload(BookEdition.work),
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.rating)
        )
        .filter(UserBookReview.user_id == user_id)
        .offset(skip)
        .limit(limit)
        .all()
    )

def create_manual_book_review(db: Session, user_id: int, data: BookManualCreate):
    # 1. Ищем категорию (она должна существовать)
    category = db.query(BookCategory).filter(BookCategory.name == data.category_name).first()
    if not category:
        # Если категории нет, можно либо вернуть ошибку, либо создать дефолтную.
        # Для надежности вернем None, фронт должен слать правильные названия.
        return None

    # 2. Создаем Литературное произведение
    # (В будущем здесь можно добавить проверку: если такое название+автор есть, не создавать дубль)
    new_work = LiteratureWork(
        title=data.title,
        author=data.author
    )
    db.add(new_work)
    db.flush()  # flush позволяет получить id созданного объекта до commit

    # 3. Создаем Издание книги
    new_edition = BookEdition(
        literature_work_id=new_work.id,
        pages=data.pages,
        year=data.year,
        language=data.language,
        description=data.description,
        cover_url=data.cover_url
    )
    db.add(new_edition)
    db.flush()

    # 4. Создаем Отзыв пользователя (связь)
    new_review = UserBookReview(
        user_id=user_id,
        book_id=new_edition.id,
        category_id=category.id
    )
    db.add(new_review)

    db.commit()
    db.refresh(new_review)

    return new_review

def get_review_detail(db: Session, review_id: int):
    return (
        db.query(UserBookReview)
        .options(
            joinedload(UserBookReview.book).joinedload(BookEdition.work),
            joinedload(UserBookReview.category),
            joinedload(UserBookReview.rating),
            joinedload(UserBookReview.quotes),
            joinedload(UserBookReview.notes),
            joinedload(UserBookReview.genres).joinedload(UserBookReviewGenre.genre)
        )
        .filter(UserBookReview.id == review_id)
        .first()
    )


def update_review_category(db: Session, review_id: int, category_name: str):
    # 1. Ищем сам отзыв
    review = db.query(UserBookReview).filter(UserBookReview.id == review_id).first()
    if not review:
        return None

    # 2. Ищем ID категории по названию (например "Читаю" -> id=2)
    category = db.query(BookCategory).filter(BookCategory.name == category_name).first()
    if not category:
        # Если такой категории нет в базе, ничего не делаем (или можно вернуть ошибку)
        return None

    # 3. Обновляем
    review.category_id = category.id
    db.commit()
    db.refresh(review)
    return review


def update_review_genres(db: Session, review_id: int, genre_names: list[str]):
    # 1. Удаляем ВСЕ текущие жанры у этого отзыва
    db.query(UserBookReviewGenre).filter(UserBookReviewGenre.review_id == review_id).delete()

    # 2. Если список пустой, просто сохраняем удаление
    if not genre_names:
        db.commit()
        return []

    # 3. Ищем ID жанров по их названиям
    # (SELECT * FROM genres WHERE name IN (...))
    genres = db.query(Genre).filter(Genre.name.in_(genre_names)).all()

    # 4. Создаем новые связи
    new_entries = []
    for genre in genres:
        entry = UserBookReviewGenre(review_id=review_id, genre_id=genre.id)
        db.add(entry)
        new_entries.append(entry)

    db.commit()

    # Возвращаем список объектов жанров (для удобства, если нужно)
    return genres

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_book_review_genres.py =====

from sqlalchemy.orm import Session
from app.models.users_book_review_genres import UserBookReviewGenre
from app.schemas.users_book_review_genres import UserBookReviewGenreCreate

def create_review_genre(db: Session, entry: UserBookReviewGenreCreate):
    db_entry = UserBookReviewGenre(**entry.dict())
    db.add(db_entry)
    db.commit()
    db.refresh(db_entry)
    return db_entry

def get_review_genres(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserBookReviewGenre).offset(skip).limit(limit).all()

def get_review_genre(db: Session, entry_id: int):
    return db.query(UserBookReviewGenre).filter(UserBookReviewGenre.id == entry_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_challenges.py =====

from sqlalchemy.orm import Session
from app.models.users_challenges import UserChallenge
from app.schemas.users_challenges import UserChallengeCreate

def create_challenge(db: Session, challenge: UserChallengeCreate):
    db_challenge = UserChallenge(**challenge.dict())
    db.add(db_challenge)
    db.commit()
    db.refresh(db_challenge)
    return db_challenge

def get_challenges(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserChallenge).offset(skip).limit(limit).all()

def get_challenge(db: Session, challenge_id: int):
    return db.query(UserChallenge).filter(UserChallenge.id == challenge_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_challenge_books_alphabet.py =====

from sqlalchemy.orm import Session
from app.models.users_challenge_books_alphabet import UserChallengeBooksAlphabet
from app.schemas.users_challenge_books_alphabet import UserChallengeBooksAlphabetCreate

def create_alphabet_entry(db: Session, entry: UserChallengeBooksAlphabetCreate):
    db_entry = UserChallengeBooksAlphabet(**entry.dict())
    db.add(db_entry)
    db.commit()
    db.refresh(db_entry)
    return db_entry

def get_alphabet_entries(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserChallengeBooksAlphabet).offset(skip).limit(limit).all()

def get_alphabet_entry(db: Session, entry_id: int):
    return db.query(UserChallengeBooksAlphabet).filter(UserChallengeBooksAlphabet.id == entry_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_challenge_book_of_year.py =====

from sqlalchemy.orm import Session
from app.models.users_challenge_book_of_year import UserChallengeBookOfYear
from app.schemas.users_challenge_book_of_year import UserChallengeBookOfYearCreate

def create_entry(db: Session, entry: UserChallengeBookOfYearCreate):
    db_entry = UserChallengeBookOfYear(**entry.dict())
    db.add(db_entry)
    db.commit()
    db.refresh(db_entry)
    return db_entry

def get_entries(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserChallengeBookOfYear).offset(skip).limit(limit).all()

def get_entry(db: Session, entry_id: int):
    return db.query(UserChallengeBookOfYear).filter(UserChallengeBookOfYear.id == entry_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_personal_data.py =====

from sqlalchemy.orm import Session
from app.models.users_personal_data import UserPersonalData
from app.schemas.users_personal_data import UserPersonalDataCreate
from passlib.context import CryptContext
from app.utils.email import generate_verification_code, send_verification_email

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def create_user(db: Session, user: UserPersonalDataCreate):
    hashed_password = pwd_context.hash(user.password_hash)

    code = generate_verification_code()

    db_user = UserPersonalData(
        username=user.username,
        email=user.email,
        password_hash=hashed_password,
        agreement_accepted=user.agreement_accepted,
        profile_photo=user.profile_photo,
        verification_code=code,
        is_verified=False
    )

    db.add(db_user)
    db.commit()
    db.refresh(db_user)

    send_verification_email(user.email, code)

    return db_user

def verify_user_email(db: Session, email: str, code: str):
    user = get_user_by_email(db, email)
    if not user:
        return None

    if user.verification_code == code:
        user.is_verified = True
        user.verification_code = None
        db.commit()
        db.refresh(user)
        return user

    return False

def get_users(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserPersonalData).offset(skip).limit(limit).all()


def get_user_by_id(db: Session, user_id: int):
    return db.query(UserPersonalData).filter(UserPersonalData.id == user_id).first()


def get_user_by_email(db: Session, email: str):
    return db.query(UserPersonalData).filter(UserPersonalData.email == email).first()

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_reading_records.py =====

from sqlalchemy.orm import Session
from app.models.users_reading_records import UserReadingRecord
from app.schemas.users_reading_records import UserReadingRecordCreate

def create_record(db: Session, record: UserReadingRecordCreate):
    db_record = UserReadingRecord(**record.dict())
    db.add(db_record)
    db.commit()
    db.refresh(db_record)
    return db_record

def get_records(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserReadingRecord).offset(skip).limit(limit).all()

def get_record(db: Session, record_id: int):
    return db.query(UserReadingRecord).filter(UserReadingRecord.id == record_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_statistics.py =====

from sqlalchemy.orm import Session
from app.models.users_statistics import UserStatistics
from app.schemas.users_statistics import UserStatisticsCreate

def create_statistics(db: Session, stats: UserStatisticsCreate):
    db_stats = UserStatistics(**stats.dict())
    db.add(db_stats)
    db.commit()
    db.refresh(db_stats)
    return db_stats

def get_statistics(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserStatistics).offset(skip).limit(limit).all()

def get_statistics_by_id(db: Session, stats_id: int):
    return db.query(UserStatistics).filter(UserStatistics.id == stats_id).first()

def get_statistics_by_user_id(db: Session, user_id: int):
    return db.query(UserStatistics).filter(UserStatistics.user_id == user_id).first()

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\users_top_characters.py =====

from sqlalchemy.orm import Session
from app.models.users_top_characters import UserTopCharacters
from app.schemas.users_top_characters import UserTopCharactersCreate

def create_top_characters(db: Session, top_chars: UserTopCharactersCreate):
    db_top_chars = UserTopCharacters(**top_chars.dict())
    db.add(db_top_chars)
    db.commit()
    db.refresh(db_top_chars)
    return db_top_chars

def get_top_characters(db: Session, skip: int = 0, limit: int = 100):
    return db.query(UserTopCharacters).offset(skip).limit(limit).all()

def get_top_characters_by_id(db: Session, record_id: int):
    return db.query(UserTopCharacters).filter(UserTopCharacters.id == record_id).first()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\crud\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_db.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\db\base.py =====

from sqlalchemy.orm import declarative_base

Base = declarative_base()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\db\session.py =====

from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

from app.core.config import settings

engine = create_engine(settings.DATABASE_URL, pool_pre_ping=True)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\db\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_models.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\books_categories.py =====

from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import relationship
from app.db.base import Base

class BookCategory(Base):
    __tablename__ = "books_categories"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), unique=True, nullable=False)
    color = Column(String(7), nullable=False, server_default="#AB66FF")

    reviews = relationship("UserBookReview", back_populates="category")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\books_editions.py =====

from sqlalchemy import Column, Integer, String, ForeignKey, Text
from sqlalchemy.orm import relationship
from app.db.base import Base

class BookEdition(Base):
    __tablename__ = "books_editions"

    id = Column(Integer, primary_key=True, index=True)
    literature_work_id = Column(Integer, ForeignKey("literature_works.id"), nullable=False)

    original_year = Column(Integer, nullable=True)
    description = Column(Text, nullable=True)
    publisher = Column(String(255), nullable=True)
    year = Column(Integer, nullable=True)
    pages = Column(Integer, nullable=True)
    cover_url = Column(String(500), nullable=True)
    isbn = Column(String(20), unique=True, nullable=True)
    language = Column(String(50), nullable=True)

    # связь с произведением
    work = relationship("LiteratureWork", back_populates="editions")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\genre.py =====

from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import relationship
from app.db.base import Base

class Genre(Base):
    __tablename__ = "genres"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), unique=True, nullable=False)
    color = Column(String(7), nullable=False, server_default="#AB66FF")

    reviews = relationship("UserBookReviewGenre", back_populates="genre")




===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\literature_works.py =====

from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import relationship
from app.db.base import Base

class LiteratureWork(Base):
    __tablename__ = "literature_works"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(255), nullable=False)
    author = Column(String(255), nullable=False)

    # связь с изданиями
    editions = relationship("BookEdition", back_populates="work", cascade="all, delete-orphan")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\popular_quotes.py =====

from sqlalchemy import Column, Integer, String, Text
from app.db.base import Base

class PopularQuote(Base):
    __tablename__ = "popular_quotes"

    id = Column(Integer, primary_key=True, index=True)
    text = Column(Text, nullable=False)
    book_title = Column(String(255), nullable=False)


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_notes.py =====

from sqlalchemy import Column, Integer, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserBookNote(Base):
    __tablename__ = "users_book_notes"

    id = Column(Integer, primary_key=True, index=True)
    text = Column(Text, nullable=False)

    # связь с users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    date = Column(DateTime, default=datetime.utcnow)

    review = relationship("UserBookReview", back_populates="notes")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_quotes.py =====

from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserBookQuote(Base):
    __tablename__ = "users_book_quotes"

    id = Column(Integer, primary_key=True, index=True)
    text = Column(Text, nullable=False)
    quote_author = Column(String(255), nullable=True)

    # связь с users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    date = Column(DateTime, default=datetime.utcnow)


    review = relationship("UserBookReview", back_populates="quotes")




===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_rating.py =====

from sqlalchemy import Column, Integer, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserBookRating(Base):
    __tablename__ = "users_book_rating"

    id = Column(Integer, primary_key=True, index=True)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), unique=True, nullable=False)

    total_rating = Column(Integer, nullable=False)
    characters_rating = Column(Integer, nullable=True)
    plot_rating = Column(Integer, nullable=True)
    relations_rating = Column(Integer, nullable=True)
    emotionality_rating = Column(Integer, nullable=True)
    ending_rating = Column(Integer, nullable=True)
    easy_reading_rating = Column(Integer, nullable=True)

    review = relationship("UserBookReview", back_populates="rating")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_review.py =====

from sqlalchemy import Column, Integer, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base


class UserBookReview(Base):
    __tablename__ = "users_book_review"

    id = Column(Integer, primary_key=True, index=True)

    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)
    book_id = Column(Integer, ForeignKey("books_editions.id"), nullable=False)
    category_id = Column(Integer, ForeignKey("books_categories.id"), nullable=False)

    # --- СВЯЗИ ---
    user = relationship("UserPersonalData", back_populates="book_reviews")
    category = relationship("BookCategory", back_populates="reviews")

    # !!! ВОТ ЭТОЙ СТРОКИ НЕ ХВАТАЛО !!!
    book = relationship("BookEdition")

    # многие ко многим через join-таблицу
    genres = relationship("UserBookReviewGenre", back_populates="review", cascade="all, delete-orphan")

    # один к одному
    rating = relationship("UserBookRating", back_populates="review", uselist=False, cascade="all, delete-orphan")
    top_characters = relationship("UserTopCharacters", back_populates="review", uselist=False,
                                  cascade="all, delete-orphan")

    # один ко многим
    quotes = relationship("UserBookQuote", back_populates="review", cascade="all, delete-orphan")
    notes = relationship("UserBookNote", back_populates="review", cascade="all, delete-orphan")
    reading_records = relationship("UserReadingRecord", back_populates="review", cascade="all, delete-orphan")
    alphabet_challenges = relationship("UserChallengeBooksAlphabet", back_populates="review",
                                       cascade="all, delete-orphan")
    book_of_year_challenges = relationship("UserChallengeBookOfYear", back_populates="review",
                                           cascade="all, delete-orphan")

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_book_review_genres.py =====

from sqlalchemy import Column, Integer, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserBookReviewGenre(Base):
    __tablename__ = "users_book_review_genres"

    id = Column(Integer, primary_key=True, index=True)
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)
    genre_id = Column(Integer, ForeignKey("genres.id"), nullable=False)

    review = relationship("UserBookReview", back_populates="genres")
    genre = relationship("Genre", back_populates="reviews")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_challenges.py =====

from sqlalchemy import Column, Integer, String, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserChallenge(Base):
    __tablename__ = "users_challenges"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    challenge_type = Column(String(50), nullable=False)
    started_at = Column(DateTime, default=datetime.utcnow)
    finished_at = Column(DateTime, nullable=True)
    status = Column(String(50), default="В процессе")

    user = relationship("UserPersonalData", back_populates="challenges")
    alphabet_entries = relationship("UserChallengeBooksAlphabet", back_populates="challenge")
    book_of_year_entries = relationship("UserChallengeBookOfYear", back_populates="challenge")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_challenge_books_alphabet.py =====

from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserChallengeBooksAlphabet(Base):
    __tablename__ = "users_challenge_books_alphabet"

    id = Column(Integer, primary_key=True, index=True)
    challenge_id = Column(Integer, ForeignKey("users_challenges.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    letter = Column(String(1), nullable=False)

    challenge = relationship("UserChallenge", back_populates="alphabet_entries")
    user = relationship("UserPersonalData", back_populates="alphabet_challenges")
    review = relationship("UserBookReview", back_populates="alphabet_challenges")




===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_challenge_book_of_year.py =====

from sqlalchemy import Column, Integer, String, Boolean, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserChallengeBookOfYear(Base):
    __tablename__ = "users_challenge_book_of_year"

    id = Column(Integer, primary_key=True, index=True)

    # связь с users_challenges
    challenge_id = Column(Integer, ForeignKey("users_challenges.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    month = Column(Integer, nullable=True)   # месяц (1–12)
    stage = Column(String(50), nullable=False)  # этап: month/pair/group/final
    is_winner = Column(Boolean, default=False)

    challenge = relationship("UserChallenge", back_populates="book_of_year_entries")
    user = relationship("UserPersonalData", back_populates="book_of_year_challenges")
    review = relationship("UserBookReview", back_populates="book_of_year_challenges")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_personal_data.py =====

from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime
from app.db.base import Base

class UserPersonalData(Base):
    __tablename__ = "users_personal_data"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(255), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)

    agreement_accepted = Column(Boolean, default=False)
    registered_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    profile_photo = Column(String(255), nullable=True)

    # --- НОВЫЕ ПОЛЯ ---
    verification_code = Column(String(6), nullable=True)
    is_verified = Column(Boolean, default=False)
    # ------------------

    # обратные связи
    statistics = relationship("UserStatistics", back_populates="user", uselist=False)
    challenges = relationship("UserChallenge", back_populates="user")
    alphabet_challenges = relationship("UserChallengeBooksAlphabet", back_populates="user")
    book_of_year_challenges = relationship("UserChallengeBookOfYear", back_populates="user")
    book_reviews = relationship("UserBookReview", back_populates="user")

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_reading_records.py =====

from sqlalchemy import Column, Integer, String, Text, Date, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserReadingRecord(Base):
    __tablename__ = "users_reading_records"

    id = Column(Integer, primary_key=True, index=True)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), nullable=False)

    start_date = Column(Date, nullable=True)   # дата начала (может быть пустой)
    end_date = Column(Date, nullable=True)     # дата конца (может быть пустой)

    result = Column(String(50), nullable=False)  # Брошено / Завершено / В процессе
    comment = Column(Text, nullable=True)

    review = relationship("UserBookReview", back_populates="reading_records")

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_statistics.py =====

from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserStatistics(Base):
    __tablename__ = "users_statistics"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users_personal_data.id"), nullable=False)

    books_in_library = Column(Integer, default=0)
    books_read = Column(Integer, default=0)
    books_favorites = Column(Integer, default=0)
    favorite_author = Column(String(255), nullable=True)
    favorite_genre = Column(String(100), nullable=True)

    user = relationship("UserPersonalData", back_populates="statistics")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\users_top_characters.py =====

from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base

class UserTopCharacters(Base):
    __tablename__ = "users_top_characters"

    id = Column(Integer, primary_key=True, index=True)

    # связь c users_book_review
    review_id = Column(Integer, ForeignKey("users_book_review.id"), unique=True, nullable=False)

    top_1 = Column(String(255), nullable=True)
    top_2 = Column(String(255), nullable=True)
    top_3 = Column(String(255), nullable=True)
    top_4 = Column(String(255), nullable=True)
    top_5 = Column(String(255), nullable=True)

    review = relationship("UserBookReview", back_populates="top_characters")


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\models\__init__.py =====

from .popular_quotes import PopularQuote
from .genre import Genre
from .books_editions import BookEdition
from .literature_works import LiteratureWork
from .users_book_notes import UserBookNote
from .users_book_quotes import UserBookQuote
from .users_reading_records import UserReadingRecord
from .users_book_rating import UserBookRating
from .users_top_characters import UserTopCharacters
from .users_challenge_books_alphabet import UserChallengeBooksAlphabet
from .users_challenge_book_of_year import UserChallengeBookOfYear
from .users_challenges import UserChallenge
from .users_statistics import UserStatistics
from .users_personal_data import UserPersonalData
from .users_book_review_genres import UserBookReviewGenre
from .books_categories import BookCategory
from .users_book_review import UserBookReview

__all__ = ["PopularQuote",
           "Genre",
           "BookEdition",
           "LiteratureWork",
           "UserBookNote",
           "UserBookQuote",
           "UserReadingRecord",
           "UserBookRating",
           "UserTopCharacters",
           "UserChallengeBooksAlphabet",
           "UserChallengeBookOfYear",
           "UserChallenge",
           "UserStatistics",
           "UserPersonalData",
           "UserBookReviewGenre",
           "BookCategory",
           "UserBookReview"]


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\app_schemas.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\books_categories.py =====

from pydantic import BaseModel

class BookCategoryBase(BaseModel):
    name: str
    color: str

class BookCategoryCreate(BookCategoryBase):
    pass

class BookCategory(BookCategoryBase):
    id: int
    color: str

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\custom_book.py =====

from pydantic import BaseModel
from typing import Optional

class BookManualCreate(BaseModel):
    title: str
    author: str
    pages: Optional[int] = None
    year: Optional[int] = None
    language: Optional[str] = None
    description: Optional[str] = None
    cover_url: Optional[str] = None
    category_name: str  # Например: "Читаю", "Прочитано"

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\genre.py =====

# app/schemas/genre.py
from pydantic import BaseModel

class GenreBase(BaseModel):
    name: str
    color: str

class GenreCreate(GenreBase):
    pass

class GenreRead(GenreBase):
    id: int
    color: str

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\literature.py =====

from pydantic import BaseModel
from typing import Optional, List

# --- LiteratureWork ---
class LiteratureWorkBase(BaseModel):
    title: str
    author: str

class LiteratureWorkCreate(LiteratureWorkBase):
    pass

class LiteratureWork(LiteratureWorkBase):
    id: int

    class Config:
        from_attributes = True


# --- BookEdition ---
class BookEditionBase(BaseModel):
    original_year: Optional[int] = None
    description: Optional[str] = None
    publisher: Optional[str] = None
    year: Optional[int] = None
    pages: Optional[int] = None
    cover_url: Optional[str] = None
    isbn: Optional[str] = None
    language: Optional[str] = None

class BookEditionCreate(BookEditionBase):
    literature_work_id: int

class BookEdition(BookEditionBase):
    id: int
    literature_work_id: int

    class Config:
        from_attributes = True

class BookSearchResponse(BaseModel):
    id: int
    title: str
    author: str
    cover_url: Optional[str] = None
    year: Optional[int] = None

    # Поле, чтобы фронт понимал, что это книга из нашей БД
    source: str = "local"

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\popular_quotes.py =====

# app/schemas/popular_quotes.py
from pydantic import BaseModel

class PopularQuoteBase(BaseModel):
    text: str
    book_title: str

class PopularQuoteCreate(PopularQuoteBase):
    pass

class PopularQuote(PopularQuoteBase):
    id: int

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_notes.py =====

from pydantic import BaseModel
from datetime import datetime
from typing import Optional

class UserBookNoteBase(BaseModel):
    text: str

class UserBookNoteCreate(UserBookNoteBase):
    review_id: int

class UserBookNote(UserBookNoteBase):
    id: int
    review_id: int
    date: Optional[datetime] = None

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_quotes.py =====

from pydantic import BaseModel
from datetime import datetime
from typing import Optional

class UserBookQuoteBase(BaseModel):
    text: str
    quote_author: Optional[str] = None

class UserBookQuoteCreate(UserBookQuoteBase):
    review_id: int

class UserBookQuote(UserBookQuoteBase):
    id: int
    review_id: int  # И здесь полезно
    date: Optional[datetime] = None

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_rating.py =====

from pydantic import BaseModel

class UserBookRatingBase(BaseModel):
    total_rating: int
    characters_rating: int | None = None
    plot_rating: int | None = None
    relations_rating: int | None = None
    emotionality_rating: int | None = None
    ending_rating: int | None = None
    easy_reading_rating: int | None = None

class UserBookRatingCreate(UserBookRatingBase):
    review_id: int

class UserBookRating(UserBookRatingBase):
    id: int
    review_id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_review.py =====

from typing import List, Optional
from pydantic import BaseModel

# Импортируем другие схемы (обратите внимание на точки перед названиями файлов)
from .books_categories import BookCategory
from .users_book_rating import UserBookRating
from .users_book_quotes import UserBookQuote
from .users_book_notes import UserBookNote
from .genre import GenreRead

class UserBookReviewBase(BaseModel):
    user_id: int
    book_id: int
    category_id: int

class UserBookReviewCreate(UserBookReviewBase):
    pass

class UserBookReview(UserBookReviewBase):
    id: int
    category: BookCategory
    rating: Optional[UserBookRating] = None
    quotes: List[UserBookQuote] = []
    notes: List[UserBookNote] = []

    class Config:
        from_attributes = True

class LibraryBookRead(BaseModel):
    review_id: int
    book_id: int
    title: str
    author: str
    cover_url: Optional[str] = None
    category_name: str
    category_color: str = "#AB66FF"
    rating: int = 0

    class Config:
        from_attributes = True

class BookReviewDetail(BaseModel):
    review_id: int
    book_id: int

    # Данные книги
    title: str
    author: str
    pages: Optional[int] = None
    year: Optional[int] = None
    description: Optional[str] = None
    cover_url: Optional[str] = None

    # Данные отзыва
    category_name: str

    # Вложенные данные
    rating: Optional[UserBookRating] = None
    quotes: List[UserBookQuote] = []
    notes: List[UserBookNote] = []
    genres: List[GenreRead] = []

    class Config:
        from_attributes = True

class UserBookReviewUpdateCategory(BaseModel):
    category_name: str

class UserBookReviewUpdateGenres(BaseModel):
    genres: List[str]  # Список названий, например ["Фэнтези", "Роман"]

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_book_review_genres.py =====

from pydantic import BaseModel

class UserBookReviewGenreBase(BaseModel):
    review_id: int
    genre_id: int

class UserBookReviewGenreCreate(UserBookReviewGenreBase):
    pass

class UserBookReviewGenre(UserBookReviewGenreBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_challenges.py =====

from pydantic import BaseModel
from datetime import datetime

class UserChallengeBase(BaseModel):
    challenge_type: str
    started_at: datetime | None = None
    finished_at: datetime | None = None
    status: str = "В процессе"

class UserChallengeCreate(UserChallengeBase):
    pass

class UserChallenge(UserChallengeBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_challenge_books_alphabet.py =====

from pydantic import BaseModel

class UserChallengeBooksAlphabetBase(BaseModel):
    letter: str

class UserChallengeBooksAlphabetCreate(UserChallengeBooksAlphabetBase):
    pass

class UserChallengeBooksAlphabet(UserChallengeBooksAlphabetBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_challenge_book_of_year.py =====

from pydantic import BaseModel

class UserChallengeBookOfYearBase(BaseModel):
    month: int | None = None
    stage: str
    is_winner: bool = False

class UserChallengeBookOfYearCreate(UserChallengeBookOfYearBase):
    pass

class UserChallengeBookOfYear(UserChallengeBookOfYearBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_personal_data.py =====

from pydantic import BaseModel, EmailStr
from datetime import datetime

class UserPersonalDataBase(BaseModel):
    username: str
    email: EmailStr
    password_hash: str
    agreement_accepted: bool = False
    profile_photo: str | None = None

class UserPersonalDataCreate(UserPersonalDataBase):
    pass

class UserVerifyEmail(BaseModel):
    email: EmailStr
    code: str

class UserPersonalData(UserPersonalDataBase):
    id: int
    registered_at: datetime
    updated_at: datetime
    is_verified: bool

    class Config:
        from_attributes = True

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_reading_records.py =====

from pydantic import BaseModel
from datetime import date

class UserReadingRecordBase(BaseModel):
    start_date: date | None = None
    end_date: date | None = None
    result: str
    comment: str | None = None

class UserReadingRecordCreate(UserReadingRecordBase):
    pass

class UserReadingRecord(UserReadingRecordBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_statistics.py =====

from pydantic import BaseModel

class UserStatisticsBase(BaseModel):
    books_in_library: int = 0
    books_read: int = 0
    books_favorites: int = 0
    favorite_author: str | None = None
    favorite_genre: str | None = None

class UserStatisticsCreate(UserStatisticsBase):
    pass

class UserStatistics(UserStatisticsBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\users_top_characters.py =====

from pydantic import BaseModel

class UserTopCharactersBase(BaseModel):
    top_1: str | None = None
    top_2: str | None = None
    top_3: str | None = None
    top_4: str | None = None
    top_5: str | None = None

class UserTopCharactersCreate(UserTopCharactersBase):
    pass

class UserTopCharacters(UserTopCharactersBase):
    id: int

    class Config:
        from_attributes = True


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\app\schemas\__init__.py =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\project_dump_parts\root.txt =====



===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\docker-compose.yml =====

version: "3.9"

services:
  db:
    image: postgres:15
    container_name: owlreads_db
    env_file:
      - .env
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 5

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: owlreads_api
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
    ports:
      - "${API_PORT}:8000"
    volumes:
      - ./app:/app/app
      - ./alembic/versions:/app/alembic/versions
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

volumes:
  postgres_data:


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\dump_frontend.py =====

import os

# 1. Укажите путь к вашему проекту мобильного приложения (React Native)
project_root = r"D:\BSUIR\Diploma\OwlReads-project\mobile-OwlReads"
# 2. Имя выходного файла
output_file = "react_native_code_dump.txt"

# Расширения файлов, которые нам интересны
include_ext = {".js", ".jsx", ".ts", ".tsx", ".json"}
# Папки, которые нужно пропустить (обязательно node_modules, так как она весит гигабайты)
exclude_dirs = {
    "node_modules",
    ".git",
    "android",
    "ios",
    ".expo",
    ".expo-shared",
    "assets",
    "build",
    "dist",
    "__pycache__"
}


def dump_project():
    count = 0
    with open(output_file, "w", encoding="utf-8") as out:
        for root, dirs, files in os.walk(project_root):
            # Фильтруем папки-исключения
            dirs[:] = [d for d in dirs if d not in exclude_dirs]

            for file in files:
                ext = os.path.splitext(file)[1].lower()
                if ext in include_ext:
                    # Пропускаем тяжелые файлы конфигурации, если они не нужны (опционально)
                    if file in ["package-lock.json", "yarn.lock"]:
                        continue

                    file_path = os.path.join(root, file)
                    relative_path = os.path.relpath(file_path, project_root)

                    out.write(f"\n\n===== FILE: {relative_path} =====\n\n")
                    try:
                        with open(file_path, "r", encoding="utf-8") as f:
                            out.write(f.read())
                        count += 1
                    except Exception as e:
                        out.write(f"[Ошибка чтения файла: {e}]")

    print(f"Успешно! Собрано файлов: {count}")
    print(f"Результат сохранен в: {os.path.abspath(output_file)}")


if __name__ == "__main__":
    dump_project()

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\dump_project.py =====

import os

project_root = r"D:\BSUIR\Diploma\OwlReads-project\server-OwlReads"
output_dir = "project_dump_parts"

include_ext = {".py", ".yml", ".yaml", ".env", ".txt", ".md"}
exclude_dirs = {"__pycache__", ".venv", ".idea"}

os.makedirs(output_dir, exist_ok=True)

for root, dirs, files in os.walk(project_root):
    # пропускаем служебные папки
    dirs[:] = [d for d in dirs if d not in exclude_dirs]

    # имя файла для дампа этой папки
    relative_path = os.path.relpath(root, project_root)
    safe_name = relative_path.replace("\\", "_").replace("/", "_")
    if safe_name == ".":
        safe_name = "root"
    output_file = os.path.join(output_dir, f"{safe_name}.txt")

    with open(output_file, "w", encoding="utf-8") as out:
        for file in files:
            ext = os.path.splitext(file)[1].lower()
            if ext in include_ext:
                file_path = os.path.join(root, file)
                out.write(f"\n\n===== {file_path} =====\n\n")
                try:
                    with open(file_path, "r", encoding="utf-8") as f:
                        out.write(f.read())
                except Exception as e:
                    out.write(f"[Ошибка чтения файла: {e}]")

===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\react_native_code_dump.txt =====



===== FILE: App.js =====

import React, { useState, useEffect } from "react";
import { View } from "react-native";
import * as Font from "expo-font";
import { NavigationContainer } from "@react-navigation/native";
import { createNativeStackNavigator } from "@react-navigation/native-stack";
import StartScreen from "./screens/StartScreen";
import RegistrationScreen from "./screens/RegistrationScreen";
import EntryScreen from "./screens/EntryScreen";
import HomeScreen from "./screens/HomeScreen";
import LibraryScreen from "./screens/LibraryScreen";
import ChatsScreen from "./screens/ChatsScreen";
import CorrespondenceScreen from "./screens/CorrespondenceScreen";
import AccountScreen from "./screens/AccountScreen";
import BookScreen from "./screens/BookScreen";
import AddBookModal from "./components/Add_book_modal";
import AddBookManualScreen from "./screens/AddBookManualScreen";
import BookSearchScreen from "./screens/BookSearchScreen";

const Stack = createNativeStackNavigator();

export default function App() {
  const [fontsLoaded, setFontsLoaded] = useState(false);

  useEffect(() => {
    async function loadFonts() {
      await Font.loadAsync({
        "Marck Script-Regular": require("./assets/fonts/MarckScript-Regular.ttf"),
        "Inter-Regular": require("./assets/fonts/Inter-Regular.otf"),
        "Inter-Medium": require("./assets/fonts/Inter-Medium.otf"),
        "VollkornSC-Regular": require("./assets/fonts/VollkornSC-Regular.ttf"),
        "VollkornSC-Bold": require("./assets/fonts/VollkornSC-Bold.ttf"),
        "KoPub-Batang-Regular": require("./assets/fonts/kopubbatang-regular.ttf"),
      });
      setFontsLoaded(true);
    }
    loadFonts();
  }, []);

  if (!fontsLoaded) {
    return null;
  }

  return (
    <NavigationContainer>
      <Stack.Navigator screenOptions={{ headerShown: false }}>
        <Stack.Screen
          name="Start"
          component={StartScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Registration"
          component={RegistrationScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Entry"
          component={EntryScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Home"
          component={HomeScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Library"
          component={LibraryScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="AddBookModal"
          component={AddBookModal}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Book"
          component={BookScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="BookManualAdd"
          component={AddBookManualScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="BookSearch"
          component={BookSearchScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Chats"
          component={ChatsScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Сorrespondence"
          component={CorrespondenceScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Account"
          component={AccountScreen}
          options={{ animation: "none" }} />
      </Stack.Navigator>
    </NavigationContainer>
  );
}


===== FILE: app.json =====

{
  "expo": {
    "name": "mobile-OwlReads",
    "slug": "mobile-OwlReads",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "userInterfaceStyle": "light",
    "newArchEnabled": true,
    "splash": {
      "image": "./assets/splash-icon.png",
      "resizeMode": "contain",
      "backgroundColor": "#ffffff"
    },
    "ios": {
      "supportsTablet": true
    },
    "android": {
      "adaptiveIcon": {
        "foregroundImage": "./assets/adaptive-icon.png",
        "backgroundColor": "#ffffff"
      },
      "navigationBar": {
        "visible": true,
        "backgroundColor": "transparent",
        "barStyle": "light-content"
      },
      "androidStatusBar": {
        "backgroundColor": "transparent",
        "barStyle": "dark-content",
        "translucent": true
      },
      "edgeToEdgeEnabled": true,
      "softwareKeyboardLayoutMode": "resize",
      "package": "com.dianamalinetskaya.mobileOwlReads"
    },
    "web": {
      "favicon": "./assets/favicon.png"
    },
    "plugins": [
      "expo-font"
    ],
    "extra": {
      "eas": {
        "projectId": "b0271684-56b9-4608-9f7a-6b403c4e316a"
      }
    }
  }
}

===== FILE: eas.json =====

{
  "cli": {
    "version": ">= 16.28.0",
    "appVersionSource": "remote"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal"
    },
    "preview": {
      "distribution": "internal"
    },
    "production": {
      "autoIncrement": true
    }
  },
  "submit": {
    "production": {}
  }
}


===== FILE: index.js =====

import { registerRootComponent } from 'expo';

import App from './App';

// registerRootComponent calls AppRegistry.registerComponent('main', () => App);
// It also ensures that whether you load the app in Expo Go or in a native build,
// the environment is set up appropriately
registerRootComponent(App);


===== FILE: package.json =====

{
  "name": "mobile-owlreads",
  "license": "0BSD",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "expo start",
    "android": "expo start --android",
    "ios": "expo start --ios",
    "web": "expo start --web"
  },
  "dependencies": {
    "@react-native-async-storage/async-storage": "2.2.0",
    "@react-navigation/bottom-tabs": "^7.8.11",
    "@react-navigation/native": "^7.1.24",
    "@react-navigation/native-stack": "^7.8.5",
    "axios": "^1.13.2",
    "expo": "~54.0.29",
    "expo-font": "~14.0.10",
    "expo-image-picker": "~17.0.10",
    "expo-linear-gradient": "~15.0.8",
    "expo-navigation-bar": "~5.0.10",
    "expo-status-bar": "~3.0.9",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-native": "0.81.5",
    "react-native-keyboard-aware-scroll-view": "^0.9.5",
    "react-native-linear-gradient": "^2.8.3",
    "react-native-safe-area-context": "~5.6.0",
    "react-native-screens": "~4.16.0",
    "styled-components": "^6.1.19"
  },
  "private": true
}


===== FILE: components\Add_book_modal.js =====

// components/AddBookModal.js
import React, { useEffect } from "react";
import { Modal, TouchableWithoutFeedback, Platform, View } from "react-native";
import { useNavigation } from "@react-navigation/native"; // <--- 1. Импорт хука
import styled from "styled-components/native";
import * as NavigationBar from 'expo-navigation-bar';
import RedButton from "./Red_button";

// Фон (Overlay)
const Overlay = styled.View`
  flex: 1;
  background-color: rgba(47, 32, 23, 0.6);
  justify-content: center;
  align-items: center;
`;

// Карточка меню
const MenuContainer = styled.View`
  background-color: #FDF5E2;
  width: 90%;
  border-radius: 20px;
  padding-vertical: 30px;
  padding-horizontal: 12px; 
  align-items: center;
  gap: 15px;
  elevation: 10;
  shadow-color: #000;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;
`;

const MenuTitle = styled.Text`
  font-family: "VollkornSC-Regular";
  font-size: 24px;
  color: #890524;
  margin-bottom: 10px;
  text-align: center;
`;

export default function AddBookModal({ visible, onClose, onSearch }) {
  const navigation = useNavigation(); // <--- 2. Получаем объект навигации

  // Логика для затемнения нижнего бара Android
  useEffect(() => {
    if (Platform.OS === 'android') {
      if (visible) {
        NavigationBar.setBackgroundColorAsync("rgba(47, 32, 23, 0.6)");
      } else {
        NavigationBar.setBackgroundColorAsync("#D7C1AB");
      }
    }
  }, [visible]);

  return (
    <Modal
      animationType="fade"
      transparent={true}
      visible={visible}
      onRequestClose={onClose}
      statusBarTranslucent={true}
    >
      <TouchableWithoutFeedback onPress={onClose}>
        <Overlay>
          <TouchableWithoutFeedback>
            <MenuContainer>
              <MenuTitle>Добавить книгу</MenuTitle>

              <RedButton
                name="Найти книгу"
                onPress={() => {
                  onClose();
                  navigation.navigate("BookSearch"); // Убедись, что имя совпадает с App.js
                }}
              />

              <RedButton
                name="Добавить вручную"
                onPress={() => {
                  onClose(); // Сначала закрываем меню
                  navigation.navigate("BookManualAdd"); // Потом переходим
                }}
              />

            </MenuContainer>
          </TouchableWithoutFeedback>
        </Overlay>
      </TouchableWithoutFeedback>
    </Modal>
  );
}

===== FILE: components\Add_new_chat.js =====

// components/Chat_item.js
import React from "react";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { TouchableOpacity, View, Image } from "react-native";

const ChatContainer = styled.View`
  flex-direction: row;
  align-items: center;
  border: 2px solid #a28c75;
  padding: 12px;
  /* убираем margin-vertical */
  margin-vertical: 0px;
`;

const ChatIconWrapper = styled.View`
  width: 70px;
  height: 70px;
  border-radius: 50px;
  background-color: #a28c75;
  justify-content: center;
  align-items: center;
`;

const ChatImage = styled.Image`
  width: 75%;
  height: 75%;
`;

const ChatTextWrapper = styled.View`
  flex-direction: column;
  margin-left: 12px;
  
`;

const ChatTitle = styled.Text`
  font-family: "Inter-Regular";
  font-size: 17px;
  color: #FDF5E2;
  margin-bottom: 7px;
`;


export default function AddNewChatItem() {
  const navigation = useNavigation();
  return (
    <TouchableOpacity onPress={() => navigation.navigate("Сorrespondence")}>
      <ChatContainer>

        <ChatIconWrapper>
          <ChatImage source={require("../assets/add_new_chat_icon.png")} />
        </ChatIconWrapper>

        <ChatTextWrapper>
          <ChatTitle>Начать новую беседу</ChatTitle>
        </ChatTextWrapper>

      </ChatContainer>
    </TouchableOpacity>
  );
}


===== FILE: components\Background_paper.js =====

import React from "react";
import styled from "styled-components/native";

const BackgroundPaper = styled.View`
  flex: 1;
  background-color: #fdf5e2;
  border-top-left-radius: 40px;
  border-top-right-radius: 40px;
  border-width: 2px;
  border-color: #6c5141;
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 300px;
`;

export default BackgroundPaper;


===== FILE: components\Book_card.js =====

// components/Book_card.js
import React from 'react';
import styled from 'styled-components/native';
import { TouchableOpacity, View } from 'react-native';
import { TextBox } from './TextBox_props';
import RatingStars from './Rating_starts';

const CardContainer = styled(TouchableOpacity)`
  flex-direction: row;
  align-items: center;
  margin-horizontal: 12px;
  border-radius: 20px;
  background-color: rgba(253, 245, 226);
  padding: 12px;
  shadow-color: #A28C75;
  shadow-offset: 1px 2px;
  shadow-opacity: 0.8;
  shadow-radius: 4px;
  margin-bottom: 10px; 
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
`;

const CoverImage = styled.Image`
  height: ${({ height }) => height || 160}px;
  width: ${({ width }) => width || 110}px;
  border-radius: 7px;
`;

const InfoBlock = styled.View`
  flex: 1;
  flex-direction: column;
  margin-left: 10px;
  justify-content: flex-start;
`;

const TitleText = styled.Text`
  font-family: VollkornSC-Regular;
  font-size: 15px;
  color: #890524;
  margin-top: 6px;
`;

const AuthorText = styled.Text`
  font-family: Regular;
  font-size: 13px;
  color: #2F2017;
  margin-top: 4px;
`;

export const BookCard = ({
  cover,
  category,
  categorycolor,
  title,
  author,
  rating,
  onPress,
}) => {
  return (
    <CardContainer onPress={onPress}>
      <CoverImage source={cover} resizeMode="cover" />
      <InfoBlock>
        <View style={{ alignSelf: 'flex-end' }}>
          <TextBox text={category} color={categorycolor}/>
        </View>
       
        <TitleText>{title}</TitleText>
        <AuthorText>{author}</AuthorText>
        <RatingStars
          rating={rating}
          size={40}
          filledImage={require('../assets/star_filled.png')}
          emptyImage={require('../assets/star_empty.png')}
        />
      </InfoBlock>
    </CardContainer>
  );
};


===== FILE: components\Chat_item.js =====

// components/Chat_item.js
import React from "react";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { TouchableOpacity, View, Image } from "react-native";

const ChatContainer = styled.View`
  flex-direction: row;
  align-items: center;
  border-bottom-width: 2px;
  border-color: #a28c75;
  padding: 12px;
`;


const ChatIconWrapper = styled.View`
  width: 70px;
  height: 70px;
  border-radius: 50px;
  background-color: #a28c75;
  justify-content: center;
  align-items: center;
`;

const ChatImage = styled.Image`
  width: 75%;
  height: 75%;
`;

const ChatTextWrapper = styled.View`
  flex-direction: column;
  margin-left: 12px;
`;

const ChatTitle = styled.Text`
  font-family: "Inter-Regular";
  font-size: 17px;
  color: #FDF5E2;
  margin-bottom: 7px;
`;

const ChatMessage = styled.Text`
  font-family: "Inter-Regular";
  font-size: 12px;
  color: #2F2017;
`;

export default function ChatItem({ title, message }) {
  const navigation = useNavigation();
  return (
    <TouchableOpacity onPress={() => navigation.navigate("Сorrespondence", { title })}>
      <ChatContainer>

        <ChatIconWrapper>
          <ChatImage source={require("../assets/Owl_icon.png")} />
        </ChatIconWrapper>

        <ChatTextWrapper>
          <ChatTitle>{title}</ChatTitle>
          <ChatMessage>{message}</ChatMessage>
        </ChatTextWrapper>

      </ChatContainer>
    </TouchableOpacity>
  );
}


===== FILE: components\Input_field.js =====

import React from 'react';
import styled from 'styled-components/native';

const Wrapper = styled.View`
  margin-horizontal: 32px;
  width: 100%;
`;

const Container = styled.View`
  background-color: #E8DFC9;
  border-radius: 14px;
  padding-horizontal: 14px;
  padding-vertical: 7px;
`;

const StyledInput = styled.TextInput`
  font-family: Inter-Regular;
  font-size: 15px;
  color: #2F2017;
  width: 100%; /* Чтобы текст занимал всю ширину контейнера */
`;

const ErrorText = styled.Text`
  margin-top: 5px;
  color: #890524;
  font-family: Inter-Regular;
  font-size: 12px;
`;

const InputField = ({ 
  value, 
  onChangeText, 
  placeholder, 
  error, 
  style,
  ...props // <--- 1. Собираем все остальные пропсы (onSubmitEditing, keyboardType и т.д.)
}) => {
  return (
    <Wrapper style={style}>
      <Container>
        <StyledInput
          value={value}
          onChangeText={onChangeText}
          placeholder={placeholder}
          placeholderTextColor="rgba(47, 32, 23, 0.3)"
          {...props} // <--- 2. Передаем их в TextInput
        />
      </Container>
      {error ? <ErrorText>{error}</ErrorText> : null}
    </Wrapper>
  );
};

export default InputField;

===== FILE: components\Navigation_bar.js =====

// components/Navigation_bar.js
import React from "react";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { TouchableOpacity, View, Image } from "react-native";

const NavigationContainer = styled.View`
  background-color: #fdf5e2;
  border-radius: 20px;
  padding-top: 7px;
  padding-bottom: 7px;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  width: auto;
  margin-left: 16px;
  margin-right: 16px;
  padding-left: 30px;
  padding-right: 30px;

  position: absolute;
  bottom: 57px;
  left: 0;
  right: 0;
`;

export default function NavigationBar({ icons, onPressOverride }) {
  const navigation = useNavigation();

  return (
    <NavigationContainer>
      {icons.map((icon, index) => (
        <TouchableOpacity
          key={index}
          onPress={() => {
            if (onPressOverride) {
              onPressOverride(icon.screen);
            } else {
              navigation.navigate(icon.screen);
            }
          }}
        >

          <Image
            source={icon.source}
            style={{
              width: icon.name === "add_book" ? 55 : 45,
              height: icon.name === "add_book" ? 55 : 45,
            }}
          />
        </TouchableOpacity>
      ))}
    </NavigationContainer>
  );
}


===== FILE: components\Note_block.js =====

// components/NoteBlock.js
import React from "react";
import { View, TouchableOpacity, Image } from "react-native";
import styled from "styled-components/native";

const BlockContainer = styled.View`
  margin-horizontal: 20px;
  margin-bottom: 10px;
  border-radius: 20px;
  border-width: 2px;
  border-color: #a28c75;
  padding-horizontal: 10px;
  padding-vertical: 15px;
  background-color: #fdf5e2;
`;

const HeaderRow = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
`;

const TitleText = styled.Text`
  font-family: "Inter-Bold";
  font-size: 12px;
  color: #2F2017;
`;

const NoteText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
  margin-top: 10px;
`;

export default function NoteBlock({ text, onEdit, onDelete }) {
  return (
    <BlockContainer>
      <HeaderRow>
        <TitleText>Заметка</TitleText>
        <View style={{ flexDirection: "row", gap: 12 }}>
          <TouchableOpacity onPress={onDelete}>
            <Image source={require("../assets/trash.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
          <TouchableOpacity onPress={onEdit}>
            <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
        </View>
      </HeaderRow>

      <NoteText>{text}</NoteText>
    </BlockContainer>
  );
}


===== FILE: components\Popular_quote.js =====

// components/Popular_quote.js
import React from "react";
import styled from "styled-components/native";

const QuoteContainer = styled.View`
  background-color: #fdf5e2;
  border-radius: 20px;
  padding: 15px;
  flex-direction: column;
  justify-content: center;
  gap: 10px;
  width: auto;
  margin-left: 16px;
  margin-right: 16px;
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
`;

const QuoteText = styled.Text`
  color: #2f2017;
  font-family: "Inter-Regular";
  font-size: 15px;
  font-weight: 400;
  text-align: center;
  align-self: stretch;
`;

const QuoteAuthor = styled.Text`
  color: #890524;
  font-family: "Inter-Regular";
  font-size: 13px;
  font-weight: 400;
  text-align: right;
  align-self: stretch;
`;

export default function Quote({ quote_text, quote_author }) {
  return (
    <QuoteContainer>
      <QuoteText>{quote_text}</QuoteText>
      <QuoteAuthor>{quote_author}</QuoteAuthor>
    </QuoteContainer>
  );
}


===== FILE: components\Quote_block.js =====

// components/QuoteBlock.js
import React from "react";
import { View, TouchableOpacity, Image } from "react-native";
import styled from "styled-components/native";

const BlockContainer = styled.View`
  margin-horizontal: 20px;
  margin-bottom: 10px;
  border-radius: 20px;
  border-width: 2px;
  border-color: #a28c75;
  padding-horizontal: 10px;
  padding-vertical: 15px;
  background-color: #fdf5e2;
`;

const HeaderRow = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
`;

const TitleText = styled.Text`
  font-family: "Inter-Bold";
  font-size: 12px;
  color: #2F2017;
`;

const QuoteText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
  margin-top: 10px;
`;

const AuthorText = styled.Text`
  font-family: "Inter-Italic";
  font-size: 13px;
  color: #890524;
  text-align: right;
  margin-top: 6px;
`;

export default function QuoteBlock({ text, author, onEdit, onDelete }) {
  return (
    <BlockContainer>
      <HeaderRow>
        <TitleText>Цитата</TitleText>
        <View style={{ flexDirection: "row", gap: 12 }}>
          <TouchableOpacity onPress={onDelete}>
            <Image source={require("../assets/trash.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
          <TouchableOpacity onPress={onEdit}>
            <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
        </View>
      </HeaderRow>

      <QuoteText>{`« ${text} »`}</QuoteText>
      <AuthorText>@{author}</AuthorText>
    </BlockContainer>
  );
}


===== FILE: components\Rating_starts.js =====

// components/Rating_star.js
import React from 'react';
import styled from 'styled-components/native';
import { TouchableOpacity } from 'react-native';

const StarsRow = styled.View`
  flex-direction: row;
  align-items: center;
`;

const StarImage = styled.Image`
  width: ${({ size }) => size}px;
  height: ${({ size }) => size}px;
  margin: 0 2px;
`;

const RatingStars = ({ 
  rating = 0, 
  size = 40, 
  filledImage, 
  emptyImage,
  onRate
}) => {
  const stars = Array.from({ length: 5 }, (_, i) => i);

  return (
    <StarsRow>
      {stars.map((_, index) => {
        const isFilled = index < rating;
        return (
          <TouchableOpacity key={index} onPress={() => onRate && onRate(index + 1)}>
            <StarImage
              source={isFilled ? filledImage : emptyImage}
              size={size}
            />
          </TouchableOpacity>
        );
      })}
    </StarsRow>
  );
};

export default RatingStars;


===== FILE: components\Red_button.js =====

import React from "react";
import { TouchableOpacity } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { LinearGradient } from "expo-linear-gradient";

const GradientWrapper = styled(LinearGradient)`
  border-radius: 14px;
  margin-horizontal: 32px;
  
  shadow-color: #000;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
  width: 100%;
`;

const ButtonContainer = styled(TouchableOpacity)`
  
  padding-vertical: 20px;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  justify-content: center;
  gap: 10px;
  width: 100%;
`;

const ButtonText = styled.Text`
  color: #FDF5E2;
  font-family: "Inter-Regular";
  font-size: 15px;
  text-align: center;
`;

export default function RedButton({ screen, name, onPress, params }) {
  const navigation = useNavigation();

  const handlePress = () => {
    if (onPress) {
      onPress(); // локальная логика (например setStep)
    } else if (screen) {
      navigation.navigate(screen, params); // переход по навигации
    }
  };

  return (
    <GradientWrapper
      colors={["#890524", "#230109"]}
      locations={[0.17, 1]}
      start={{ x: 0.5, y: 0 }}
      end={{ x: 0.5, y: 1 }}
    >
      <ButtonContainer onPress={handlePress}>
        <ButtonText>{name}</ButtonText>
      </ButtonContainer>
    </GradientWrapper>
  );
}


===== FILE: components\Reply_message_bubble.js =====

import React from "react";
import styled from "styled-components/native";

const BubbleWrapper = styled.View`
  background-color: #FDF5E2;
  padding-horizontal: 15px;
  padding-top: 7px;
  padding-bottom: 4px;
  margin: 6px 12px;
  max-width: 80%;
  align-self: flex-start;

  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  border-bottom-left-radius: 2px;
  border-bottom-right-radius: 20px;
`;

const MessageText = styled.Text`
  color: #2F2017;
  font-family: "Inter-Regular";
  font-size: 15px;
`;

const TimeText = styled.Text`
  color: #A28C75;
  font-family: "Inter-Regular";
  font-size: 12px;
  text-align: right;
`;

export default function ReplyMessageBubble({ text, time }) {
  return (
    <BubbleWrapper>
      <MessageText>{text}</MessageText>
      <TimeText>{time}</TimeText>
    </BubbleWrapper>
  );
}


===== FILE: components\Tab_bar.js =====

// components/Tab_bar.js
import React from 'react';
import styled from 'styled-components/native';

const Container = styled.View`
  height: 48px;
  width: 100%;
  position: absolute;
  bottom: 0px;
`;

export const TabBar = ({color}) => {
  return (
    <Container 
      style={{ backgroundColor: color }}
    />
  );
};



===== FILE: components\TextBox_category.js =====

// components/TextBoxCategory.js
import React from "react";
import styled from "styled-components/native";
import { Image, View } from "react-native";

const hexToRgba = (hex, alpha) => {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
};

const Container = styled.View`
  flex-direction: row;
  align-items: center;
  padding-vertical: 10px;
  padding-horizontal: 15px;
  border-radius: 20px;
  align-self: flex-start;
`;

const StyledText = styled.Text`
  font-family: Inter-Regular;
  font-size: 15px;
  opacity: 1;
  flex: 1;
`;

export const TextBoxCategory = ({ text, color }) => {
  return (
    <Container style={{ backgroundColor: hexToRgba(color, 0.2) }}>
      <StyledText style={{ color }}>{text}</StyledText>
      <Image
        source={require("../assets/chevron_down.png")}
        style={{ width: 24, height: 24 }}
        resizeMode="contain"
      />
    </Container>
  );
};


===== FILE: components\TextBox_props.js =====

// components/TextBow_props.js
import React from 'react';
import styled from 'styled-components/native';

const hexToRgba = (hex, alpha) => {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
};

const Container = styled.View`
  padding-vertical: 5px;
  padding-horizontal: 15px;
  border-radius: 20px;
  align-self: flex-start;
`;

const StyledText = styled.Text`
  font-family: Inter-Regular;
  font-size: 12px;
  opacity: 1;
`;

export const TextBox = ({ text, color }) => {
  return (
    <Container style={{ backgroundColor: hexToRgba(color, 0.2) }}>
      <StyledText style={{ color }}>{text}</StyledText>
    </Container>
  );
};



===== FILE: components\User_message_bubble.js =====

import React from "react";
import styled from "styled-components/native";
import { LinearGradient } from "expo-linear-gradient";

const BubbleWrapper = styled(LinearGradient)`
  padding-horizontal: 15px;
  padding-top: 7px;
  padding-bottom: 4px;
  margin: 6px 12px;
  max-width: 80%;
  align-self: flex-end;

  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  border-bottom-left-radius: 20px;
  border-bottom-right-radius: 2px;
`;

const MessageText = styled.Text`
  color: #FDF5E2;
  font-family: "Inter-Regular";
  font-size: 15px;
`;

const TimeText = styled.Text`
  color: #A28C75;
  font-family: "Inter-Regular";
  font-size: 12px;
  text-align: right;
`;

export default function UserMessageBubble({ text, time }) {
  return (
    <BubbleWrapper
      colors={["#890524", "#230109"]}
      locations={[0.17, 1]}
      start={{ x: 0.5, y: 0 }}
      end={{ x: 0.5, y: 1 }}
    >
      <MessageText>{text}</MessageText>
      <TimeText>{time}</TimeText>
    </BubbleWrapper>
  );
}


===== FILE: screens\AccountScreen.js =====

import React, { useState, useCallback } from "react";
import { View, Image, ScrollView, TouchableOpacity, TouchableWithoutFeedback, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useFocusEffect } from "@react-navigation/native";
import AsyncStorage from '@react-native-async-storage/async-storage';

// Импорты компонентов
import NavigationBar from "../components/Navigation_bar";
import { TabBar } from "../components/Tab_bar";
import AddBookModal from "../components/Add_book_modal"; 
import api from "../src/api/client";

// --- STYLED COMPONENTS (Без изменений) ---
const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  justify-content: center;
  align-items: center;
  text-align: center;
  margin-top: 48px;
`;

const UserContainer = styled.View`
  flex-direction: column;
  align-items: center;
  position: relative;
`;

const MoreButton = styled(TouchableOpacity)`
  align-self: flex-end;
`;

const MenuContainer = styled.View`
  position: absolute;
  top: 40px;
  right: 0px;
  background-color: #fdf5e2;
  border-radius: 8px;
  padding-vertical: 5px;
  padding-left: 15px;
  padding-right: 40px;
  elevation: 6;
  z-index: 10; 
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;
`;

const MenuItem = styled(TouchableOpacity)`
  padding-vertical: 8px;
`;

const MenuText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
`;

const MenuTextLogout = styled(MenuText)`
  color: #890524;
`;

const UserName = styled.Text`
  align-items: center;
  color: #890524;
  display: flex;
  font-family: "VollkornSC-Bold";
  font-size: 25px;
  justify-content: center;
  position: relative;
  text-align: center;
  margin-top: -10px;
`;

const UserEmail = styled.Text`
  align-items: center;
  align-self: stretch;
  color: #2F2017;
  display: flex;
  font-family: "Inter-Regular";
  font-size: 12px;
  justify-content: center;
  text-align: center;
`;

const StatsContainer = styled.View`
  flex-direction: row;
  justify-content: space-around;
  padding-horizontal: 12px;
  gap: 30px;
`;

const StatItem = styled.View`
  flex-direction: column;
  align-items: center;
`;

const StatLabel = styled.Text`
  font-family: "Inter-Medium";
  font-size: 15px;
  color: #2F2017;
  text-align: center;
`;

const StatValue = styled.Text`
  font-family: "VollkornSC-Regular";
  font-size: 20px;
  color: #2F2017;
  text-align: center;
  margin-top: 4px;
`;

const TextLabel = styled.Text`
  font-family: "Inter-Medium";
  font-size: 13px;
  color: #2F2017;
  text-align: center;
`;

const ContainerText = styled.View`
  align-items: center;
  justify-content: center;
  padding-vertical: 5px;
  padding-horizontal: 15px;
  border-radius: 20px;
  background-color: #A28C75;
`;

const StyledText = styled.Text`
  font-family: Inter-Regular;
  font-size: 15px;
  color: #FDF5E2;
`;

export default function AccountScreen() {
  const [menuVisible, setMenuVisible] = useState(false); // Меню профиля (три точки)
  const [isAddBookModalVisible, setAddBookModalVisible] = useState(false); // <--- 2. Состояние для меню добавления
  
  const [loading, setLoading] = useState(true);
  const navigation = useNavigation(); 

  const [userData, setUserData] = useState({
    username: "Загрузка...",
    email: "",
    profile_photo: null
  });

  const [userStats, setUserStats] = useState({
    books_in_library: 0,
    books_read: 0,
    books_favorites: 0,
    favorite_author: "-",
    favorite_genre: "-"
  });

  const icons = [
    { name: "home", source: require("../assets/home.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" }, // screen указывает на модалку
    { name: "message", source: require("../assets/message.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user_active.png"), screen: "Account" },
  ];

  // --- 3. Обработчик навигации (перехватчик) ---
  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setAddBookModalVisible(true); // Открываем меню добавления
    } else {
      navigation.navigate(screenName);
    }
  };

  // Заглушки для действий в меню добавления
  const handleSearchBook = () => {
    setAddBookModalVisible(false);
    console.log("Переход к поиску");
    // navigation.navigate("SearchBook");
  };

  const handleAddManual = () => {
    setAddBookModalVisible(false);
    console.log("Переход к добавлению");
    // navigation.navigate("AddBookManual");
  };

  const handleLogout = async () => {
    try {
      await AsyncStorage.removeItem('userToken');
      await AsyncStorage.removeItem('userId');
      setMenuVisible(false);
      navigation.reset({
        index: 0,
        routes: [{ name: 'Start' }],
      });
    } catch (e) {
      console.error("Ошибка выхода:", e);
    }
  };

  useFocusEffect(
    useCallback(() => {
      const loadData = async () => {
        setLoading(true);
        try {
          const userId = await AsyncStorage.getItem('userId');
          if (!userId) {
            navigation.navigate("Entry");
            return;
          }
          const [userResponse, statsResponse] = await Promise.all([
            api.get(`/api/users_personal_data/${userId}/`),
            api.get(`/api/users_statistics/user/${userId}`)
          ]);
          setUserData(userResponse.data);
          setUserStats(statsResponse.data);
        } catch (error) {
          console.error("Ошибка загрузки профиля:", error);
        } finally {
          setLoading(false);
        }
      };
      loadData();
    }, [])
  );

  if (loading) {
    return (
      <View style={{ flex: 1, backgroundColor: "#D7C1AB", justifyContent: "center", alignItems: "center" }}>
        <ActivityIndicator size="large" color="#890524" />
      </View>
    );
  }

  return (
    <TouchableWithoutFeedback onPress={() => menuVisible && setMenuVisible(false)}>
      <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
        <View style={{ flexDirection: "column" }}>
          <OwlReadsTitle>OwlReads</OwlReadsTitle>
        </View>

        <ScrollView contentContainerStyle={{ paddingHorizontal: 12, gap: 25 }}>
          <UserContainer>
            <MoreButton onPress={() => setMenuVisible(!menuVisible)}>
              <Image
                source={require("../assets/more.png")}
                style={{ width: 35, height: 35 }}
              />
            </MoreButton>

            {menuVisible && (
              <MenuContainer>
                <MenuItem onPress={() => { console.log("Настройка профиля"); setMenuVisible(false); }}>
                  <MenuText>Настройка профиля</MenuText>
                </MenuItem>
                 <MenuItem onPress={handleLogout}>
                  <MenuTextLogout>Выйти из аккаунта</MenuTextLogout>
                </MenuItem>
              </MenuContainer>
            )}

            <Image
              source={
                userData.profile_photo 
                  ? { uri: userData.profile_photo } 
                  : require("../assets/user_icon.png")
              }
              style={{ width: 150, height: 150, borderRadius: 75 }}
            />
          </UserContainer>

          <View style ={{gap: 20}}>
            <View>
              <UserName>{userData.username}</UserName>
              <UserEmail>{userData.email}</UserEmail>
            </View>

            <StatsContainer>
              <StatItem>
                <StatLabel>Всего книг</StatLabel>
                <StatValue>{userStats.books_in_library || 0}</StatValue>
              </StatItem>

              <StatItem>
                <StatLabel>Прочитано</StatLabel>
                <StatValue>{userStats.books_read || 0}</StatValue>
              </StatItem>

              <StatItem>
                <StatLabel>Любимых</StatLabel>
                <StatValue>{userStats.books_favorites || 0}</StatValue>
              </StatItem>
            </StatsContainer>
          </View>

          <View style={{gap: 10, alignItems: "center"}}>
            <TextLabel>Больше всего прочитано книг в жанре</TextLabel>
              <ContainerText>
                <StyledText>{userStats.favorite_genre || "-"}</StyledText>
              </ContainerText>
          </View>

          <View style={{gap: 10, alignItems: "center"}}>
            <TextLabel>Больше всего прочитано книг автора</TextLabel>
              <ContainerText>
                <StyledText>{userStats.favorite_author || "-"}</StyledText>
              </ContainerText>
          </View>
        
        </ScrollView>

        {/* 4. Передаем перехватчик в NavigationBar */}
        <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
        
        {/* 5. Скрываем TabBar, если открыто меню добавления */}
        {!isAddBookModalVisible && <TabBar color={"#D7C1AB"} />}

        {/* 6. Само модальное окно */}
        <AddBookModal 
          visible={isAddBookModalVisible}
          onClose={() => setAddBookModalVisible(false)}
          onSearch={handleSearchBook}
          onAdd={handleAddManual}
        />
      </View>
    </TouchableWithoutFeedback>
  );
}

===== FILE: screens\AddBookManualScreen.js =====

import React, { useState } from "react";
import { View, ScrollView, TouchableOpacity, Image, Text, Alert, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useRoute } from "@react-navigation/native";
import * as ImagePicker from 'expo-image-picker';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { SafeAreaView } from "react-native-safe-area-context";

// Импорт твоих компонентов
import InputField from "../components/Input_field";
import RedButton from "../components/Red_button";
import BackgroundPaper from "../components/Background_paper";
import api from "../src/api/client";

// --- СТИЛИ ---

const Header = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-horizontal: 16px;
  margin-bottom: 20px;
  padding-top: 10px;
`;

const OwlReadsTitle = styled.Text`
  color: #230109;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
`;

const CoverContainer = styled.TouchableOpacity`
  width: 140px;
  height: 200px;
  background-color: #E8DFC9;
  border-radius: 10px;
  align-self: center;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
  border-width: 1px;
  border-color: #890524;
  border-style: dashed;
  overflow: hidden;
`;

const CoverImage = styled.Image`
  width: 100%;
  height: 100%;
`;

const AddCoverText = styled.Text`
  font-family: "Inter-Regular";
  color: #890524;
  text-align: center;
  font-size: 14px;
  margin-top: 5px;
`;

const SectionTitle = styled.Text`
  font-family: "VollkornSC-Bold";
  font-size: 18px;
  color: #2F2017;
  margin-left: 32px;
  margin-bottom: 10px;
  margin-top: 10px;
`;

const CategoriesContainer = styled.ScrollView`
  padding-left: 32px;
  margin-bottom: 20px;
`;

const CategoryChip = styled.TouchableOpacity`
  padding-vertical: 8px;
  padding-horizontal: 16px;
  background-color: ${(props) => (props.selected ? "#890524" : "#E8DFC9")};
  border-radius: 20px;
  margin-right: 10px;
  border-width: 1px;
  border-color: ${(props) => (props.selected ? "#890524" : "transparent")};
`;

const CategoryText = styled.Text`
  font-family: "Inter-Medium";
  color: ${(props) => (props.selected ? "#FDF5E2" : "#2F2017")};
  font-size: 14px;
`;

const FormContainer = styled.View`
  gap: 15px;
  margin-bottom: 30px;
`;

// --- КОМПОНЕНТ ---

export default function AddBookManualScreen() {
  const navigation = useNavigation();
  const route = useRoute();
  const [loading, setLoading] = useState(false);

  // 1. Получаем данные, если пришли с экрана поиска
  const prefilledBook = route.params?.book;

  // 2. Инициализация состояний (если есть данные - подставляем, иначе пусто)
  const [title, setTitle] = useState(prefilledBook?.title || "");
  const [author, setAuthor] = useState(prefilledBook?.author || "");
  const [pages, setPages] = useState(prefilledBook?.pages ? String(prefilledBook.pages) : "");
  const [year, setYear] = useState(prefilledBook?.year ? String(prefilledBook.year) : "");
  const [language, setLanguage] = useState(prefilledBook?.language || "");
  const [description, setDescription] = useState(prefilledBook?.description || "");
  
  // Категории
  const categories = ["Читаю", "Хочу прочитать", "Прочитано", "Брошено", "Любимые"];
  const [selectedCategory, setSelectedCategory] = useState("");

  // Обложка
  const [coverUri, setCoverUri] = useState(prefilledBook?.cover || null);

  // Ошибки
  const [errors, setErrors] = useState({});

  // --- Выбор фото из галереи ---
  const pickImage = async () => {
    let result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [2, 3], // Пропорции книги
      quality: 0.5,
    });

    if (!result.canceled) {
      setCoverUri(result.assets[0].uri);
    }
  };

  // --- Сохранение книги ---
  const handleSave = async () => {
    let newErrors = {};
    let valid = true;

    // Валидация
    if (!title.trim()) {
      newErrors.title = "Введите название книги*";
      valid = false;
    }
    if (!author.trim()) {
      newErrors.author = "Введите автора*";
      valid = false;
    }
    if (!selectedCategory) {
      Alert.alert("Ошибка", "Пожалуйста, выберите категорию");
      valid = false;
    }

    setErrors(newErrors);
    if (!valid) return;

    setLoading(true);
    try {
      // Получаем ID пользователя
      const userId = await AsyncStorage.getItem('userId');
      if (!userId) {
        Alert.alert("Ошибка", "Пользователь не авторизован. Пожалуйста, войдите снова.");
        navigation.navigate("Entry");
        return;
      }

      // Подготовка данных для бэкенда
      const payload = {
        title: title,
        author: author,
        category_name: selectedCategory,
        pages: pages ? parseInt(pages) : null,
        year: year ? parseInt(year) : null,
        language: language,
        description: description,
        // Если ссылка внешняя (http) - отправляем. Если локальная (file://) - пока null.
        cover_url: coverUri && coverUri.startsWith('http') ? coverUri : null 
      };

      // Отправка запроса
      await api.post(`/api/users_book_review/manual?user_id=${userId}`, payload);

      Alert.alert("Успех", "Книга добавлена в вашу библиотеку!", [
        { text: "OK", onPress: () => navigation.navigate("Library") }
      ]);

    } catch (error) {
      console.error("Ошибка сохранения:", error);
      Alert.alert("Ошибка", "Не удалось сохранить книгу. Проверьте соединение.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      
      <SafeAreaView style={{ flex: 1 }}>
        {/* Хедер */}
        <Header>
          <TouchableOpacity onPress={() => navigation.goBack()} style={{ width: 35, height: 35 }}>
            <Image 
              source={require("../assets/chevron_left.png")} 
              style={{ width: 35, height: 35 }} 
              resizeMode="contain" 
            />
          </TouchableOpacity>

          <OwlReadsTitle>OwlReads</OwlReadsTitle>

          <TouchableOpacity onPress={() => {}} style={{ width: 35, height: 35 }}>
            <Image 
              source={require("../assets/more.png")} 
              style={{ width: 35, height: 35 }} 
              resizeMode="contain" 
            />
          </TouchableOpacity>
        </Header>

        <ScrollView contentContainerStyle={{ paddingBottom: 40 }}>
          
          {/* Обложка */}
          <CoverContainer onPress={pickImage}>
            {coverUri ? (
              <CoverImage source={{ uri: coverUri }} resizeMode="cover" />
            ) : (
              <View style={{ alignItems: 'center', gap: 5 }}>
                 <Image 
                   source={require("../assets/add_book.png")} 
                   style={{ width: 40, height: 40, tintColor: '#890524' }} 
                   resizeMode="contain"
                 />
                 <AddCoverText>Добавить{"\n"}обложку</AddCoverText>
              </View>
            )}
          </CoverContainer>

          {/* Обязательные поля */}
          <FormContainer>
            <InputField 
              placeholder="Название книги" 
              value={title} 
              onChangeText={(t) => {setTitle(t); setErrors(prev => ({...prev, title: ""}))}}
              error={errors.title}
              style={{ width: 'auto' }} // Фикс ширины
            />
            <InputField 
              placeholder="Автор" 
              value={author} 
              onChangeText={(t) => {setAuthor(t); setErrors(prev => ({...prev, author: ""}))}}
              error={errors.author}
              style={{ width: 'auto' }} // Фикс ширины
            />
          </FormContainer>

          {/* Категории */}
          <SectionTitle>Категория*</SectionTitle>
          <CategoriesContainer horizontal showsHorizontalScrollIndicator={false}>
            {categories.map((cat) => (
              <CategoryChip 
                key={cat} 
                selected={selectedCategory === cat} 
                onPress={() => setSelectedCategory(cat)}
              >
                <CategoryText selected={selectedCategory === cat}>{cat}</CategoryText>
              </CategoryChip>
            ))}
          </CategoriesContainer>

          {/* Дополнительные поля */}
          <SectionTitle>Дополнительно</SectionTitle>
          <FormContainer>
            <InputField 
              placeholder="Количество страниц" 
              value={pages} 
              onChangeText={setPages} 
              keyboardType="numeric"
              style={{ width: 'auto' }}
            />
            <InputField 
              placeholder="Год публикации" 
              value={year} 
              onChangeText={setYear} 
              keyboardType="numeric"
              style={{ width: 'auto' }}
            />
            <InputField 
              placeholder="Язык произведения" 
              value={language} 
              onChangeText={setLanguage} 
              style={{ width: 'auto' }}
            />
            <InputField 
              placeholder="Аннотация" 
              value={description} 
              onChangeText={setDescription} 
              style={{ width: 'auto' }}
              multiline={true}
            />
          </FormContainer>

          {/* Кнопка сохранения */}
          <View style={{ marginTop: 10 }}>
            {loading ? (
              <ActivityIndicator size="large" color="#890524" />
            ) : (
              <RedButton 
                name="Сохранить" 
                onPress={handleSave} 
                style={{ width: 'auto' }} // Фикс ширины
              />
            )}
          </View>

        </ScrollView>
      </SafeAreaView>
    </View>
  );
}

===== FILE: screens\BookScreen.js =====

import React, { useState, useCallback } from "react";
import { View, TouchableOpacity, Image, TouchableWithoutFeedback, ScrollView, TextInput, ActivityIndicator, Alert, Text } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useRoute, useFocusEffect } from "@react-navigation/native";

// Твой настроенный клиент API
import api from "../src/api/client";

import { TabBar } from "../components/Tab_bar";
import { TextBoxCategory } from "../components/TextBox_category";
import { TextBox } from "../components/TextBox_props";
import RedButton from "../components/Red_button";
import RatingStars from "../components/Rating_starts";
import QuoteBlock from "../components/Quote_block";
import NoteBlock from "../components/Note_block";

const OwlReadsTitle = styled.Text`
  color: #230109;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
`;

const MenuContainer = styled.View`
  position: absolute;
  top: 40px;
  right: 0px;
  background-color: #fdf5e2;
  border-radius: 8px;
  padding-vertical: 5px;
  padding-left: 15px;
  padding-right: 40px;
  elevation: 6;
  z-index: 10;
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;
`;

const MenuItem = styled(TouchableOpacity)`
  padding-vertical: 8px;
`;

const MenuTextDelete = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
`;

const ScreenTitle = styled.Text`
  color: #890524;
  font-family: "VollkornSC-Regular";
  font-size: 27px;
  text-align: center;
  margin-top: 20px;
`;

const CardContainer = styled.View`
  flex-direction: row;
  align-items: flex-start;
  margin-horizontal: 20px;
  border-radius: 20px;
  padding: 12px;
`;

const CoverImage = styled.Image`
  height: 160px;
  width: 110px;
  border-radius: 7px;
  background-color: #e0e0e0;
`;

const InfoBlock = styled.View`
  flex: 1;
  flex-direction: column;
  margin-left: 10px;
`;

const LabelText = styled.Text`
  font-family: Inter-SemiBold;
  font-size: 14px;
  color: #890524;
  margin-top: 6px;
`;

const ValueText = styled.Text`
  font-family: Inter-Regular;
  font-size: 15px;
  color: #2F2017;
  margin-top: 2px;
`;

const BlockReview = styled.View`
  margin-horizontal: 20px;
  margin-bottom: 20px;
  border-radius: 20px;
  border-width: 2px;
  border-color: #a28c75;
  padding-horizontal: 10px;
  padding-vertical: 15px;
`;

export default function BookScreen() {
  const navigation = useNavigation();
  const route = useRoute();

  const { reviewId } = route.params || {};

  const [loading, setLoading] = useState(true);
  const [bookData, setBookData] = useState(null);

  const [menuVisible, setMenuVisible] = useState(false);
  const [menuVisibleCategory, setMenuVisibleCategory] = useState(false);
  const [genres, setGenres] = useState([]);
  const [genreMenuVisible, setGenreMenuVisible] = useState(false);
  const [category, setCategory] = useState("Прочитано");

  const [quoteNoteMenuVisible, setQuoteNoteMenuVisible] = useState(false);
  const [newQuoteText, setNewQuoteText] = useState("");
  const [newQuoteAuthor, setNewQuoteAuthor] = useState("");
  const [newNoteText, setNewNoteText] = useState("");
  const [isQuoteMode, setIsQuoteMode] = useState(true);
  const [entries, setEntries] = useState([]);

  const [ratings, setRatings] = useState({
    Общая: 0,
    Персонажи: 0,
    Сюжет: 0,
    "Химия между персонажами": 0,
    Эмоциональность: 0,
    Концовка: 0,
    "Легкость чтения": 0,
  });
  const [ratingMenuVisible, setRatingMenuVisible] = useState(false);

  const ratingImages = {
    Общая: { filled: require("../assets/star_filled.png"), empty: require("../assets/star_empty.png") },
    Персонажи: { filled: require("../assets/diamond_filled.png"), empty: require("../assets/diamond_empty.png") },
    Сюжет: { filled: require("../assets/fire_filled.png"), empty: require("../assets/fire_empty.png") },
    "Химия между персонажами": { filled: require("../assets/heart_filled.png"), empty: require("../assets/heart_empty.png") },
    Эмоциональность: { filled: require("../assets/emoji_filled.png"), empty: require("../assets/emoji_empty.png") },
    Концовка: { filled: require("../assets/moon_filled.png"), empty: require("../assets/moon_empty.png") },
    "Легкость чтения": { filled: require("../assets/thunder_filled.png"), empty: require("../assets/thunder_empty.png") },
  };

  const fetchBookDetails = async () => {
    if (!reviewId) {
      setLoading(false);
      return;
    }

    try {
      setLoading(true);
      // Путь /api/users_book_review/{id}
      const response = await api.get(`/api/users_book_review/${reviewId}`);
      const data = response.data;

      setBookData(data);
      setCategory(data.category_name);

      if (data.genres) {
        setGenres(data.genres.map((g) => g.name));
      }

      if (data.rating) {
        setRatings({
          Общая: data.rating.total_rating || 0,
          Персонажи: data.rating.characters_rating || 0,
          Сюжет: data.rating.plot_rating || 0,
          "Химия между персонажами": data.rating.relations_rating || 0,
          Эмоциональность: data.rating.emotionality_rating || 0,
          Концовка: data.rating.ending_rating || 0,
          "Легкость чтения": data.rating.easy_reading_rating || 0,
        });
      }

      const mappedQuotes = data.quotes.map(q => ({ type: "quote", text: q.text, author: q.quote_author, id: q.id }));
      const mappedNotes = data.notes.map(n => ({ type: "note", text: n.text, id: n.id }));
      setEntries([...mappedQuotes, ...mappedNotes]);

    } catch (error) {
      console.error("Ошибка при загрузке книги:", error);
      Alert.alert("Ошибка", "Не удалось загрузить данные о книге");
    } finally {
      setLoading(false);
    }
  };

  useFocusEffect(
    useCallback(() => {
      fetchBookDetails();
    }, [reviewId])
  );

  const handleDeleteBook = async () => {
    try {
      await api.delete(`/api/users_book_review/reviews/${reviewId}/`);
      setMenuVisible(false);
      navigation.goBack();
    } catch (error) {
      console.error(error);
      Alert.alert("Ошибка", "Не удалось удалить книгу");
    }
  };

  const handleSelectCategory = async (newCategory) => {
    try {
      // 1. Сразу обновляем UI, чтобы пользователь не ждал (оптимистичное обновление)
      setCategory(newCategory);
      setMenuVisibleCategory(false);

      // 2. Отправляем запрос на сервер
      await api.patch(`/api/users_book_review/reviews/${reviewId}/category`, {
        category_name: newCategory
      });

      console.log("Категория успешно обновлена на сервере");

    } catch (error) {
      console.error("Ошибка обновления категории:", error);
      Alert.alert("Ошибка", "Не удалось обновить категорию");
      // Если ошибка, можно вернуть старое значение, но пока оставим так
    }
  };

  const handleSaveEntry = async () => {
    try {
      if (isQuoteMode) {
        if (newQuoteText.trim()) {
          await api.post(`/api/users_book_quotes/`, {
            text: newQuoteText,
            quote_author: newQuoteAuthor,
            review_id: reviewId
          });
          setNewQuoteText("");
          setNewQuoteAuthor("");
        }
      } else {
        if (newNoteText.trim()) {
          await api.post(`/api/users_book_notes/`, {
            text: newNoteText,
            review_id: reviewId
          });
          setNewNoteText("");
        }
      }
      setQuoteNoteMenuVisible(false);
      fetchBookDetails();
    } catch (error) {
      console.error("Ошибка сохранения:", error);
      Alert.alert("Ошибка", "Не удалось сохранить");
    }
  };

  const handleSaveRating = async () => {
    try {
      // Мы просто отправляем POST запрос.
      // Благодаря изменениям на бэкенде, он сам поймет:
      // если рейтинг уже есть -> обновит его,
      // если нет -> создаст новый.
      await api.post(`/api/users_book_rating/`, {
        review_id: reviewId,
        total_rating: ratings["Общая"],
        characters_rating: ratings["Персонажи"],
        plot_rating: ratings["Сюжет"],
        relations_rating: ratings["Химия между персонажами"],
        emotionality_rating: ratings["Эмоциональность"],
        ending_rating: ratings["Концовка"],
        easy_reading_rating: ratings["Легкость чтения"]
      });

      // Обновляем данные на экране, чтобы увидеть изменения
      await fetchBookDetails();

      setRatingMenuVisible(false);
      Alert.alert("Успех", "Рейтинг сохранен!");
    } catch (error) {
      console.error(error);
      Alert.alert("Ошибка", "Не удалось сохранить рейтинг");
    }
  };

  if (loading) {
    return (
      <View style={{ flex: 1, backgroundColor: "#fdf5e2", justifyContent: "center", alignItems: "center" }}>
        <ActivityIndicator size="large" color="#890524" />
      </View>
    );
  }

  return (
    <TouchableWithoutFeedback onPress={() => menuVisible && setMenuVisible(false)}>
      <View style={{ flex: 1, backgroundColor: "#fdf5e2" }}>
        <View style={{ flexDirection: "row", alignItems: "center", justifyContent: "space-between", marginTop: 48, marginHorizontal: 23, position: "relative" }}>
          <TouchableOpacity onPress={() => navigation.goBack()} style={{ width: 35, height: 35 }}>
            <Image source={require("../assets/chevron_left.png")} style={{ width: 35, height: 35 }} resizeMode="contain" />
          </TouchableOpacity>

          <OwlReadsTitle>OwlReads</OwlReadsTitle>

          <TouchableOpacity onPress={() => setMenuVisible(!menuVisible)} style={{ width: 35, height: 35 }}>
            <Image source={require("../assets/more.png")} style={{ width: 35, height: 35 }} resizeMode="contain" />
          </TouchableOpacity>

          {menuVisible && (
            <MenuContainer>
              <MenuItem onPress={handleDeleteBook}>
                <MenuTextDelete>Удалить книгу</MenuTextDelete>
              </MenuItem>
            </MenuContainer>
          )}
        </View>

        <ScrollView contentContainerStyle={{ paddingBottom: 50 }}>
          <ScreenTitle>Книжный отзыв</ScreenTitle>

          <CardContainer>
            {bookData?.cover_url ? (
              <CoverImage source={{ uri: bookData.cover_url }} resizeMode="cover" />
            ) : (
              <CoverImage source={require("../assets/cover.png")} resizeMode="cover" />
            )}

            <InfoBlock>
              <LabelText>Название</LabelText>
              <ValueText style={{ fontFamily: "Inter-Bold" }}>{bookData?.title || "Без названия"}</ValueText>

              <LabelText>Автор</LabelText>
              <ValueText>{bookData?.author || "Неизвестно"}</ValueText>

              <LabelText>Количество страниц</LabelText>
              <ValueText>{bookData?.pages || "-"}</ValueText>

              <LabelText>Год публикации</LabelText>
              <ValueText>{bookData?.year || "-"}</ValueText>
            </InfoBlock>
          </CardContainer>

          <BlockReview style={{ gap: 8 }}>
            <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Аннотация</ValueText>
            <ValueText>{bookData?.description || "Описание отсутствует."}</ValueText>
          </BlockReview>

          <View style={{ marginHorizontal: 20, marginBottom: 20, gap: 8 }}>
            <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Категория</ValueText>
            <TouchableOpacity onPress={() => setMenuVisibleCategory(!menuVisibleCategory)}>
              <TextBoxCategory text={category} color="#AB66FF" />
            </TouchableOpacity>

            {menuVisibleCategory && (
              <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, borderWidth: 2, borderColor: "#a28c75", paddingVertical: 5, paddingHorizontal: 10, gap: 6 }}>
                {["Прочитано", "Читаю", "Хочу прочитать", "Брошено", "Любимые"].map((item) => (
                  <TouchableOpacity key={item} onPress={() => handleSelectCategory(item)}>
                    <ValueText>{item}</ValueText>
                  </TouchableOpacity>
                ))}
              </View>
            )}
          </View>

          <BlockReview>
            <TouchableOpacity style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }} onPress={() => setGenreMenuVisible(true)}>
              <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Жанры</ValueText>
              <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} resizeMode="contain" />
            </TouchableOpacity>

            <View style={{ flexDirection: "row", flexWrap: "wrap", gap: 8, marginTop: 10 }}>
              {genres.length > 0 ? (
                genres.map((g) => <TextBox key={g} text={g} color="#890524" />)
              ) : (
                <ValueText style={{ color: '#999', fontSize: 13 }}>Жанры не выбраны</ValueText>
              )}
            </View>
          </BlockReview>

          <BlockReview>
            <TouchableOpacity style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }} onPress={() => setRatingMenuVisible(true)}>
              <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Оценка</ValueText>
              <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} resizeMode="contain" />
            </TouchableOpacity>

            <View style={{ marginTop: 10, gap: 10 }}>
              <View style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }}>
                <ValueText>Общая</ValueText>
                <RatingStars rating={ratings["Общая"]} size={40} filledImage={require("../assets/star_filled.png")} emptyImage={require("../assets/star_empty.png")} />
              </View>
              {Object.entries(ratings).map(([key, value]) => {
                if (key === "Общая" || value === 0) return null;
                return (
                  <View key={key} style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }}>
                    <ValueText style={{ flexShrink: 1, flexWrap: "wrap", fontSize: 12 }}>{key}</ValueText>
                    <RatingStars rating={value} size={35} filledImage={ratingImages[key].filled} emptyImage={ratingImages[key].empty} />
                  </View>
                );
              })}
            </View>
          </BlockReview>

          <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12, textAlign: "center", marginVertical: 10 }}>Цитаты / Заметки</ValueText>

          <BlockReview style={{ paddingVertical: 12 }}>
            <TouchableOpacity style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }} onPress={() => { setIsQuoteMode(true); setQuoteNoteMenuVisible(true); }}>
              <ValueText style={{ fontSize: 13 }}>Добавить цитату / заметку</ValueText>
              <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} resizeMode="contain" />
            </TouchableOpacity>
          </BlockReview>

          {entries.map((entry, index) => {
            if (entry.type === "quote") {
              return (
                <QuoteBlock
                  key={`quote-${entry.id || index}`}
                  text={entry.text}
                  author={entry.author}
                  onEdit={() => console.log("Редактировать цитату", entry.id)}
                  onDelete={async () => {
                    try {
                      // Удаляем с сервера
                      await api.delete(`/api/users_book_quotes/${entry.id}/`);
                      // Удаляем из локального стейта
                      setEntries(entries.filter((_, i) => i !== index));
                    } catch (error) {
                      console.error("Ошибка удаления цитаты:", error);
                      Alert.alert("Ошибка", "Не удалось удалить цитату");
                    }
                  }}
                />
              );
            }
            if (entry.type === "note") {
              return (
                <NoteBlock
                  key={`note-${entry.id || index}`}
                  text={entry.text}
                  onEdit={() => console.log("Редактировать заметку", entry.id)}
                  onDelete={async () => {
                    try {
                      // Удаляем с сервера
                      await api.delete(`/api/users_book_notes/${entry.id}/`);
                      // Удаляем из локального стейта
                      setEntries(entries.filter((_, i) => i !== index));
                    } catch (error) {
                      console.error("Ошибка удаления заметки:", error);
                      Alert.alert("Ошибка", "Не удалось удалить заметку");
                    }
                  }}
                />
              );
            }
            return null;
          })}
        </ScrollView>

        {/* --- Модалка жанров --- */}
        {genreMenuVisible && (
          <View style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, backgroundColor: "rgba(0,0,0,0.5)", justifyContent: "center", alignItems: "center", padding: 20 }}>
            <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, padding: 20, width: "100%", maxHeight: "70%" }}>
              <ScrollView>
                {["Young adult", "Античная литература", "Белорусская литература", "Биография, мемуары", "Бизнес-книги", "Боевик", "Детектив", "Детская литература", "Журнал, газета, статья", "Зарубежная литература", "Здоровье, медицина", "Историческая литература", "Комедия", "Комикс, манга, манхва, вебтун", "Культура, искусство", "Мифы, легенды, эпос", "На иностранном языке", "Научно-популярная литература", "Научная фантастика", "Нон-фикшн", "Приключения", "Психология", "Пьеса", "Религия", "Роман", "Русская классика", "Стихи, поэзия", "Техническая литература", "Триллер", "Ужасы, мистика", "Учебная литература", "Фантастика", "Философия", "Фэнтези", "Энциклопедия, справочник", "18+"].map((item) => (
                  <TouchableOpacity key={item} onPress={() => genres.includes(item) ? setGenres(genres.filter((g) => g !== item)) : setGenres([...genres, item])} style={{ paddingVertical: 8 }}>
                    <ValueText style={{ color: genres.includes(item) ? "#890524" : "#2F2017", fontFamily: genres.includes(item) ? "Inter-Bold" : "Inter-Regular" }}>{item}</ValueText>
                  </TouchableOpacity>
                ))}
              </ScrollView>
            </View>
            <RedButton
              name="Сохранить"
              onPress={async () => {
                try {
                  // Отправляем массив выбранных жанров на сервер
                  await api.put(`/api/users_book_review/reviews/${reviewId}/genres`, {
                    genres: genres // массив строк ["Фэнтези", "Детектив"]
                  });

                  setGenreMenuVisible(false);
                  Alert.alert("Успех", "Жанры обновлены!");

                  // Обновляем данные на экране (чтобы убедиться, что всё сохранилось)
                  fetchBookDetails();

                } catch (error) {
                  console.error("Ошибка обновления жанров:", error);
                  Alert.alert("Ошибка", "Не удалось сохранить жанры");
                }
              }}
            />
          </View>
        )}

        {/* --- Модалка рейтинга --- */}
        {ratingMenuVisible && (
          <View style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, backgroundColor: "rgba(0,0,0,0.5)", justifyContent: "center", alignItems: "center", padding: 20 }}>
            <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, padding: 20, width: "100%", maxHeight: "70%" }}>
              <ScrollView>
                {Object.keys(ratings).map((key) => (
                  <View key={key} style={{ marginBottom: 20 }}>
                    <ValueText style={{ marginBottom: 6 }}>{key}</ValueText>
                    <RatingStars rating={ratings[key]} size={50} filledImage={ratingImages[key].filled} emptyImage={ratingImages[key].empty} onRate={(newRating) => setRatings({ ...ratings, [key]: newRating })} />
                  </View>
                ))}
              </ScrollView>
            </View>
            <RedButton name="Сохранить" onPress={handleSaveRating} />
          </View>
        )}

        {/* --- Модалка цитат/заметок --- */}
        {quoteNoteMenuVisible && (
          <View style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, backgroundColor: "rgba(0,0,0,0.5)", justifyContent: "center", alignItems: "center", padding: 20 }}>
            <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, padding: 20, width: "100%", maxHeight: "70%" }}>
              <ScrollView>
                <View style={{ flexDirection: "row", justifyContent: "space-around", marginBottom: 15 }}>
                  <TouchableOpacity onPress={() => setIsQuoteMode(true)}><ValueText style={{ fontFamily: isQuoteMode ? "Inter-Bold" : "Inter-Regular", color: isQuoteMode ? "#890524" : "#2F2017" }}>Цитата</ValueText></TouchableOpacity>
                  <TouchableOpacity onPress={() => setIsQuoteMode(false)}><ValueText style={{ fontFamily: !isQuoteMode ? "Inter-Bold" : "Inter-Regular", color: !isQuoteMode ? "#890524" : "#2F2017" }}>Заметка</ValueText></TouchableOpacity>
                </View>
                {isQuoteMode ? (
                  <>
                    <ValueText style={{ marginBottom: 6 }}>Текст цитаты</ValueText>
                    <TextInput style={{ borderWidth: 1, borderColor: "#a28c75", borderRadius: 8, padding: 8, marginBottom: 12 }} multiline value={newQuoteText} onChangeText={setNewQuoteText} placeholder="Введите цитату..." />
                    <ValueText style={{ marginBottom: 6 }}>Автор</ValueText>
                    <TextInput style={{ borderWidth: 1, borderColor: "#a28c75", borderRadius: 8, padding: 8, marginBottom: 12 }} value={newQuoteAuthor} onChangeText={setNewQuoteAuthor} placeholder="Введите автора..." />
                  </>
                ) : (
                  <>
                    <ValueText style={{ marginBottom: 6 }}>Текст заметки</ValueText>
                    <TextInput style={{ borderWidth: 1, borderColor: "#a28c75", borderRadius: 8, padding: 8, marginBottom: 12 }} multiline value={newNoteText} onChangeText={setNewNoteText} placeholder="Введите заметку..." />
                  </>
                )}
              </ScrollView>
            </View>
            <RedButton name="Сохранить" onPress={handleSaveEntry} />
          </View>
        )}

        <TabBar color={"#fdf5e2"} />
      </View>
    </TouchableWithoutFeedback>
  );
}

===== FILE: screens\BookSearchScreen.js =====

import React, { useState } from "react";
import { View, FlatList, TouchableOpacity, Image, ActivityIndicator, Text, Keyboard } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { SafeAreaView } from "react-native-safe-area-context";
import axios from "axios"; 
import api from "../src/api/client"; // Наш клиент для бэкенда

import InputField from "../components/Input_field";

// ... (Стили Header, OwlReadsTitle оставляем без изменений) ...
const Header = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-horizontal: 16px;
  margin-bottom: 20px;
  padding-top: 10px;
`;

const OwlReadsTitle = styled.Text`
  color: #230109;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
`;

const ResultItem = styled.TouchableOpacity`
  flex-direction: row;
  background-color: #FDF5E2;
  border-radius: 12px;
  padding: 10px;
  margin-horizontal: 16px;
  margin-bottom: 12px;
  elevation: 3;
  shadow-color: #000;
  shadow-offset: 0px 2px;
  shadow-opacity: 0.1;
  shadow-radius: 4px;
  border-width: 1px;
  /* Если книга из нашей базы - подсветим рамку */
  border-color: ${({ isLocal }) => (isLocal ? "#890524" : "transparent")};
`;

const BookCover = styled.Image`
  width: 60px;
  height: 90px;
  border-radius: 4px;
  background-color: #E8DFC9;
`;

const BookInfo = styled.View`
  flex: 1;
  margin-left: 12px;
  justify-content: center;
`;

const BookTitle = styled.Text`
  font-family: "VollkornSC-Bold";
  font-size: 16px;
  color: #890524;
  margin-bottom: 4px;
`;

const BookAuthor = styled.Text`
  font-family: "Inter-Medium";
  font-size: 14px;
  color: #2F2017;
`;

const SourceBadge = styled.Text`
  font-family: "Inter-Regular";
  font-size: 10px;
  color: #A28C75;
  margin-top: 4px;
`;

const EmptyText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
  text-align: center;
  margin-top: 20px;
  opacity: 0.6;
`;

const SearchRow = styled.View`
  flex-direction: row;
  align-items: center;
  margin-horizontal: 16px;
  margin-bottom: 20px;
  gap: 10px;
`;

const SearchButton = styled.TouchableOpacity`
  background-color: #890524;
  padding: 12px;
  border-radius: 14px;
  justify-content: center;
  align-items: center;
`;

export default function SearchBookScreen() {
  const navigation = useNavigation();
  const [query, setQuery] = useState("");
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);

  const handleSearch = async () => {
    if (!query.trim()) return;
    
    Keyboard.dismiss();
    setLoading(true);
    setResults([]); // Очищаем старые результаты
    
    console.log("Начинаем поиск:", query);

    try {
      // Запускаем два запроса параллельно: к нашему API и к Google
      const [localResponse, googleResponse] = await Promise.allSettled([
        api.get(`/api/literature/search?q=${query}`),
        axios.get(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=10`)
      ]);

      let combinedResults = [];

      // 1. Обрабатываем ответ от НАШЕГО сервера
      if (localResponse.status === 'fulfilled') {
        const localBooks = localResponse.value.data.map(book => ({
          id: `local_${book.id}`, // Уникальный ID
          originalId: book.id,    // ID в нашей БД
          title: book.title,
          author: book.author,
          year: book.year,
          cover: book.cover_url,
          source: 'local'         // Метка источника
        }));
        combinedResults = [...combinedResults, ...localBooks];
      }

      // 2. Обрабатываем ответ от Google Books
      if (googleResponse.status === 'fulfilled') {
        const items = googleResponse.value.data.items || [];
        const googleBooks = items.map((item) => {
          const info = item.volumeInfo;
          return {
            id: item.id,
            title: info.title,
            author: info.authors ? info.authors.join(", ") : "Неизвестный автор",
            pages: info.pageCount,
            year: info.publishedDate ? parseInt(info.publishedDate.substring(0, 4)) : null,
            language: info.language,
            description: info.description,
            cover: info.imageLinks?.thumbnail?.replace('http://', 'https://') || null,
            source: 'google'
          };
        });
        combinedResults = [...combinedResults, ...googleBooks];
      }

      setResults(combinedResults);

    } catch (error) {
      console.error("Ошибка поиска:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleSelectBook = (book) => {
    // Передаем книгу на экран добавления
    // Если source === 'local', мы знаем, что книга уже есть в БД (можно передать её ID)
    // Если source === 'google', мы просто заполняем поля
    navigation.navigate("BookManualAdd", { book: book });
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#FDF5E2" }}>
      
      <SafeAreaView style={{ flex: 1 }}>
        <Header>
          <TouchableOpacity onPress={() => navigation.goBack()} style={{ width: 35, height: 35 }}>
            <Image source={require("../assets/chevron_left.png")} style={{ width: 35, height: 35 }} resizeMode="contain" />
          </TouchableOpacity>
          <OwlReadsTitle>OwlReads</OwlReadsTitle>
          <View style={{ width: 35 }} />
        </Header>

        {/* Обновленная строка поиска */}
        <SearchRow>
          <View style={{ flex: 1 }}>
            <InputField 
              placeholder="Название или автор..." 
              value={query}
              onChangeText={setQuery}
              style={{ width: 'auto', marginHorizontal: 0 }} // Убираем отступы самого поля, так как они есть у SearchRow
              
              // Теперь эти пропсы будут работать благодаря исправлению в Шаге 1:
              returnKeyType="search"
              onSubmitEditing={handleSearch} 
            />
          </View>

          <SearchButton onPress={handleSearch}>
            <Image 
              source={require("../assets/search.png")} // Убедись, что есть иконка лупы, или используй add_book временно
              style={{ width: 24, height: 24, tintColor: '#FDF5E2' }} 
            />
          </SearchButton>
        </SearchRow>

        {loading ? (
          <ActivityIndicator size="large" color="#890524" style={{ marginTop: 20 }} />
        ) : (
          <FlatList
            data={results}
            keyExtractor={(item) => item.id}
            contentContainerStyle={{ paddingBottom: 40 }}
            ListEmptyComponent={
              <EmptyText>
                {query ? "Ничего не найдено" : "Введите запрос для поиска"}
              </EmptyText>
            }
            renderItem={({ item }) => (
              <ResultItem 
                onPress={() => handleSelectBook(item)}
                isLocal={item.source === 'local'} // Передаем проп для стиля
              >
                {item.cover ? (
                  <BookCover source={{ uri: item.cover }} resizeMode="cover" />
                ) : (
                  <BookCover source={require("../assets/cover.png")} resizeMode="cover" />
                )}
                
                <BookInfo>
                  <BookTitle numberOfLines={2}>{item.title}</BookTitle>
                  <BookAuthor numberOfLines={1}>{item.author}</BookAuthor>
                  <SourceBadge>
                    {item.source === 'local' ? "В библиотеке OwlReads" : "Google Books"}
                  </SourceBadge>
                </BookInfo>
              </ResultItem>
            )}
          />
        )}

      </SafeAreaView>
    </View>
  );
}

===== FILE: screens\ChatsScreen.js =====

import React, { useState } from "react";
import { View, FlatList } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native"; // <--- 1. Импорт навигации

// Импорты компонентов
import NavigationBar from "../components/Navigation_bar";
import ChatItem from "../components/Chat_item";
import AddNewChatItem from "../components/Add_new_chat";
import { TabBar } from "../components/Tab_bar";
import AddBookModal from "../components/Add_book_modal"; // <--- 2. Импорт модалки

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

export default function ChatsScreen() {
  const navigation = useNavigation(); // <--- 3. Хук навигации
  const [isAddBookModalVisible, setAddBookModalVisible] = useState(false); // <--- 4. Состояние модалки

  const icons = [
    { name: "home", source: require("../assets/home.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" }, // <--- 5. Указываем screen для перехвата
    { name: "message", source: require("../assets/message_active.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user.png"), screen: "Account" },
  ];

  const chats = [
    // Пока пустой список, как в твоем примере
  ];

  // --- 6. Логика перехвата нажатия ---
  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setAddBookModalVisible(true);
    } else {
      navigation.navigate(screenName);
    }
  };

  // Заглушки для действий
  const handleSearchBook = () => {
    setAddBookModalVisible(false);
    console.log("Поиск книги");
    // navigation.navigate("SearchBook");
  };

  const handleAddManual = () => {
    setAddBookModalVisible(false);
    console.log("Добавление вручную");
    // navigation.navigate("AddBookManual");
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <OwlReadsTitle>OwlReads</OwlReadsTitle>

      <FlatList
        data={chats}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <ChatItem title={item.title} message={item.message} />
        )}
        showsVerticalScrollIndicator={false}
        ListHeaderComponent={<AddNewChatItem />}
        contentContainerStyle={{ paddingBottom: 130 }}
      />

      {/* 7. Передаем перехватчик */}
      <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
      
      {/* 8. Скрываем TabBar при открытии меню */}
      {!isAddBookModalVisible && <TabBar color={"#D7C1AB"}/>}

      {/* 9. Модальное окно */}
      <AddBookModal 
        visible={isAddBookModalVisible}
        onClose={() => setAddBookModalVisible(false)}
        onSearch={handleSearchBook}
        onAdd={handleAddManual}
      />
    </View>
  );
}

===== FILE: screens\CorrespondenceScreen.js =====

import React, { useState, useRef, useEffect } from "react";
import { View, Image, TouchableOpacity, ScrollView } from "react-native";
import styled from "styled-components/native";
import { TabBar } from "../components/Tab_bar";
import UserMessageBubble from "../components/User_message_bubble";
import ReplyMessageBubble from "../components/Reply_message_bubble";

const HeaderWrapper = styled.View`
  background-color: #fdf5e2;
  border-bottom-left-radius: 18px;
  border-bottom-right-radius: 18px;
`;

const HeaderContainer = styled.View`
  flex-direction: row;
  align-items: center;
  padding-horizontal: 16px;
  padding-vertical: 10px;
  margin-top: 43px;
`;

const IconButton = styled(TouchableOpacity)`
  width: 35px;
  height: 35px;
`;

const ChatBlock = styled.View`
  flex: 1;
  flex-direction: row;
  align-items: center;
  margin: 0 12px;
`;

const ChatIconWrapper = styled.View`
  width: 50px;
  height: 50px;
  border-radius: 50px;
  background-color: #a28c75;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
`;

const OwlIcon = styled.Image`
  width: 37px;
  height: 37px;
`;

const ChatTitle = styled.Text`
  color: #2F2017;
  font-family: "Inter-Regular";
  font-size: 16px;
  font-weight: 400;
  flex-shrink: 1;
`;

const InputWrapper = styled.View`
  flex-direction: row;
  align-items: center;
  background-color: #fdf5e2;
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;
  padding: 10px 16px;
  margin-bottom: 48px;
`;

const MessageInput = styled.TextInput`
  flex: 1;
  font-family: "Inter-Regular";
  font-size: 16px;
  color: #2f2017;
  padding-vertical: 8px;
  padding-horizontal: 12px;
`;

export default function CorrespondenceScreen({ navigation }) {
  const [message, setMessage] = useState("");
  const [messages, setMessages] = useState([]);
  const scrollViewRef = useRef(null);

  const getCurrentTime = () => {
    const now = new Date();
    return `${now.getHours()}:${String(now.getMinutes()).padStart(2, "0")}`;
  };

  const handleSend = () => {
    if (message.trim().length > 0) {
      const userMsg = {
        type: "user",
        text: message,
        time: getCurrentTime(),
      };
      setMessages((prev) => [...prev, userMsg]);
      setMessage("");

      // Автоответ от системы
      setTimeout(() => {
        const replyMsg = {
          type: "system",
          text: "Это автоответ от Букли 🦉",
          time: getCurrentTime(),
        };
        setMessages((prev) => [...prev, replyMsg]);
      }, 500);
    }
  };

  // Автоскролл вниз при добавлении нового сообщения
  useEffect(() => {
    if (scrollViewRef.current) {
      scrollViewRef.current.scrollToEnd({ animated: true });
    }
  }, [messages]);

  return (
    <View style={{ flex: 1, backgroundColor: "#A28C75" }}>
      {/* Верхняя шапка */}
      <HeaderWrapper>
        <HeaderContainer>
          <IconButton onPress={() => navigation.goBack()}>
            <Image
              source={require("../assets/chevron_left.png")}
              style={{ width: 35, height: 35 }}
            />
          </IconButton>

          <ChatBlock>
            <ChatIconWrapper>
              <OwlIcon source={require("../assets/Owl_icon.png")} />
            </ChatIconWrapper>
            <ChatTitle numberOfLines={1}>Букля</ChatTitle>
          </ChatBlock>

          <IconButton>
            <Image
              source={require("../assets/more.png")}
              style={{ width: 35, height: 35 }}
            />
          </IconButton>
        </HeaderContainer>
      </HeaderWrapper>

      <View style={{ flex: 1, backgroundColor: "#A28C75" }}>
        {/* Основное содержимое чата */}
        <ScrollView
          ref={scrollViewRef}
          contentContainerStyle={{ flexGrow: 1, justifyContent: "flex-end" }}
          keyboardShouldPersistTaps="handled"
        >
          {messages.map((msg, index) =>
            msg.type === "user" ? (
              <UserMessageBubble key={index} text={msg.text} time={msg.time} />
            ) : (
              <ReplyMessageBubble key={index} text={msg.text} time={msg.time} />
            )
          )}
        </ScrollView>

        {/* Нижний блок ввода */}
        <InputWrapper>
          <MessageInput
            placeholder="Введите сообщение..."
            placeholderTextColor="#A28C75"
            value={message}
            onChangeText={setMessage}
          />
          <IconButton onPress={handleSend}>
            <Image
              source={require("../assets/send.png")}
              style={{ width: 35, height: 35 }}
            />
          </IconButton>
        </InputWrapper>

        {/* Нижняя панель */}
        <TabBar color={"#FDF5E2"} />
      </View>
    </View>
  );
}


===== FILE: screens\EntryScreen.js =====

import React, { useState } from "react";
import { View, Pressable, Alert, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import AsyncStorage from '@react-native-async-storage/async-storage';
import RedButton from "../components/Red_button";
import BackgroundPaper from "../components/Background_paper";
import InputField from "../components/Input_field";
import api from "../src/api/client";

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 50px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

const OwlReadsSubTitle = styled.Text`
  color: #2F2017;
  font-family: "KoPub-Batang-Regular";
  font-size: 15px;
  text-align: center;
  letter-spacing: 2.5px;
`;

const RegistrationCard = styled.View`
  margin-top: 165px;
  gap: 20px;
  align-items: center;
  width: auto;
  flex-direction: column;
  justify-content: center;
  width: auto;
  margin-left: 32px;
  margin-right: 32px;
`;

const RegistrationCardTitle = styled.Text`
  color: #890524;
  font-family: "VollkornSC-Regular";
  font-size: 25px;
  text-align: center;
`;

const ForgotPasswordContainer = styled.View`
  width: 100%;
  align-items: flex-end;
`;

const ForgotPasswordText = styled.Text`
  color: #890524;
  font-family: "Inter-Regular";
  font-size: 13px;
  text-align: right;
`;

export default function EntryScreen({ navigation }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  
  // Ошибки для конкретных полей
  const [errors, setErrors] = useState({});
  const [isLoading, setIsLoading] = useState(false);

  const handleForgotPassword = () => {
    console.log("Переход на экран восстановления пароля");
    // navigation.navigate("ForgotPassword");
  };

  const handleLogin = async () => {
    // 1. Сброс ошибок
    setErrors({});
    let valid = true;
    let newErrors = {};

    // 2. Валидация
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!email.trim()) {
      newErrors.email = "Введите email*";
      valid = false;
    } else if (!emailRegex.test(email)) {
      newErrors.email = "Некорректный email*";
      valid = false;
    }

    if (!password) {
      newErrors.password = "Введите пароль*";
      valid = false;
    }

    if (!valid) {
      setErrors(newErrors);
      return;
    }

    // 3. Отправка запроса
    setIsLoading(true);
    try {
      const response = await api.post("/api/auth/login", {
        email: email,
        password: password
      });

      console.log("Вход успешен:", response.data);
      
      // СОХРАНЯЕМ ДАННЫЕ
      await AsyncStorage.setItem('userToken', response.data.access_token);
      await AsyncStorage.setItem('userId', String(response.data.user_id)); // Важно сохранить ID

      navigation.navigate("Home");

    } catch (error) {
      console.error("Ошибка входа:", error);
      if (error.response && error.response.status === 401) {
        Alert.alert("Ошибка входа", "Неверный email или пароль");
      } else {
        Alert.alert("Ошибка", "Проверьте соединение с интернетом");
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Очистка ошибки при вводе
  const clearError = (field) => {
    setErrors((prev) => ({ ...prev, [field]: "" }));
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ top: 100 }}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <OwlReadsSubTitle>Начни свою {"\n"} книжную историю!</OwlReadsSubTitle>
      </View>
      <BackgroundPaper />
      
      <RegistrationCard>
        <RegistrationCardTitle>Вход</RegistrationCardTitle>
        
        <InputField
          value={email}
          onChangeText={(text) => { setEmail(text); clearError("email"); }}
          placeholder="Электронная почта"
          error={errors.email}
          keyboardType="email-address"
          autoCapitalize="none"
        />
        
        <InputField
          value={password}
          onChangeText={(text) => { setPassword(text); clearError("password"); }}
          placeholder="Пароль"
          error={errors.password}
          secureTextEntry={true}
        />
        
        <ForgotPasswordContainer>
          <Pressable onPress={handleForgotPassword}>
            <ForgotPasswordText>Забыли пароль?</ForgotPasswordText>
          </Pressable>
        </ForgotPasswordContainer>

        {isLoading ? (
          <ActivityIndicator size="large" color="#890524" />
        ) : (
          // Важно: используем onPress, а не screen
          <RedButton name={"Продолжить чтение"} onPress={handleLogin} />
        )}
      </RegistrationCard>
    </View>
  );
}

===== FILE: screens\HomeScreen.js =====

// screens/HomeScreen.js
import React, { useEffect, useState } from "react";
import { View, Image } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";

import Quote from "../components/Popular_quote";
import NavigationBar from "../components/Navigation_bar";
import { TabBar } from "../components/Tab_bar";
import AddBookModal from "../components/Add_book_modal";
import api from "../src/api/client";

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  justify-content: center;
  align-items: center;
  text-align: center;
  margin-top: 48px;
`;

export default function HomeScreen() {
  const navigation = useNavigation();
  const [quote, setQuote] = useState(null);
  
  const [isModalVisible, setModalVisible] = useState(false);

  const icons = [
    { name: "home", source: require("../assets/home_active.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" }, 
    { name: "message", source: require("../assets/message.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user.png"), screen: "Account" },
  ];

  useEffect(() => {
    async function fetchQuote() {
      try {
        const response = await api.get("/api/quotes/random");
        setQuote(response.data);
      } catch (error) {
        console.error("Ошибка загрузки цитаты:", error);
      }
    }
    fetchQuote();
  }, []);

  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setModalVisible(true); 
    } else {
      navigation.navigate(screenName); 
    }
  };

  const handleSearch = () => {
    setModalVisible(false);
    console.log("Идем искать книгу...");
  };

  const handleAddManual = () => {
    setModalVisible(false);
    console.log("Идем добавлять вручную...");
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ flexDirection: "column" }}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <Image
          source={require("../assets/Owl_and_bookshelves.png")}
          style={{ width: 368, height: 149, resizeMode: "cover", marginBottom: -4, marginLeft: 25, zIndex: 1 }}
        />
        {quote && (
          <Quote quote_text={quote.text} quote_author={`@${quote.book_title}`} />
        )}
      </View>

      <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
      
      <TabBar color={"#D7C1AB"} />

      <AddBookModal 
        visible={isModalVisible}
        onClose={() => setModalVisible(false)}
        onSearch={handleSearch}
        onAdd={handleAddManual}
      />
    </View>
  );
}

===== FILE: screens\LibraryScreen.js =====

import React, { useState, useCallback } from "react";
import { View, FlatList, TouchableWithoutFeedback, ActivityIndicator, Text } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useFocusEffect } from "@react-navigation/native"; 
import AsyncStorage from '@react-native-async-storage/async-storage';

// Импорты компонентов
import NavigationBar from "../components/Navigation_bar";
import { BookCard } from "../components/Book_card";
import { TabBar } from "../components/Tab_bar";
import { TextBox } from "../components/TextBox_props";
import RatingStars from "../components/Rating_starts";
import RedButton from "../components/Red_button";
import AddBookModal from "../components/Add_book_modal"; 
import api from "../src/api/client"; // <--- API клиент

// ... (Стили оставляем без изменений: OwlReadsTitle, Separator, Overlay и т.д.) ...
const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  justify-content: center;
  align-items: center;
  text-align: center;
  margin-top: 48px;
`;
const Separator = styled.View`
  height: 2px;
  background-color: #FDF5E2;
  margin-top: 5px;
`;
const Overlay = styled.View`
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.65);
  justify-content: flex-end;
  align-items: center;
`;
const Circle = styled.View`
  position: absolute;
  bottom: -337px;
  width: 770px;
  height: 770px;
  border-radius: 385px;
  background-color: #FDF5E2;
`;
const OverlayContent = styled.View`
  flex: 1;
  align-items: center;
  bottom: 0;
  position: absolute;
  width: 100%;
  padding: 12px;
  gap: 8px;
  padding-bottom: 60px;
`;
const OverlayCover = styled.Image`
  height: ${({ height }) => height || 160}px;
  width: ${({ width }) => width || 110}px;
  border-radius: 7px;
`;
const OverlayTitle = styled.Text`
  font-family: VollkornSC-Regular;
  font-size: 17px;
  color: #890524;
  align-self: flex-start;
`;
const OverlayAuthor = styled.Text`
  font-family: Inter-Regular;
  font-size: 14px;
  color: #2F2017;
  align-self: flex-start;
`;

export default function LibraryScreen() {
  const navigation = useNavigation();
  
  const [overlayVisible, setOverlayVisible] = useState(false);
  const [selectedBook, setSelectedBook] = useState(null);
  const [isAddBookModalVisible, setAddBookModalVisible] = useState(false);
  
  // --- Новые состояния ---
  const [books, setBooks] = useState([]);
  const [loading, setLoading] = useState(true);

  const icons = [
    { name: "home", source: require("../assets/home.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book_active.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" },
    { name: "message", source: require("../assets/message.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user.png"), screen: "Account" },
  ];

  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setAddBookModalVisible(true);
    } else {
      navigation.navigate(screenName);
    }
  };

  const handleSearchBook = () => {
    setAddBookModalVisible(false);
    navigation.navigate("SearchBook"); // Убедись, что экран так называется в App.js
  };

  const handleAddManual = () => {
    setAddBookModalVisible(false);
    navigation.navigate("AddBookManual");
  };

  // --- Загрузка книг ---
  useFocusEffect(
    useCallback(() => {
      const fetchLibrary = async () => {
        setLoading(true);
        try {
          const userId = await AsyncStorage.getItem('userId');
          if (!userId) return;

          const response = await api.get(`/api/users_book_review/library/${userId}`);
          setBooks(response.data);
        } catch (error) {
          console.error("Ошибка загрузки библиотеки:", error);
        } finally {
          setLoading(false);
        }
      };

      fetchLibrary();
    }, [])
  );

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ flexDirection: "column", flex: 1 }}> {/* flex: 1 важно для FlatList */}
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <Separator />
        
        {loading ? (
          <ActivityIndicator size="large" color="#890524" style={{ marginTop: 20 }} />
        ) : (
          <FlatList
            data={books}
            keyExtractor={(item) => String(item.review_id)} // Используем ID отзыва как ключ
            renderItem={({ item }) => (
              <BookCard
                // Если cover_url есть - используем uri, иначе - локальную заглушку
                cover={item.cover_url ? { uri: item.cover_url } : require("../assets/cover.png")}
                category={item.category_name}
                categorycolor={item.category_color}
                title={item.title}
                author={item.author}
                rating={item.rating}
                onPress={() => {
                  setSelectedBook(item);
                  setOverlayVisible(true);
                }}
              />
            )}
            contentContainerStyle={{ paddingBottom: 100, paddingTop: 10 }}
            ListEmptyComponent={
              <Text style={{ textAlign: 'center', marginTop: 20, color: '#2F2017', fontFamily: 'Inter-Regular' }}>
                В вашей библиотеке пока нет книг.
              </Text>
            }
          />
        )}
      </View>

      <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
      
      {!isAddBookModalVisible && <TabBar color={"#D7C1AB"} />}

      <AddBookModal 
        visible={isAddBookModalVisible}
        onClose={() => setAddBookModalVisible(false)}
        onSearch={handleSearchBook}
        onAdd={handleAddManual}
      />

      {/* Оверлей */}
      {overlayVisible && selectedBook && (
        <TouchableWithoutFeedback onPress={() => setOverlayVisible(false)}>
          <Overlay>
            <Circle />
            <OverlayContent>
              <OverlayCover 
                source={selectedBook.cover_url ? { uri: selectedBook.cover_url } : require("../assets/cover.png")} 
                resizeMode="cover" 
              />

              <View style={{ alignSelf: 'center' }}>
                <TextBox text={selectedBook.category_name} color={item.category_color} />
              </View>

              <OverlayTitle>{selectedBook.title}</OverlayTitle>
              <OverlayAuthor>{selectedBook.author}</OverlayAuthor>

              <View style={{ alignSelf: 'flex-start', marginTop: 8 }}>
                <RatingStars
                  rating={selectedBook.rating}
                  size={40}
                  filledImage={require('../assets/star_filled.png')}
                  emptyImage={require('../assets/star_empty.png')}
                />
              </View>
              
              {/* Переход к деталям книги (нужно будет передать ID) */}
              <RedButton 
                name={"Подробнее"} 
                onPress={() => {
                    setOverlayVisible(false);
                    navigation.navigate("Book", { reviewId: selectedBook.review_id });
                    console.log("Переход к книге:", selectedBook.review_id);
                }}
              />
            </OverlayContent>
          </Overlay>
        </TouchableWithoutFeedback>
      )}
    </View>
  );
}

===== FILE: screens\RegistrationScreen.js =====

import React, { useState } from "react";
import { View, Pressable, Alert, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import RedButton from "../components/Red_button";
import BackgroundPaper from "../components/Background_paper";
import InputField from "../components/Input_field";
import api from "../src/api/client"; // Убедись, что путь правильный

// --- STYLED COMPONENTS (Без изменений) ---
const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 50px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

const OwlReadsSubTitle = styled.Text`
  color: #2F2017;
  font-family: "KoPub-Batang-Regular";
  font-size: 15px;
  text-align: center;
  letter-spacing: 2.5px;
`;

const RegistrationCard = styled.View`
  margin-top: 165px;
  gap: 20px;
  align-items: center;
  width: auto;
  flex-direction: column;
  justify-content: center;
  width: auto;
  margin-left: 32px;
  margin-right: 32px;
`;

const RegistrationCardTitle = styled.Text`
  color: #890524;
  font-family: "VollkornSC-Regular";
  font-size: 25px;
  text-align: center;
`;

const CheckboxContainer = styled.View`
  flex-direction: row;
  align-items: flex-start;
  margin-horizontal: 32px;
`;

const CheckboxBox = styled.View`
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border-width: 2px;
  border-color: #D3CDBF;
  background-color: ${(props) => (props.checked ? "#890524" : "transparent")};
  margin-right: 10px;
`;

const CheckboxLabel = styled.Text`
  color: #A28C75;
  font-family: "Inter-Regular";
  font-size: 13px;
  flex-shrink: 1;
`;

export default function RegistrationScreen({ navigation }) {
  const [step, setStep] = useState(1);
  const [isLoading, setIsLoading] = useState(false);

  // Данные формы
  const [username, setUserName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [passwordDuble, setPasswordDuble] = useState("");
  const [accepted, setAccepted] = useState(false);
  const [code, setCode] = useState("");

  // Ошибки
  const [errors, setErrors] = useState({});

  // --- ВАЛИДАЦИЯ ФОРМЫ ---
  const validateStep1 = () => {
    let valid = true;
    let newErrors = {};

    if (!username.trim()) {
      newErrors.username = "Введите имя пользователя*";
      valid = false;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email.trim()) {
      newErrors.email = "Введите email*";
      valid = false;
    } else if (!emailRegex.test(email)) {
      newErrors.email = "Некорректный формат email*";
      valid = false;
    }

    if (!password) {
      newErrors.password = "Введите пароль*";
      valid = false;
    } else if (password.length < 6) {
      newErrors.password = "Минимум 6 символов*";
      valid = false;
    }

    if (password !== passwordDuble) {
      newErrors.passwordDuble = "Пароли не совпадают*";
      valid = false;
    }

    setErrors(newErrors);
    return valid;
  };

  // --- ШАГ 1: РЕГИСТРАЦИЯ ---
  const handleRegister = async () => {
    // 1. Проверка полей
    if (!validateStep1()) return;

    // 2. Проверка чекбокса
    if (!accepted) {
      Alert.alert("Ошибка", "Необходимо принять условия соглашения");
      return;
    }

    setIsLoading(true);
    try {
      // 3. Отправка на бэкенд
      const payload = {
        username: username,
        email: email,
        password_hash: password, // Бэк сам захеширует
        agreement_accepted: accepted,
        profile_photo: null
      };

      // POST /api/users_personal_data/
      await api.post("/api/users_personal_data/", payload);
      
      // Если успешно (201 Created), переходим к вводу кода
      setStep(2);

    } catch (error) {
      console.error("Ошибка регистрации:", error);
      if (error.response) {
        const detail = error.response.data.detail;
        // Обработка ошибок от FastAPI
        if (typeof detail === "string") {
            if (detail.includes("Email")) {
                setErrors(prev => ({ ...prev, email: "Email уже занят*" }));
            } else if (detail.includes("username")) { // Если добавишь проверку юзернейма на бэке
                setErrors(prev => ({ ...prev, username: "Имя занято*" }));
            } else {
                Alert.alert("Ошибка", detail);
            }
        } else {
            Alert.alert("Ошибка", "Проверьте данные");
        }
      } else {
        Alert.alert("Ошибка сети", "Нет соединения с сервером");
      }
    } finally {
      setIsLoading(false);
    }
  };

  // --- ШАГ 2: ПОДТВЕРЖДЕНИЕ КОДА ---
  const handleConfirmRegistration = async () => {
    if (!code.trim()) {
      setErrors({ code: "Введите код подтверждения*" });
      return;
    }

    setIsLoading(true);
    try {
      // POST /api/users_personal_data/verify
      const payload = {
        email: email,
        code: code
      };

      await api.post("/api/users_personal_data/verify", payload);
      
      // Если успешно (200 OK), переходим к финалу
      setStep(3);

    } catch (error) {
      console.error("Ошибка верификации:", error);
      if (error.response && error.response.status === 400) {
        setErrors({ code: "Неверный код подтверждения*" });
      } else {
        Alert.alert("Ошибка", "Не удалось подтвердить код");
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleResendCode = () => {
    // Пока просто заглушка, так как на бэке нет отдельного эндпоинта resend
    // Можно попробовать вызвать create_user снова, но он вернет 400, если юзер есть.
    // Для MVP можно сказать пользователю проверить спам.
    Alert.alert("Инфо", "Проверьте папку Спам. Если письма нет, попробуйте зарегистрироваться заново через 10 минут.");
  };

  // Функция для очистки ошибки при вводе
  const clearError = (field) => {
    setErrors((prev) => ({ ...prev, [field]: "" }));
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ top: 100 }}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <OwlReadsSubTitle>Начни свою {"\n"} книжную историю!</OwlReadsSubTitle>
      </View>
      <BackgroundPaper />

      {/* --- ЭКРАН 1: ВВОД ДАННЫХ --- */}
      {step === 1 && (
        <RegistrationCard>
          <RegistrationCardTitle>Регистрация</RegistrationCardTitle>
          
          <InputField
            value={username}
            onChangeText={(text) => { setUserName(text); clearError("username"); }}
            placeholder="Имя пользователя"
            error={errors.username}
          />
          <InputField
            value={email}
            onChangeText={(text) => { setEmail(text); clearError("email"); }}
            placeholder="Электронная почта"
            error={errors.email}
            keyboardType="email-address"
            autoCapitalize="none"
          />
          <InputField
            value={password}
            onChangeText={(text) => { setPassword(text); clearError("password"); }}
            placeholder="Пароль"
            error={errors.password}
            secureTextEntry={true} // Скрываем пароль
          />
          <InputField
            value={passwordDuble}
            onChangeText={(text) => { setPasswordDuble(text); clearError("passwordDuble"); }}
            placeholder="Повторите пароль"
            error={errors.passwordDuble}
            secureTextEntry={true} // Скрываем пароль
          />

          <Pressable onPress={() => setAccepted(!accepted)}>
            <CheckboxContainer>
              <CheckboxBox checked={accepted} />
              <CheckboxLabel>
                Я ознакомлен(а) и принимаю условия Пользовательского соглашения и Политику конфиденциальности
              </CheckboxLabel>
            </CheckboxContainer>
          </Pressable>

          {isLoading ? (
            <ActivityIndicator size="large" color="#890524" />
          ) : (
            <RedButton name={"Зарегистрироваться"} onPress={handleRegister} />
          )}
        </RegistrationCard>
      )}

      {/* --- ЭКРАН 2: ВВОД КОДА --- */}
      {step === 2 && (
        <RegistrationCard>
          <RegistrationCardTitle>Подтверждение регистрации</RegistrationCardTitle>
          <CheckboxLabel style={{ marginHorizontal: 32, marginBottom: 10, textAlign: "center" }}>
            На вашу почту отправлен код подтверждения. Введите его ниже, чтобы завершить регистрацию.
          </CheckboxLabel>

          <InputField
            value={code}
            onChangeText={(text) => { setCode(text); clearError("code"); }}
            placeholder="Введите код из письма"
            error={errors.code}
            keyboardType="number-pad"
          />

          <Pressable onPress={handleResendCode}>
            <CheckboxLabel style={{ color: "#890524", marginHorizontal: 32, marginBottom: 162, textAlign: "right" }}>
              Отправить код ещё раз
            </CheckboxLabel>
          </Pressable>

          {isLoading ? (
            <ActivityIndicator size="large" color="#890524" />
          ) : (
            <RedButton name={"Подтвердить регистрацию"} onPress={handleConfirmRegistration} />
          )}
        </RegistrationCard>
      )}

      {/* --- ЭКРАН 3: УСПЕХ --- */}
      {step === 3 && (
        <RegistrationCard style={{ gap: 295 }}>
          <View style={{ gap: 20 }}>
            <RegistrationCardTitle>Подтверждение регистрации</RegistrationCardTitle>
            <CheckboxLabel style={{ marginHorizontal: 32, marginBottom: 10, textAlign: "center" }}>
              Ваша регистрация прошла успешно.
            </CheckboxLabel>
          </View>

          <RedButton 
            name={"Войти"} 
            onPress={() => navigation.navigate("Entry")} // Убедись, что экран называется "Entry"
          />
        </RegistrationCard>
      )}
    </View>
  );
}

===== FILE: screens\StartScreen.js =====

import React from "react";
import { View, Image} from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import RedButton from "../components/Red_button";

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 50px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

const OwlReadsSubTitle = styled.Text`
  color: #2F2017;
  font-family: "KoPub-Batang-Regular";
  font-size: 15px;
  text-align: center;
  letter-spacing: 2.5px;
`;

const Buttons = styled.View`
  margin-top: auto;
  margin-bottom: 60px;
  gap: 10px;
  align-items: center;
  width: auto;
  flex-direction: column;
  justify-content: center;
  width: auto;
  margin-left: 32px;
  margin-right: 32px;
`;

const ButtonContainer = styled.TouchableOpacity`
  background-color: #D7C1AB;
  border: 1px solid #6C5141;
  border-radius: 14px;
  padding-vertical: 20px;
  margin-horizontal: 32px;
  align-items: center;
  justify-content: center;
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
  width: 100%;
`;

const ButtonText = styled.Text`
  color: #2F2017;
  font-family: "Inter-Regular";
  font-size: 15px;
  text-align: center;
`;

const OwlImage = styled.Image`
  width: 242px;
  height: 293px;
  align-self: center;
  bottom: 240px;
  align-items: center;
  justify-content: center;
  position: absolute;
`;

export default function StartScreen() {
  const navigation = useNavigation();

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB", flexDirection: "column"}}>
      <View style={{top: 100}}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <OwlReadsSubTitle>Начни свою {"\n"} книжную историю!</OwlReadsSubTitle>
      </View>

      <OwlImage source={require("../assets/Owl.png")}/>
      <Buttons>
        <RedButton screen={"Registration"} name={"Зарегистрироваться"}/>

        <ButtonContainer onPress={() => navigation.navigate("Entry")}>
          <ButtonText>Продолжить чтение</ButtonText>
        </ButtonContainer>
      </Buttons>     
    </View>
  );
}

===== FILE: src\api\client.js =====

import axios from "axios";

const api = axios.create({
  baseURL: process.env.EXPO_PUBLIC_API_URL,
});

export default api;


===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\README.md =====

## просмотр текущей миграции
docker-compose exec db psql -U OwlReads_reader_dairy -d OwlReads_reader_dairy_db -c "SELECT * FROM alembic_version;"

## Настройка текущей миграции вручную
docker-compose exec db psql -U OwlReads_reader_dairy -d OwlReads_reader_dairy_db -c "UPDATE alembic_version SET version_num='725b1d704ec7';"

## Создание миграции
docker-compose exec api alembic revision --autogenerate -m "create users_book_quotes"

## Применение миграции
docker-compose exec api alembic upgrade head










===== D:\BSUIR\Diploma\OwlReads-project\server-OwlReads\requirements.txt =====

alembic==1.17.2
annotated-doc==0.0.3
annotated-types==0.7.0
anyio==4.11.0
beautifulsoup4==4.12.3
blinker==1.9.0
certifi==2025.10.5
charset-normalizer==3.4.4
click==8.3.0
colorama==0.4.6
contourpy==1.3.3
cycler==0.12.1
fastapi==0.121.0
Flask==3.0.0
fonttools==4.60.1
greenlet==3.2.4
h11==0.16.0
idna==3.11
itsdangerous==2.2.0
Jinja2==3.1.6
joblib==1.5.2
lxml==5.3.0
Mako==1.3.10
MarkupSafe==3.0.3
matplotlib==3.9.0
packaging==25.0
pillow==12.0.0
psycopg2-binary==2.9.11
pydantic==2.12.3
pydantic_core==2.41.4
passlib[bcrypt]==1.7.4
bcrypt==3.2.2
pyparsing==3.2.5
python-dateutil==2.9.0.post0
python-dotenv==1.2.1
pytz==2025.2
regex==2025.11.3
requests==2.32.3
six==1.17.0
sniffio==1.3.1
soupsieve==2.8
SQLAlchemy==2.0.44
starlette==0.49.3
tqdm==4.67.1
typing-inspection==0.4.2
typing_extensions==4.15.0
python-jose[cryptography]==3.3.0
tzdata==2025.2
urllib3==2.5.0
uvicorn==0.38.0
Werkzeug==3.1.3
email-validator==2.2.0

