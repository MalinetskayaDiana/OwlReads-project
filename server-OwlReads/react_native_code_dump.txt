

===== FILE: App.js =====

import React, { useState, useEffect } from "react";
import { View } from "react-native";
import * as Font from "expo-font";
import { NavigationContainer } from "@react-navigation/native";
import { createNativeStackNavigator } from "@react-navigation/native-stack";
import StartScreen from "./screens/StartScreen";
import RegistrationScreen from "./screens/RegistrationScreen";
import EntryScreen from "./screens/EntryScreen";
import HomeScreen from "./screens/HomeScreen";
import LibraryScreen from "./screens/LibraryScreen";
import ChatsScreen from "./screens/ChatsScreen";
import CorrespondenceScreen from "./screens/CorrespondenceScreen";
import AccountScreen from "./screens/AccountScreen";
import BookScreen from "./screens/BookScreen";
import AddBookModal from "./components/Add_book_modal";
import AddBookManualScreen from "./screens/AddBookManualScreen";
import BookSearchScreen from "./screens/BookSearchScreen";
import BarcodeScannerScreen from "./screens/BarcodeScannerScreen";

const Stack = createNativeStackNavigator();

export default function App() {
  const [fontsLoaded, setFontsLoaded] = useState(false);

  useEffect(() => {
    async function loadFonts() {
      await Font.loadAsync({
        "Marck Script-Regular": require("./assets/fonts/MarckScript-Regular.ttf"),
        "Inter-Regular": require("./assets/fonts/Inter-Regular.otf"),
        "Inter-Medium": require("./assets/fonts/Inter-Medium.otf"),
        "VollkornSC-Regular": require("./assets/fonts/VollkornSC-Regular.ttf"),
        "VollkornSC-Bold": require("./assets/fonts/VollkornSC-Bold.ttf"),
        "KoPub-Batang-Regular": require("./assets/fonts/kopubbatang-regular.ttf"),
      });
      setFontsLoaded(true);
    }
    loadFonts();
  }, []);

  if (!fontsLoaded) {
    return null;
  }

  return (
    <NavigationContainer>
      <Stack.Navigator screenOptions={{ headerShown: false }}>
        <Stack.Screen
          name="Start"
          component={StartScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Registration"
          component={RegistrationScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Entry"
          component={EntryScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Home"
          component={HomeScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Library"
          component={LibraryScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="AddBookModal"
          component={AddBookModal}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Book"
          component={BookScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="BookManualAdd"
          component={AddBookManualScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="BookSearch"
          component={BookSearchScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Chats"
          component={ChatsScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Сorrespondence"
          component={CorrespondenceScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="Account"
          component={AccountScreen}
          options={{ animation: "none" }} />
        <Stack.Screen
          name="BarcodeScanner"
          component={BarcodeScannerScreen}
          options={{ animation: "none" }} />
      </Stack.Navigator>
    </NavigationContainer>
  );
}


===== FILE: app.json =====

{
  "expo": {
    "name": "mobile-OwlReads",
    "slug": "mobile-OwlReads",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "userInterfaceStyle": "light",
    "newArchEnabled": true,
    "splash": {
      "image": "./assets/splash-icon.png",
      "resizeMode": "contain",
      "backgroundColor": "#ffffff"
    },
    "ios": {
      "supportsTablet": true
    },
    "android": {
      "adaptiveIcon": {
        "foregroundImage": "./assets/adaptive-icon.png",
        "backgroundColor": "#ffffff"
      },
      "navigationBar": {
        "visible": true,
        "backgroundColor": "transparent",
        "barStyle": "light-content"
      },
      "androidStatusBar": {
        "backgroundColor": "transparent",
        "barStyle": "dark-content",
        "translucent": true
      },
      "edgeToEdgeEnabled": true,
      "softwareKeyboardLayoutMode": "resize",
      "package": "com.dianamalinetskaya.mobileOwlReads"
    },
    "web": {
      "favicon": "./assets/favicon.png"
    },
    "plugins": [
      "expo-font"
    ],
    "extra": {
      "eas": {
        "projectId": "b0271684-56b9-4608-9f7a-6b403c4e316a"
      }
    }
  }
}

===== FILE: eas.json =====

{
  "cli": {
    "version": ">= 16.28.0",
    "appVersionSource": "remote"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal"
    },
    "preview": {
      "distribution": "internal"
    },
    "production": {
      "autoIncrement": true
    }
  },
  "submit": {
    "production": {}
  }
}


===== FILE: index.js =====

import { registerRootComponent } from 'expo';

import App from './App';

// registerRootComponent calls AppRegistry.registerComponent('main', () => App);
// It also ensures that whether you load the app in Expo Go or in a native build,
// the environment is set up appropriately
registerRootComponent(App);


===== FILE: package.json =====

{
  "name": "mobile-owlreads",
  "license": "0BSD",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "expo start",
    "android": "expo start --android",
    "ios": "expo start --ios",
    "web": "expo start --web"
  },
  "dependencies": {
    "@react-native-async-storage/async-storage": "2.2.0",
    "@react-navigation/bottom-tabs": "^7.8.11",
    "@react-navigation/native": "^7.1.24",
    "@react-navigation/native-stack": "^7.8.5",
    "axios": "^1.13.2",
    "expo": "~54.0.29",
    "expo-camera": "~17.0.10",
    "expo-font": "~14.0.10",
    "expo-image-picker": "~17.0.10",
    "expo-linear-gradient": "~15.0.8",
    "expo-navigation-bar": "~5.0.10",
    "expo-status-bar": "~3.0.9",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-native": "0.81.5",
    "react-native-keyboard-aware-scroll-view": "^0.9.5",
    "react-native-linear-gradient": "^2.8.3",
    "react-native-safe-area-context": "~5.6.0",
    "react-native-screens": "~4.16.0",
    "styled-components": "^6.1.19"
  },
  "private": true
}


===== FILE: components\Add_book_modal.js =====

// components/AddBookModal.js
import React, { useEffect } from "react";
import { Modal, TouchableWithoutFeedback, Platform, View } from "react-native";
import { useNavigation } from "@react-navigation/native"; // <--- 1. Импорт хука
import styled from "styled-components/native";
import * as NavigationBar from 'expo-navigation-bar';
import RedButton from "./Red_button";

// Фон (Overlay)
const Overlay = styled.View`
  flex: 1;
  background-color: rgba(47, 32, 23, 0.6);
  justify-content: center;
  align-items: center;
`;

// Карточка меню
const MenuContainer = styled.View`
  background-color: #FDF5E2;
  width: 90%;
  border-radius: 20px;
  padding-vertical: 30px;
  padding-horizontal: 12px; 
  align-items: center;
  gap: 15px;
  elevation: 10;
  shadow-color: #000;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;
`;

const MenuTitle = styled.Text`
  font-family: "VollkornSC-Regular";
  font-size: 24px;
  color: #890524;
  margin-bottom: 10px;
  text-align: center;
`;

export default function AddBookModal({ visible, onClose, onSearch }) {
  const navigation = useNavigation(); // <--- 2. Получаем объект навигации

  // Логика для затемнения нижнего бара Android
  useEffect(() => {
    if (Platform.OS === 'android') {
      if (visible) {
        NavigationBar.setBackgroundColorAsync("rgba(47, 32, 23, 0.6)");
      } else {
        NavigationBar.setBackgroundColorAsync("#D7C1AB");
      }
    }
  }, [visible]);

  return (
    <Modal
      animationType="fade"
      transparent={true}
      visible={visible}
      onRequestClose={onClose}
      statusBarTranslucent={true}
    >
      <TouchableWithoutFeedback onPress={onClose}>
        <Overlay>
          <TouchableWithoutFeedback>
            <MenuContainer>
              <MenuTitle>Добавить книгу</MenuTitle>
              
              <RedButton
                name="Найти книгу"
                onPress={() => {
                  onClose();
                  navigation.navigate("BookSearch"); // Убедись, что имя совпадает с App.js
                }}
              />

              <RedButton
                name="Найти по штрихкоду"
                onPress={() => {
                  onClose(); // Сначала закрываем меню
                  navigation.navigate("BarcodeScanner"); // Потом переходим
                }}
              />

              <RedButton
                name="Добавить вручную"
                onPress={() => {
                  onClose(); // Сначала закрываем меню
                  navigation.navigate("BookManualAdd"); // Потом переходим
                }}
              />

            </MenuContainer>
          </TouchableWithoutFeedback>
        </Overlay>
      </TouchableWithoutFeedback>
    </Modal>
  );
}

===== FILE: components\Add_new_chat.js =====

// components/Chat_item.js
import React from "react";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { TouchableOpacity, View, Image } from "react-native";

const ChatContainer = styled.View`
  flex-direction: row;
  align-items: center;
  border: 2px solid #a28c75;
  padding: 12px;
  /* убираем margin-vertical */
  margin-vertical: 0px;
`;

const ChatIconWrapper = styled.View`
  width: 70px;
  height: 70px;
  border-radius: 50px;
  background-color: #a28c75;
  justify-content: center;
  align-items: center;
`;

const ChatImage = styled.Image`
  width: 75%;
  height: 75%;
`;

const ChatTextWrapper = styled.View`
  flex-direction: column;
  margin-left: 12px;
  
`;

const ChatTitle = styled.Text`
  font-family: "Inter-Regular";
  font-size: 17px;
  color: #FDF5E2;
  margin-bottom: 7px;
`;


export default function AddNewChatItem() {
  const navigation = useNavigation();
  return (
    <TouchableOpacity onPress={() => navigation.navigate("Сorrespondence")}>
      <ChatContainer>

        <ChatIconWrapper>
          <ChatImage source={require("../assets/add_new_chat_icon.png")} />
        </ChatIconWrapper>

        <ChatTextWrapper>
          <ChatTitle>Начать новую беседу</ChatTitle>
        </ChatTextWrapper>

      </ChatContainer>
    </TouchableOpacity>
  );
}


===== FILE: components\Background_paper.js =====

import React from "react";
import styled from "styled-components/native";

const BackgroundPaper = styled.View`
  flex: 1;
  background-color: #fdf5e2;
  border-top-left-radius: 40px;
  border-top-right-radius: 40px;
  border-width: 2px;
  border-color: #6c5141;
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 300px;
`;

export default BackgroundPaper;


===== FILE: components\Book_card.js =====

import React from 'react';
import styled from 'styled-components/native';
import { TouchableOpacity, View } from 'react-native';
import { TextBox } from './TextBox_props';
import RatingStars from './Rating_starts';

const CardContainer = styled(TouchableOpacity)`
  flex-direction: row;
  align-items: center;
  margin-horizontal: 12px;
  border-radius: 20px;
  background-color: rgba(253, 245, 226);
  padding: 12px;
  shadow-color: #A28C75;
  shadow-offset: 1px 2px;
  shadow-opacity: 0.8;
  shadow-radius: 4px;
  margin-bottom: 10px; 
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
`;

const CoverImage = styled.Image`
  height: ${({ height }) => height || 160}px;
  width: ${({ width }) => width || 110}px;
  border-radius: 7px;
`;

const InfoBlock = styled.View`
  flex: 1;
  flex-direction: column;
  margin-left: 10px;
  justify-content: flex-start;
`;

const TitleText = styled.Text`
  font-family: VollkornSC-Regular;
  font-size: 15px;
  color: #890524;
  margin-top: 6px;
`;

const AuthorText = styled.Text`
  font-family: Regular;
  font-size: 13px;
  color: #2F2017;
  margin-top: 4px;
`;

export const BookCard = ({
  cover,
  category,
  categorycolor,
  title,
  author,
  rating,
  onPress,
}) => {
  return (
    <CardContainer onPress={onPress}>
      <CoverImage source={cover} resizeMode="cover" />
      <InfoBlock>
        <View style={{ alignSelf: 'flex-end' }}>
          <TextBox text={category} color={categorycolor}/>
        </View>
       
        <TitleText>{title}</TitleText>
        <AuthorText>{author}</AuthorText>
        <RatingStars
          rating={rating}
          size={40}
          filledImage={require('../assets/star_filled.png')}
          emptyImage={require('../assets/star_empty.png')}
        />
      </InfoBlock>
    </CardContainer>
  );
};


===== FILE: components\Chat_item.js =====

// components/Chat_item.js
import React from "react";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { TouchableOpacity, View, Image } from "react-native";

const ChatContainer = styled.View`
  flex-direction: row;
  align-items: center;
  border-bottom-width: 2px;
  border-color: #a28c75;
  padding: 12px;
`;


const ChatIconWrapper = styled.View`
  width: 70px;
  height: 70px;
  border-radius: 50px;
  background-color: #a28c75;
  justify-content: center;
  align-items: center;
`;

const ChatImage = styled.Image`
  width: 75%;
  height: 75%;
`;

const ChatTextWrapper = styled.View`
  flex-direction: column;
  margin-left: 12px;
`;

const ChatTitle = styled.Text`
  font-family: "Inter-Regular";
  font-size: 17px;
  color: #FDF5E2;
  margin-bottom: 7px;
`;

const ChatMessage = styled.Text`
  font-family: "Inter-Regular";
  font-size: 12px;
  color: #2F2017;
`;

export default function ChatItem({ title, message }) {
  const navigation = useNavigation();
  return (
    <TouchableOpacity onPress={() => navigation.navigate("Сorrespondence", { title })}>
      <ChatContainer>

        <ChatIconWrapper>
          <ChatImage source={require("../assets/Owl_icon.png")} />
        </ChatIconWrapper>

        <ChatTextWrapper>
          <ChatTitle>{title}</ChatTitle>
          <ChatMessage>{message}</ChatMessage>
        </ChatTextWrapper>

      </ChatContainer>
    </TouchableOpacity>
  );
}


===== FILE: components\Input_field.js =====

import React from 'react';
import styled from 'styled-components/native';

const Wrapper = styled.View`
  margin-horizontal: 32px;
  width: 100%;
`;

const Container = styled.View`
  background-color: #E8DFC9;
  border-radius: 14px;
  padding-horizontal: 14px;
  padding-vertical: 7px;
`;

const StyledInput = styled.TextInput`
  font-family: Inter-Regular;
  font-size: 15px;
  color: #2F2017;
  width: 100%; /* Чтобы текст занимал всю ширину контейнера */
`;

const ErrorText = styled.Text`
  margin-top: 5px;
  color: #890524;
  font-family: Inter-Regular;
  font-size: 12px;
`;

const InputField = ({ 
  value, 
  onChangeText, 
  placeholder, 
  error, 
  style,
  ...props // <--- 1. Собираем все остальные пропсы (onSubmitEditing, keyboardType и т.д.)
}) => {
  return (
    <Wrapper style={style}>
      <Container>
        <StyledInput
          value={value}
          onChangeText={onChangeText}
          placeholder={placeholder}
          placeholderTextColor="rgba(47, 32, 23, 0.3)"
          {...props} // <--- 2. Передаем их в TextInput
        />
      </Container>
      {error ? <ErrorText>{error}</ErrorText> : null}
    </Wrapper>
  );
};

export default InputField;

===== FILE: components\Navigation_bar.js =====

// components/Navigation_bar.js
import React from "react";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { TouchableOpacity, View, Image } from "react-native";

const NavigationContainer = styled.View`
  background-color: #fdf5e2;
  border-radius: 20px;
  padding-top: 7px;
  padding-bottom: 7px;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  width: auto;
  margin-left: 16px;
  margin-right: 16px;
  padding-left: 30px;
  padding-right: 30px;

  position: absolute;
  bottom: 57px;
  left: 0;
  right: 0;
`;

export default function NavigationBar({ icons, onPressOverride }) {
  const navigation = useNavigation();

  return (
    <NavigationContainer>
      {icons.map((icon, index) => (
        <TouchableOpacity
          key={index}
          onPress={() => {
            if (onPressOverride) {
              onPressOverride(icon.screen);
            } else {
              navigation.navigate(icon.screen);
            }
          }}
        >

          <Image
            source={icon.source}
            style={{
              width: icon.name === "add_book" ? 55 : 45,
              height: icon.name === "add_book" ? 55 : 45,
            }}
          />
        </TouchableOpacity>
      ))}
    </NavigationContainer>
  );
}


===== FILE: components\Note_block.js =====

// components/NoteBlock.js
import React from "react";
import { View, TouchableOpacity, Image } from "react-native";
import styled from "styled-components/native";

const BlockContainer = styled.View`
  margin-horizontal: 20px;
  margin-bottom: 10px;
  border-radius: 20px;
  border-width: 2px;
  border-color: #a28c75;
  padding-horizontal: 10px;
  padding-vertical: 15px;
  background-color: #fdf5e2;
`;

const HeaderRow = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
`;

const TitleText = styled.Text`
  font-family: "Inter-Bold";
  font-size: 12px;
  color: #2F2017;
`;

const NoteText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
  margin-top: 10px;
`;

export default function NoteBlock({ text, onEdit, onDelete }) {
  return (
    <BlockContainer>
      <HeaderRow>
        <TitleText>Заметка</TitleText>
        <View style={{ flexDirection: "row", gap: 12 }}>
          <TouchableOpacity onPress={onDelete}>
            <Image source={require("../assets/trash.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
          <TouchableOpacity onPress={onEdit}>
            <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
        </View>
      </HeaderRow>

      <NoteText>{text}</NoteText>
    </BlockContainer>
  );
}


===== FILE: components\Popular_quote.js =====

// components/Popular_quote.js
import React from "react";
import styled from "styled-components/native";

const QuoteContainer = styled.View`
  background-color: #fdf5e2;
  border-radius: 20px;
  padding: 15px;
  flex-direction: column;
  justify-content: center;
  gap: 10px;
  width: auto;
  margin-left: 16px;
  margin-right: 16px;
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
`;

const QuoteText = styled.Text`
  color: #2f2017;
  font-family: "Inter-Regular";
  font-size: 15px;
  font-weight: 400;
  text-align: center;
  align-self: stretch;
`;

const QuoteAuthor = styled.Text`
  color: #890524;
  font-family: "Inter-Regular";
  font-size: 13px;
  font-weight: 400;
  text-align: right;
  align-self: stretch;
`;

export default function Quote({ quote_text, quote_author }) {
  return (
    <QuoteContainer>
      <QuoteText>{quote_text}</QuoteText>
      <QuoteAuthor>{quote_author}</QuoteAuthor>
    </QuoteContainer>
  );
}


===== FILE: components\Quote_block.js =====

// components/QuoteBlock.js
import React from "react";
import { View, TouchableOpacity, Image } from "react-native";
import styled from "styled-components/native";

const BlockContainer = styled.View`
  margin-horizontal: 20px;
  margin-bottom: 10px;
  border-radius: 20px;
  border-width: 2px;
  border-color: #a28c75;
  padding-horizontal: 10px;
  padding-vertical: 15px;
  background-color: #fdf5e2;
`;

const HeaderRow = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
`;

const TitleText = styled.Text`
  font-family: "Inter-Bold";
  font-size: 12px;
  color: #2F2017;
`;

const QuoteText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
  margin-top: 10px;
`;

const AuthorText = styled.Text`
  font-family: "Inter-Italic";
  font-size: 13px;
  color: #890524;
  text-align: right;
  margin-top: 6px;
`;

export default function QuoteBlock({ text, author, onEdit, onDelete }) {
  return (
    <BlockContainer>
      <HeaderRow>
        <TitleText>Цитата</TitleText>
        <View style={{ flexDirection: "row", gap: 12 }}>
          <TouchableOpacity onPress={onDelete}>
            <Image source={require("../assets/trash.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
          <TouchableOpacity onPress={onEdit}>
            <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} />
          </TouchableOpacity>
        </View>
      </HeaderRow>

      <QuoteText>{`« ${text} »`}</QuoteText>
      <AuthorText>@{author}</AuthorText>
    </BlockContainer>
  );
}


===== FILE: components\Rating_starts.js =====

// components/Rating_star.js
import React from 'react';
import styled from 'styled-components/native';
import { TouchableOpacity } from 'react-native';

const StarsRow = styled.View`
  flex-direction: row;
  align-items: center;
`;

const StarImage = styled.Image`
  width: ${({ size }) => size}px;
  height: ${({ size }) => size}px;
  margin: 0 2px;
`;

const RatingStars = ({ 
  rating = 0, 
  size = 40, 
  filledImage, 
  emptyImage,
  onRate
}) => {
  const stars = Array.from({ length: 5 }, (_, i) => i);

  return (
    <StarsRow>
      {stars.map((_, index) => {
        const isFilled = index < rating;
        return (
          <TouchableOpacity key={index} onPress={() => onRate && onRate(index + 1)}>
            <StarImage
              source={isFilled ? filledImage : emptyImage}
              size={size}
            />
          </TouchableOpacity>
        );
      })}
    </StarsRow>
  );
};

export default RatingStars;


===== FILE: components\Red_button.js =====

import React from "react";
import { TouchableOpacity } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { LinearGradient } from "expo-linear-gradient";

const GradientWrapper = styled(LinearGradient)`
  border-radius: 14px;
  
  shadow-color: #000;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
  align-self: stretch;
`;

const ButtonContainer = styled(TouchableOpacity)`
  
  padding-vertical: 20px;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  justify-content: center;
  gap: 10px;
  width: 100%;
`;

const ButtonText = styled.Text`
  color: #FDF5E2;
  font-family: "Inter-Regular";
  font-size: 15px;
  text-align: center;
`;

export default function RedButton({ screen, name, onPress, params }) {
  const navigation = useNavigation();

  const handlePress = () => {
    if (onPress) {
      onPress(); // локальная логика (например setStep)
    } else if (screen) {
      navigation.navigate(screen, params); // переход по навигации
    }
  };

  return (
    <GradientWrapper
      colors={["#890524", "#230109"]}
      locations={[0.17, 1]}
      start={{ x: 0.5, y: 0 }}
      end={{ x: 0.5, y: 1 }}
    >
      <ButtonContainer onPress={handlePress}>
        <ButtonText>{name}</ButtonText>
      </ButtonContainer>
    </GradientWrapper>
  );
}


===== FILE: components\Reply_message_bubble.js =====

import React from "react";
import styled from "styled-components/native";

const BubbleWrapper = styled.View`
  background-color: #FDF5E2;
  padding-horizontal: 15px;
  padding-top: 7px;
  padding-bottom: 4px;
  margin: 6px 12px;
  max-width: 80%;
  align-self: flex-start;

  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  border-bottom-left-radius: 2px;
  border-bottom-right-radius: 20px;
`;

const MessageText = styled.Text`
  color: #2F2017;
  font-family: "Inter-Regular";
  font-size: 15px;
`;

const TimeText = styled.Text`
  color: #A28C75;
  font-family: "Inter-Regular";
  font-size: 12px;
  text-align: right;
`;

export default function ReplyMessageBubble({ text, time }) {
  return (
    <BubbleWrapper>
      <MessageText>{text}</MessageText>
      <TimeText>{time}</TimeText>
    </BubbleWrapper>
  );
}


===== FILE: components\Tab_bar.js =====

// components/Tab_bar.js
import React from 'react';
import styled from 'styled-components/native';

const Container = styled.View`
  height: 48px;
  width: 100%;
  position: absolute;
  bottom: 0px;
`;

export const TabBar = ({color}) => {
  return (
    <Container 
      style={{ backgroundColor: color }}
    />
  );
};



===== FILE: components\TextBox_category.js =====

// components/TextBoxCategory.js
import React from "react";
import styled from "styled-components/native";
import { Image, View } from "react-native";

const hexToRgba = (hex, alpha) => {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
};

const Container = styled.View`
  flex-direction: row;
  align-items: center;
  padding-vertical: 10px;
  padding-horizontal: 15px;
  border-radius: 20px;
  align-self: flex-start;
`;

const StyledText = styled.Text`
  font-family: Inter-Regular;
  font-size: 15px;
  opacity: 1;
  flex: 1;
`;

export const TextBoxCategory = ({ text, color }) => {
  return (
    <Container style={{ backgroundColor: hexToRgba(color, 0.2) }}>
      <StyledText style={{ color }}>{text}</StyledText>
      <Image
        source={require("../assets/chevron_down.png")}
        style={{ width: 24, height: 24 }}
        resizeMode="contain"
      />
    </Container>
  );
};


===== FILE: components\TextBox_props.js =====

// components/TextBow_props.js
import React from 'react';
import styled from 'styled-components/native';

const hexToRgba = (hex, alpha) => {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
};

const Container = styled.View`
  padding-vertical: 5px;
  padding-horizontal: 15px;
  border-radius: 20px;
  align-self: flex-start;
`;

const StyledText = styled.Text`
  font-family: Inter-Regular;
  font-size: 12px;
  opacity: 1;
`;

export const TextBox = ({ text, color }) => {
  return (
    <Container style={{ backgroundColor: hexToRgba(color, 0.2) }}>
      <StyledText style={{ color }}>{text}</StyledText>
    </Container>
  );
};



===== FILE: components\User_message_bubble.js =====

import React from "react";
import styled from "styled-components/native";
import { LinearGradient } from "expo-linear-gradient";

const BubbleWrapper = styled(LinearGradient)`
  padding-horizontal: 15px;
  padding-top: 7px;
  padding-bottom: 4px;
  margin: 6px 12px;
  max-width: 80%;
  align-self: flex-end;

  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  border-bottom-left-radius: 20px;
  border-bottom-right-radius: 2px;
`;

const MessageText = styled.Text`
  color: #FDF5E2;
  font-family: "Inter-Regular";
  font-size: 15px;
`;

const TimeText = styled.Text`
  color: #A28C75;
  font-family: "Inter-Regular";
  font-size: 12px;
  text-align: right;
`;

export default function UserMessageBubble({ text, time }) {
  return (
    <BubbleWrapper
      colors={["#890524", "#230109"]}
      locations={[0.17, 1]}
      start={{ x: 0.5, y: 0 }}
      end={{ x: 0.5, y: 1 }}
    >
      <MessageText>{text}</MessageText>
      <TimeText>{time}</TimeText>
    </BubbleWrapper>
  );
}


===== FILE: screens\AccountScreen.js =====

import React, { useState, useCallback } from "react";
import { View, Image, ScrollView, TouchableOpacity, TouchableWithoutFeedback, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useFocusEffect } from "@react-navigation/native";
import AsyncStorage from '@react-native-async-storage/async-storage';

// Импорты компонентов
import NavigationBar from "../components/Navigation_bar";
import { TabBar } from "../components/Tab_bar";
import AddBookModal from "../components/Add_book_modal"; 
import api from "../src/api/client";

// --- STYLED COMPONENTS (Без изменений) ---
const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  justify-content: center;
  align-items: center;
  text-align: center;
  margin-top: 48px;
`;

const UserContainer = styled.View`
  flex-direction: column;
  align-items: center;
  position: relative;
`;

const MoreButton = styled(TouchableOpacity)`
  align-self: flex-end;
`;

const MenuContainer = styled.View`
  position: absolute;
  top: 40px;
  right: 0px;
  background-color: #fdf5e2;
  border-radius: 8px;
  padding-vertical: 5px;
  padding-left: 15px;
  padding-right: 40px;
  elevation: 6;
  z-index: 10; 
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;
`;

const MenuItem = styled(TouchableOpacity)`
  padding-vertical: 8px;
`;

const MenuText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
`;

const MenuTextLogout = styled(MenuText)`
  color: #890524;
`;

const UserName = styled.Text`
  align-items: center;
  color: #890524;
  display: flex;
  font-family: "VollkornSC-Bold";
  font-size: 25px;
  justify-content: center;
  position: relative;
  text-align: center;
  margin-top: -10px;
`;

const UserEmail = styled.Text`
  align-items: center;
  align-self: stretch;
  color: #2F2017;
  display: flex;
  font-family: "Inter-Regular";
  font-size: 12px;
  justify-content: center;
  text-align: center;
`;

const StatsContainer = styled.View`
  flex-direction: row;
  justify-content: space-around;
  padding-horizontal: 12px;
  gap: 30px;
`;

const StatItem = styled.View`
  flex-direction: column;
  align-items: center;
`;

const StatLabel = styled.Text`
  font-family: "Inter-Medium";
  font-size: 15px;
  color: #2F2017;
  text-align: center;
`;

const StatValue = styled.Text`
  font-family: "VollkornSC-Regular";
  font-size: 20px;
  color: #2F2017;
  text-align: center;
  margin-top: 4px;
`;

const TextLabel = styled.Text`
  font-family: "Inter-Medium";
  font-size: 13px;
  color: #2F2017;
  text-align: center;
`;

const ContainerText = styled.View`
  align-items: center;
  justify-content: center;
  padding-vertical: 5px;
  padding-horizontal: 15px;
  border-radius: 20px;
  background-color: #A28C75;
`;

const StyledText = styled.Text`
  font-family: Inter-Regular;
  font-size: 15px;
  color: #FDF5E2;
`;

export default function AccountScreen() {
  const [menuVisible, setMenuVisible] = useState(false); // Меню профиля (три точки)
  const [isAddBookModalVisible, setAddBookModalVisible] = useState(false); // <--- 2. Состояние для меню добавления
  
  const [loading, setLoading] = useState(true);
  const navigation = useNavigation(); 

  const [userData, setUserData] = useState({
    username: "Загрузка...",
    email: "",
    profile_photo: null
  });

  const [userStats, setUserStats] = useState({
    books_in_library: 0,
    books_read: 0,
    books_favorites: 0,
    favorite_author: "-",
    favorite_genre: "-"
  });

  const icons = [
    { name: "home", source: require("../assets/home.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" }, // screen указывает на модалку
    { name: "message", source: require("../assets/message.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user_active.png"), screen: "Account" },
  ];

  // --- 3. Обработчик навигации (перехватчик) ---
  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setAddBookModalVisible(true); // Открываем меню добавления
    } else {
      navigation.navigate(screenName);
    }
  };

  // Заглушки для действий в меню добавления
  const handleSearchBook = () => {
    setAddBookModalVisible(false);
    console.log("Переход к поиску");
    // navigation.navigate("SearchBook");
  };

  const handleAddManual = () => {
    setAddBookModalVisible(false);
    console.log("Переход к добавлению");
    // navigation.navigate("AddBookManual");
  };

  const handleLogout = async () => {
    try {
      await AsyncStorage.removeItem('userToken');
      await AsyncStorage.removeItem('userId');
      setMenuVisible(false);
      navigation.reset({
        index: 0,
        routes: [{ name: 'Start' }],
      });
    } catch (e) {
      console.error("Ошибка выхода:", e);
    }
  };

  useFocusEffect(
    useCallback(() => {
      const loadData = async () => {
        setLoading(true);
        try {
          const userId = await AsyncStorage.getItem('userId');
          if (!userId) {
            navigation.navigate("Entry");
            return;
          }
          const [userResponse, statsResponse] = await Promise.all([
            api.get(`/api/users_personal_data/${userId}/`),
            api.get(`/api/users_statistics/user/${userId}`)
          ]);
          setUserData(userResponse.data);
          setUserStats(statsResponse.data);
        } catch (error) {
          console.error("Ошибка загрузки профиля:", error);
        } finally {
          setLoading(false);
        }
      };
      loadData();
    }, [])
  );

  if (loading) {
    return (
      <View style={{ flex: 1, backgroundColor: "#D7C1AB", justifyContent: "center", alignItems: "center" }}>
        <ActivityIndicator size="large" color="#890524" />
      </View>
    );
  }

  return (
    <TouchableWithoutFeedback onPress={() => menuVisible && setMenuVisible(false)}>
      <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
        <View style={{ flexDirection: "column" }}>
          <OwlReadsTitle>OwlReads</OwlReadsTitle>
        </View>

        <ScrollView contentContainerStyle={{ paddingHorizontal: 12, gap: 25 }}>
          <UserContainer>
            <MoreButton onPress={() => setMenuVisible(!menuVisible)}>
              <Image
                source={require("../assets/more.png")}
                style={{ width: 35, height: 35 }}
              />
            </MoreButton>

            {menuVisible && (
              <MenuContainer>
                <MenuItem onPress={() => { console.log("Настройка профиля"); setMenuVisible(false); }}>
                  <MenuText>Настройка профиля</MenuText>
                </MenuItem>
                 <MenuItem onPress={handleLogout}>
                  <MenuTextLogout>Выйти из аккаунта</MenuTextLogout>
                </MenuItem>
              </MenuContainer>
            )}

            <Image
              source={
                userData.profile_photo 
                  ? { uri: userData.profile_photo } 
                  : require("../assets/user_icon.png")
              }
              style={{ width: 150, height: 150, borderRadius: 75 }}
            />
          </UserContainer>

          <View style ={{gap: 20}}>
            <View>
              <UserName>{userData.username}</UserName>
              <UserEmail>{userData.email}</UserEmail>
            </View>

            <StatsContainer>
              <StatItem>
                <StatLabel>Всего книг</StatLabel>
                <StatValue>{userStats.books_in_library || 0}</StatValue>
              </StatItem>

              <StatItem>
                <StatLabel>Прочитано</StatLabel>
                <StatValue>{userStats.books_read || 0}</StatValue>
              </StatItem>

              <StatItem>
                <StatLabel>Любимых</StatLabel>
                <StatValue>{userStats.books_favorites || 0}</StatValue>
              </StatItem>
            </StatsContainer>
          </View>

          <View style={{gap: 10, alignItems: "center"}}>
            <TextLabel>Больше всего прочитано книг в жанре</TextLabel>
              <ContainerText>
                <StyledText>{userStats.favorite_genre || "-"}</StyledText>
              </ContainerText>
          </View>

          <View style={{gap: 10, alignItems: "center"}}>
            <TextLabel>Больше всего прочитано книг автора</TextLabel>
              <ContainerText>
                <StyledText>{userStats.favorite_author || "-"}</StyledText>
              </ContainerText>
          </View>
        
        </ScrollView>

        {/* 4. Передаем перехватчик в NavigationBar */}
        <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
        
        {/* 5. Скрываем TabBar, если открыто меню добавления */}
        {!isAddBookModalVisible && <TabBar color={"#D7C1AB"} />}

        {/* 6. Само модальное окно */}
        <AddBookModal 
          visible={isAddBookModalVisible}
          onClose={() => setAddBookModalVisible(false)}
          onSearch={handleSearchBook}
          onAdd={handleAddManual}
        />
      </View>
    </TouchableWithoutFeedback>
  );
}

===== FILE: screens\AddBookManualScreen.js =====

import React, { useState } from "react";
import { View, ScrollView, TouchableOpacity, Image, Text, Alert, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useRoute } from "@react-navigation/native";
import * as ImagePicker from 'expo-image-picker';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { SafeAreaView } from "react-native-safe-area-context";

// Импорт твоих компонентов
import InputField from "../components/Input_field";
import RedButton from "../components/Red_button";
import BackgroundPaper from "../components/Background_paper";
import api from "../src/api/client";

// --- СТИЛИ ---

const Header = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-horizontal: 16px;
  margin-bottom: 20px;
  padding-top: 10px;
`;

const OwlReadsTitle = styled.Text`
  color: #230109;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
`;

const CoverContainer = styled.TouchableOpacity`
  width: 140px;
  height: 200px;
  background-color: #E8DFC9;
  border-radius: 10px;
  align-self: center;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
  border-width: 1px;
  border-color: #890524;
  border-style: dashed;
  overflow: hidden;
`;

const CoverImage = styled.Image`
  width: 100%;
  height: 100%;
`;

const AddCoverText = styled.Text`
  font-family: "Inter-Regular";
  color: #890524;
  text-align: center;
  font-size: 14px;
  margin-top: 5px;
`;

const SectionTitle = styled.Text`
  font-family: "VollkornSC-Bold";
  font-size: 18px;
  color: #2F2017;
  margin-left: 32px;
  margin-bottom: 10px;
  margin-top: 10px;
`;

const CategoriesContainer = styled.ScrollView`
  padding-left: 32px;
  margin-bottom: 20px;
`;

const CategoryChip = styled.TouchableOpacity`
  padding-vertical: 8px;
  padding-horizontal: 16px;
  background-color: ${(props) => (props.selected ? "#890524" : "#E8DFC9")};
  border-radius: 20px;
  margin-right: 10px;
  border-width: 1px;
  border-color: ${(props) => (props.selected ? "#890524" : "transparent")};
`;

const CategoryText = styled.Text`
  font-family: "Inter-Medium";
  color: ${(props) => (props.selected ? "#FDF5E2" : "#2F2017")};
  font-size: 14px;
`;

const FormContainer = styled.View`
  gap: 15px;
  margin-bottom: 30px;
`;

// --- КОМПОНЕНТ ---

export default function AddBookManualScreen() {
  const navigation = useNavigation();
  const route = useRoute();
  const [loading, setLoading] = useState(false);

  // 1. Получаем данные, если пришли с экрана поиска
  const prefilledBook = route.params?.book;

  // 2. Инициализация состояний (если есть данные - подставляем, иначе пусто)
  const [title, setTitle] = useState(prefilledBook?.title || "");
  const [author, setAuthor] = useState(prefilledBook?.author || "");
  const [pages, setPages] = useState(prefilledBook?.pages ? String(prefilledBook.pages) : "");
  const [year, setYear] = useState(prefilledBook?.year ? String(prefilledBook.year) : "");
  const [language, setLanguage] = useState(prefilledBook?.language || "");
  const [description, setDescription] = useState(prefilledBook?.description || "");
  const [isbn, setIsbn] = useState(prefilledBook?.isbn || "");
  
  // Категории
  const categories = ["Читаю", "Хочу прочитать", "Прочитано", "Брошено", "Любимые"];
  const [selectedCategory, setSelectedCategory] = useState("");

  // Обложка
  const [coverUri, setCoverUri] = useState(prefilledBook?.cover || null);

  // Ошибки
  const [errors, setErrors] = useState({});

  // --- Выбор фото из галереи ---
  const pickImage = async () => {
    let result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [2, 3], // Пропорции книги
      quality: 0.5,
    });

    if (!result.canceled) {
      setCoverUri(result.assets[0].uri);
    }
  };

  // --- Сохранение книги ---
  const handleSave = async () => {
    let newErrors = {};
    let valid = true;

    // Валидация
    if (!title.trim()) {
      newErrors.title = "Введите название книги*";
      valid = false;
    }
    if (!author.trim()) {
      newErrors.author = "Введите автора*";
      valid = false;
    }
    if (!selectedCategory) {
      Alert.alert("Ошибка", "Пожалуйста, выберите категорию");
      valid = false;
    }

    setErrors(newErrors);
    if (!valid) return;

    setLoading(true);
    try {
      // Получаем ID пользователя
      const userId = await AsyncStorage.getItem('userId');
      if (!userId) {
        Alert.alert("Ошибка", "Пользователь не авторизован. Пожалуйста, войдите снова.");
        navigation.navigate("Entry");
        return;
      }

      // Подготовка данных для бэкенда
      const payload = {
        title: title,
        author: author,
        category_name: selectedCategory,
        pages: pages ? parseInt(pages) : null,
        year: year ? parseInt(year) : null,
        language: language,
        description: description,
        isbn: isbn,
        // Если ссылка внешняя (http) - отправляем. Если локальная (file://) - пока null.
        cover_url: coverUri && coverUri.startsWith('http') ? coverUri : null 
      };

      // Отправка запроса
      await api.post(`/api/users_book_review/manual?user_id=${userId}`, payload);

      Alert.alert("Успех", "Книга добавлена в вашу библиотеку!", [
        { text: "OK", onPress: () => navigation.navigate("Library") }
      ]);

    } catch (error) {
      console.error("Ошибка сохранения:", error);
      Alert.alert("Ошибка", "Не удалось сохранить книгу. Проверьте соединение.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      
      <SafeAreaView style={{ flex: 1 }}>
        {/* Хедер */}
        <Header>
          <TouchableOpacity onPress={() => navigation.goBack()} style={{ width: 35, height: 35 }}>
            <Image 
              source={require("../assets/chevron_left.png")} 
              style={{ width: 35, height: 35 }} 
              resizeMode="contain" 
            />
          </TouchableOpacity>

          <OwlReadsTitle>OwlReads</OwlReadsTitle>

          <TouchableOpacity onPress={() => {}} style={{ width: 35, height: 35 }}>
            <Image 
              source={require("../assets/more.png")} 
              style={{ width: 35, height: 35 }} 
              resizeMode="contain" 
            />
          </TouchableOpacity>
        </Header>

        <ScrollView contentContainerStyle={{ paddingBottom: 40 }}>
          
          {/* Обложка */}
          <CoverContainer onPress={pickImage}>
            {coverUri ? (
              <CoverImage source={{ uri: coverUri }} resizeMode="cover" />
            ) : (
              <View style={{ alignItems: 'center', gap: 5 }}>
                 <Image 
                   source={require("../assets/add_book.png")} 
                   style={{ width: 40, height: 40, tintColor: '#890524' }} 
                   resizeMode="contain"
                 />
                 <AddCoverText>Добавить{"\n"}обложку</AddCoverText>
              </View>
            )}
          </CoverContainer>

          {/* Обязательные поля */}
          <FormContainer>
            <InputField 
              placeholder="Название книги" 
              value={title} 
              onChangeText={(t) => {setTitle(t); setErrors(prev => ({...prev, title: ""}))}}
              error={errors.title}
              style={{ width: 'auto' }} // Фикс ширины
            />
            <InputField 
              placeholder="Автор" 
              value={author} 
              onChangeText={(t) => {setAuthor(t); setErrors(prev => ({...prev, author: ""}))}}
              error={errors.author}
              style={{ width: 'auto' }} // Фикс ширины
            />
          </FormContainer>

          {/* Категории */}
          <SectionTitle>Категория*</SectionTitle>
          <CategoriesContainer horizontal showsHorizontalScrollIndicator={false}>
            {categories.map((cat) => (
              <CategoryChip 
                key={cat} 
                selected={selectedCategory === cat} 
                onPress={() => setSelectedCategory(cat)}
              >
                <CategoryText selected={selectedCategory === cat}>{cat}</CategoryText>
              </CategoryChip>
            ))}
          </CategoriesContainer>

          {/* Дополнительные поля */}
          <SectionTitle>Дополнительно</SectionTitle>
          <FormContainer>
            <InputField 
              placeholder="ISBN (Штрихкод)" 
              value={isbn} 
              onChangeText={setIsbn} 
              keyboardType="numeric"
              style={{ width: 'auto' }}
            />
            <InputField 
              placeholder="Количество страниц" 
              value={pages} 
              onChangeText={setPages} 
              keyboardType="numeric"
              style={{ width: 'auto' }}
            />
            <InputField 
              placeholder="Год публикации" 
              value={year} 
              onChangeText={setYear} 
              keyboardType="numeric"
              style={{ width: 'auto' }}
            />
            <InputField 
              placeholder="Язык произведения" 
              value={language} 
              onChangeText={setLanguage} 
              style={{ width: 'auto' }}
            />
            <InputField 
              placeholder="Аннотация" 
              value={description} 
              onChangeText={setDescription} 
              style={{ width: 'auto' }}
              multiline={true}
            />
          </FormContainer>

          {/* Кнопка сохранения */}
          <View style={{ marginTop: 10,  marginHorizontal: 32}}>
            {loading ? (
              <ActivityIndicator size="large" color="#890524" />
            ) : (
              <RedButton 
                name="Сохранить" 
                onPress={handleSave} 
              />
            )}
          </View>

        </ScrollView>
      </SafeAreaView>
    </View>
  );
}

===== FILE: screens\BarcodeScannerScreen.js =====

import React, { useState, useEffect } from "react";
import { Text, View, StyleSheet, TouchableOpacity, Image, Alert, ActivityIndicator } from "react-native";
import { CameraView, useCameraPermissions } from "expo-camera";
import { useNavigation } from "@react-navigation/native";
import styled from "styled-components/native";
import api from "../src/api/client";
import RedButton from "../components/Red_button"; // Импортируем твою кнопку

const Overlay = styled.View`
  flex: 1;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: space-between; /* Чтобы разнести элементы */
  padding-vertical: 60px;
  align-items: center;
`;

const ScanArea = styled.View`
  width: 280px;
  height: 200px;
  border-width: 2px;
  border-color: ${(props) => (props.active ? "#890524" : "#fdf5e2")}; /* Меняем цвет, если код пойман */
  border-radius: 20px;
  background-color: transparent;
  justify-content: center;
  align-items: center;
`;

const BackButton = styled.TouchableOpacity`
  position: absolute;
  top: 50px;
  left: 20px;
  z-index: 10;
`;

const StatusText = styled.Text`
  color: #fdf5e2;
  font-family: "Inter-Medium";
  font-size: 14px;
  text-align: center;
  margin-top: 10px;
`;

export default function BarcodeScannerScreen() {
  const [permission, requestPermission] = useCameraPermissions();
  const [tempCode, setTempCode] = useState(null); // Храним код, который "видит" камера сейчас
  const [loading, setLoading] = useState(false);
  const navigation = useNavigation();

  useEffect(() => {
    if (!permission) requestPermission();
  }, []);

  if (!permission || !permission.granted) {
    return (
      <View style={styles.container}>
        <Text style={{ textAlign: "center", color: "#2F2017" }}>Нужен доступ к камере</Text>
        <TouchableOpacity onPress={requestPermission} style={styles.button}>
          <Text style={styles.buttonText}>Разрешить</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Эта функция срабатывает постоянно, пока камера видит штрихкод
  const handleBarcodeDetection = ({ data }) => {
    if (data !== tempCode) {
      setTempCode(data); // Просто запоминаем код в стейт
    }
  };

  // Эта функция срабатывает при нажатии на КРАСНУЮ КНОПКУ
  const handleSearchPress = async () => {
    if (!tempCode) {
      Alert.alert("Внимание", "Пожалуйста, наведите камеру на штрихкод так, чтобы рамка стала красной");
      return;
    }

    setLoading(true);
    try {
      // Наш новый бэкенд с цепочкой вызовов
      const response = await api.get(`/api/literature/isbn/${tempCode}`);
      navigation.navigate("BookManualAdd", { book: response.data });
    } catch (error) {
      if (error.response && error.response.status === 404) {
        // Если вообще не нашли — ведем на форму, но подставляем ISBN
        navigation.navigate("BookManualAdd", { 
          book: { isbn: tempCode, title: "", author: "", source: "manual" } 
        });
      } else {
        Alert.alert("Ошибка", "Не удалось связаться с сервером");
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <View style={styles.container}>
      <BackButton onPress={() => navigation.goBack()}>
        <Image source={require("../assets/chevron_left.png")} style={{ width: 40, height: 40, tintColor: "#FDF5E2" }} />
      </BackButton>

      <CameraView
        style={StyleSheet.absoluteFillObject}
        onBarcodeScanned={handleBarcodeDetection}
        barcodeScannerSettings={{
          barcodeTypes: ["ean13", "ean8", "upc_a"],
        }}
      >
        <Overlay>
          <View style={{ alignItems: 'center', marginTop: 100 }}>
            <ScanArea active={!!tempCode}>
               {tempCode && <Image source={require("../assets/search.png")} style={{width: 50, height: 50, tintColor: '#890524', opacity: 1.5}} />}
            </ScanArea>
            <StatusText>
              {tempCode ? `Код обнаружен: ${tempCode}` : "Наведите камеру на штрихкод"}
            </StatusText>
          </View>

          <View style={{ width: '90%', alignItems: 'center', paddingBottom: 20 }}>
            {loading ? (
              <ActivityIndicator size="large" color="#FDF5E2" />
            ) : (
              <RedButton
                name="Распознать книгу" 
                onPress={handleSearchPress} 
              />
            )}
          </View>
        </Overlay>
      </CameraView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: "#000" },
  button: { backgroundColor: "#890524", padding: 15, borderRadius: 10, alignSelf: "center", marginTop: 20 },
  buttonText: { color: "#FDF5E2", fontWeight: 'bold' }
});

===== FILE: screens\BookScreen.js =====

import React, { useState, useCallback } from "react";
import { View, TouchableOpacity, Image, TouchableWithoutFeedback, ScrollView, TextInput, ActivityIndicator, Alert, Text } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useRoute, useFocusEffect } from "@react-navigation/native";

// Твой настроенный клиент API
import api from "../src/api/client";

import { TabBar } from "../components/Tab_bar";
import { TextBoxCategory } from "../components/TextBox_category";
import { TextBox } from "../components/TextBox_props";
import RedButton from "../components/Red_button";
import RatingStars from "../components/Rating_starts";
import QuoteBlock from "../components/Quote_block";
import NoteBlock from "../components/Note_block";

const OwlReadsTitle = styled.Text`
  color: #230109;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
`;

const MenuContainer = styled.View`
  position: absolute;
  top: 40px;
  right: 0px;
  background-color: #fdf5e2;
  border-radius: 8px;
  padding-vertical: 5px;
  padding-left: 15px;
  padding-right: 40px;
  elevation: 6;
  z-index: 10;
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;
`;

const MenuItem = styled(TouchableOpacity)`
  padding-vertical: 8px;
`;

const MenuTextDelete = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
`;

const ScreenTitle = styled.Text`
  color: #890524;
  font-family: "VollkornSC-Regular";
  font-size: 27px;
  text-align: center;
  margin-top: 20px;
`;

const CardContainer = styled.View`
  flex-direction: row;
  align-items: flex-start;
  margin-horizontal: 20px;
  border-radius: 20px;
  padding: 12px;
`;

const CoverImage = styled.Image`
  height: 160px;
  width: 110px;
  border-radius: 7px;
  background-color: #e0e0e0;
`;

const InfoBlock = styled.View`
  flex: 1;
  flex-direction: column;
  margin-left: 10px;
`;

const LabelText = styled.Text`
  font-family: Inter-SemiBold;
  font-size: 14px;
  color: #890524;
  margin-top: 6px;
`;

const ValueText = styled.Text`
  font-family: Inter-Regular;
  font-size: 15px;
  color: #2F2017;
  margin-top: 2px;
`;

const BlockReview = styled.View`
  margin-horizontal: 20px;
  margin-bottom: 20px;
  border-radius: 20px;
  border-width: 2px;
  border-color: #a28c75;
  padding-horizontal: 10px;
  padding-vertical: 15px;
`;

export default function BookScreen() {
  const navigation = useNavigation();
  const route = useRoute();

  const { reviewId } = route.params || {};

  const [loading, setLoading] = useState(true);
  const [bookData, setBookData] = useState(null);

  const [menuVisible, setMenuVisible] = useState(false);
  const [menuVisibleCategory, setMenuVisibleCategory] = useState(false);
  const [genres, setGenres] = useState([]);
  const [genreMenuVisible, setGenreMenuVisible] = useState(false);
  const [category, setCategory] = useState("Прочитано");

  const [quoteNoteMenuVisible, setQuoteNoteMenuVisible] = useState(false);
  const [newQuoteText, setNewQuoteText] = useState("");
  const [newQuoteAuthor, setNewQuoteAuthor] = useState("");
  const [newNoteText, setNewNoteText] = useState("");
  const [isQuoteMode, setIsQuoteMode] = useState(true);
  const [entries, setEntries] = useState([]);

  const [ratings, setRatings] = useState({
    Общая: 0,
    Персонажи: 0,
    Сюжет: 0,
    "Химия между персонажами": 0,
    Эмоциональность: 0,
    Концовка: 0,
    "Легкость чтения": 0,
  });
  const [ratingMenuVisible, setRatingMenuVisible] = useState(false);

  const ratingImages = {
    Общая: { filled: require("../assets/star_filled.png"), empty: require("../assets/star_empty.png") },
    Персонажи: { filled: require("../assets/diamond_filled.png"), empty: require("../assets/diamond_empty.png") },
    Сюжет: { filled: require("../assets/fire_filled.png"), empty: require("../assets/fire_empty.png") },
    "Химия между персонажами": { filled: require("../assets/heart_filled.png"), empty: require("../assets/heart_empty.png") },
    Эмоциональность: { filled: require("../assets/emoji_filled.png"), empty: require("../assets/emoji_empty.png") },
    Концовка: { filled: require("../assets/moon_filled.png"), empty: require("../assets/moon_empty.png") },
    "Легкость чтения": { filled: require("../assets/thunder_filled.png"), empty: require("../assets/thunder_empty.png") },
  };

  const fetchBookDetails = async () => {
    if (!reviewId) {
      setLoading(false);
      return;
    }

    try {
      setLoading(true);
      // Путь /api/users_book_review/{id}
      const response = await api.get(`/api/users_book_review/${reviewId}`);
      const data = response.data;

      setBookData(data);
      setCategory(data.category_name);

      if (data.genres) {
        setGenres(data.genres.map((g) => g.name));
      }

      if (data.rating) {
        setRatings({
          Общая: data.rating.total_rating || 0,
          Персонажи: data.rating.characters_rating || 0,
          Сюжет: data.rating.plot_rating || 0,
          "Химия между персонажами": data.rating.relations_rating || 0,
          Эмоциональность: data.rating.emotionality_rating || 0,
          Концовка: data.rating.ending_rating || 0,
          "Легкость чтения": data.rating.easy_reading_rating || 0,
        });
      }

      const mappedQuotes = data.quotes.map(q => ({ type: "quote", text: q.text, author: q.quote_author, id: q.id }));
      const mappedNotes = data.notes.map(n => ({ type: "note", text: n.text, id: n.id }));
      setEntries([...mappedQuotes, ...mappedNotes]);

    } catch (error) {
      console.error("Ошибка при загрузке книги:", error);
      Alert.alert("Ошибка", "Не удалось загрузить данные о книге");
    } finally {
      setLoading(false);
    }
  };

  useFocusEffect(
    useCallback(() => {
      fetchBookDetails();
    }, [reviewId])
  );

  const handleDeleteBook = async () => {
    try {
      await api.delete(`/api/users_book_review/reviews/${reviewId}/`);
      setMenuVisible(false);
      navigation.goBack();
    } catch (error) {
      console.error(error);
      Alert.alert("Ошибка", "Не удалось удалить книгу");
    }
  };

  const handleSelectCategory = async (newCategory) => {
    try {
      // 1. Сразу обновляем UI, чтобы пользователь не ждал (оптимистичное обновление)
      setCategory(newCategory);
      setMenuVisibleCategory(false);

      // 2. Отправляем запрос на сервер
      await api.patch(`/api/users_book_review/reviews/${reviewId}/category`, {
        category_name: newCategory
      });

      console.log("Категория успешно обновлена на сервере");

    } catch (error) {
      console.error("Ошибка обновления категории:", error);
      Alert.alert("Ошибка", "Не удалось обновить категорию");
      // Если ошибка, можно вернуть старое значение, но пока оставим так
    }
  };

  const handleSaveEntry = async () => {
    try {
      if (isQuoteMode) {
        if (newQuoteText.trim()) {
          await api.post(`/api/users_book_quotes/`, {
            text: newQuoteText,
            quote_author: newQuoteAuthor,
            review_id: reviewId
          });
          setNewQuoteText("");
          setNewQuoteAuthor("");
        }
      } else {
        if (newNoteText.trim()) {
          await api.post(`/api/users_book_notes/`, {
            text: newNoteText,
            review_id: reviewId
          });
          setNewNoteText("");
        }
      }
      setQuoteNoteMenuVisible(false);
      fetchBookDetails();
    } catch (error) {
      console.error("Ошибка сохранения:", error);
      Alert.alert("Ошибка", "Не удалось сохранить");
    }
  };

  const handleSaveRating = async () => {
    try {
      // Мы просто отправляем POST запрос.
      // Благодаря изменениям на бэкенде, он сам поймет:
      // если рейтинг уже есть -> обновит его,
      // если нет -> создаст новый.
      await api.post(`/api/users_book_rating/`, {
        review_id: reviewId,
        total_rating: ratings["Общая"],
        characters_rating: ratings["Персонажи"],
        plot_rating: ratings["Сюжет"],
        relations_rating: ratings["Химия между персонажами"],
        emotionality_rating: ratings["Эмоциональность"],
        ending_rating: ratings["Концовка"],
        easy_reading_rating: ratings["Легкость чтения"]
      });

      // Обновляем данные на экране, чтобы увидеть изменения
      await fetchBookDetails();

      setRatingMenuVisible(false);
      Alert.alert("Успех", "Рейтинг сохранен!");
    } catch (error) {
      console.error(error);
      Alert.alert("Ошибка", "Не удалось сохранить рейтинг");
    }
  };

  if (loading) {
    return (
      <View style={{ flex: 1, backgroundColor: "#fdf5e2", justifyContent: "center", alignItems: "center" }}>
        <ActivityIndicator size="large" color="#890524" />
      </View>
    );
  }

  return (
    <TouchableWithoutFeedback onPress={() => menuVisible && setMenuVisible(false)}>
      <View style={{ flex: 1, backgroundColor: "#fdf5e2" }}>
        <View style={{ flexDirection: "row", alignItems: "center", justifyContent: "space-between", marginTop: 48, marginHorizontal: 23, position: "relative" }}>
          <TouchableOpacity onPress={() => navigation.goBack()} style={{ width: 35, height: 35 }}>
            <Image source={require("../assets/chevron_left.png")} style={{ width: 35, height: 35 }} resizeMode="contain" />
          </TouchableOpacity>

          <OwlReadsTitle>OwlReads</OwlReadsTitle>

          <TouchableOpacity onPress={() => setMenuVisible(!menuVisible)} style={{ width: 35, height: 35 }}>
            <Image source={require("../assets/more.png")} style={{ width: 35, height: 35 }} resizeMode="contain" />
          </TouchableOpacity>

          {menuVisible && (
            <MenuContainer>
              <MenuItem onPress={handleDeleteBook}>
                <MenuTextDelete>Удалить книгу</MenuTextDelete>
              </MenuItem>
            </MenuContainer>
          )}
        </View>

        <ScrollView contentContainerStyle={{ paddingBottom: 50 }}>
          <ScreenTitle>Книжный отзыв</ScreenTitle>

          <CardContainer>
            {bookData?.cover_url ? (
              <CoverImage source={{ uri: bookData.cover_url }} resizeMode="cover" />
            ) : (
              <CoverImage source={require("../assets/default_cover_book.png")} resizeMode="cover" />
            )}

            <InfoBlock>
              <LabelText>Название</LabelText>
              <ValueText style={{ fontFamily: "Inter-Bold" }}>{bookData?.title || "Без названия"}</ValueText>

              <LabelText>Автор</LabelText>
              <ValueText>{bookData?.author || "Неизвестно"}</ValueText>

              <LabelText>Количество страниц</LabelText>
              <ValueText>{bookData?.pages || "-"}</ValueText>

              <LabelText>Год публикации</LabelText>
              <ValueText>{bookData?.year || "-"}</ValueText>
            </InfoBlock>
          </CardContainer>

          <BlockReview style={{ gap: 8 }}>
            <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Аннотация</ValueText>
            <ValueText>{bookData?.description || "Описание отсутствует."}</ValueText>
          </BlockReview>

          <View style={{ marginHorizontal: 20, marginBottom: 20, gap: 8 }}>
            <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Категория</ValueText>
            <TouchableOpacity onPress={() => setMenuVisibleCategory(!menuVisibleCategory)}>
              <TextBoxCategory text={category} color="#AB66FF" />
            </TouchableOpacity>

            {menuVisibleCategory && (
              <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, borderWidth: 2, borderColor: "#a28c75", paddingVertical: 5, paddingHorizontal: 10, gap: 6 }}>
                {["Прочитано", "Читаю", "Хочу прочитать", "Брошено", "Любимые"].map((item) => (
                  <TouchableOpacity key={item} onPress={() => handleSelectCategory(item)}>
                    <ValueText>{item}</ValueText>
                  </TouchableOpacity>
                ))}
              </View>
            )}
          </View>

          <BlockReview>
            <TouchableOpacity style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }} onPress={() => setGenreMenuVisible(true)}>
              <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Жанры</ValueText>
              <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} resizeMode="contain" />
            </TouchableOpacity>

            <View style={{ flexDirection: "row", flexWrap: "wrap", gap: 8, marginTop: 10 }}>
              {genres.length > 0 ? (
                genres.map((g) => <TextBox key={g} text={g} color="#890524" />)
              ) : (
                <ValueText style={{ color: '#999', fontSize: 13 }}>Жанры не выбраны</ValueText>
              )}
            </View>
          </BlockReview>

          <BlockReview>
            <TouchableOpacity style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }} onPress={() => setRatingMenuVisible(true)}>
              <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12 }}>Оценка</ValueText>
              <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} resizeMode="contain" />
            </TouchableOpacity>

            <View style={{ marginTop: 10, gap: 10 }}>
              <View style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }}>
                <ValueText>Общая</ValueText>
                <RatingStars rating={ratings["Общая"]} size={40} filledImage={require("../assets/star_filled.png")} emptyImage={require("../assets/star_empty.png")} />
              </View>
              {Object.entries(ratings).map(([key, value]) => {
                if (key === "Общая" || value === 0) return null;
                return (
                  <View key={key} style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }}>
                    <ValueText style={{ flexShrink: 1, flexWrap: "wrap", fontSize: 12 }}>{key}</ValueText>
                    <RatingStars rating={value} size={35} filledImage={ratingImages[key].filled} emptyImage={ratingImages[key].empty} />
                  </View>
                );
              })}
            </View>
          </BlockReview>

          <ValueText style={{ fontFamily: "Inter-Bold", fontSize: 12, textAlign: "center", marginVertical: 10 }}>Цитаты / Заметки</ValueText>

          <BlockReview style={{ paddingVertical: 12 }}>
            <TouchableOpacity style={{ flexDirection: "row", justifyContent: "space-between", alignItems: "center" }} onPress={() => { setIsQuoteMode(true); setQuoteNoteMenuVisible(true); }}>
              <ValueText style={{ fontSize: 13 }}>Добавить цитату / заметку</ValueText>
              <Image source={require("../assets/pencil.png")} style={{ width: 25, height: 25 }} resizeMode="contain" />
            </TouchableOpacity>
          </BlockReview>

          {entries.map((entry, index) => {
            if (entry.type === "quote") {
              return (
                <QuoteBlock
                  key={`quote-${entry.id || index}`}
                  text={entry.text}
                  author={entry.author}
                  onEdit={() => console.log("Редактировать цитату", entry.id)}
                  onDelete={async () => {
                    try {
                      // Удаляем с сервера
                      await api.delete(`/api/users_book_quotes/${entry.id}/`);
                      // Удаляем из локального стейта
                      setEntries(entries.filter((_, i) => i !== index));
                    } catch (error) {
                      console.error("Ошибка удаления цитаты:", error);
                      Alert.alert("Ошибка", "Не удалось удалить цитату");
                    }
                  }}
                />
              );
            }
            if (entry.type === "note") {
              return (
                <NoteBlock
                  key={`note-${entry.id || index}`}
                  text={entry.text}
                  onEdit={() => console.log("Редактировать заметку", entry.id)}
                  onDelete={async () => {
                    try {
                      // Удаляем с сервера
                      await api.delete(`/api/users_book_notes/${entry.id}/`);
                      // Удаляем из локального стейта
                      setEntries(entries.filter((_, i) => i !== index));
                    } catch (error) {
                      console.error("Ошибка удаления заметки:", error);
                      Alert.alert("Ошибка", "Не удалось удалить заметку");
                    }
                  }}
                />
              );
            }
            return null;
          })}

          {bookData?.isbn ? (
            <View style={{ marginTop: 10, marginBottom: 20, alignItems: "center", opacity: 0.5 }}>
              <Text style={{
                fontFamily: "Inter-Regular",
                fontSize: 10,
                color: "#2F2017"
              }}>
                ISBN: {bookData.isbn}
              </Text>
            </View>
          ) : null}
        </ScrollView>

        {/* --- Модалка жанров --- */}
        {genreMenuVisible && (
          <View style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, backgroundColor: "rgba(0,0,0,0.5)", justifyContent: "center", alignItems: "center", padding: 20 }}>
            <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, padding: 20, width: "100%", maxHeight: "70%" }}>
              <ScrollView>
                {["Young adult", "Античная литература", "Белорусская литература", "Биография, мемуары", "Бизнес-книги", "Боевик", "Детектив", "Детская литература", "Журнал, газета, статья", "Зарубежная литература", "Здоровье, медицина", "Историческая литература", "Комедия", "Комикс, манга, манхва, вебтун", "Культура, искусство", "Мифы, легенды, эпос", "На иностранном языке", "Научно-популярная литература", "Научная фантастика", "Нон-фикшн", "Приключения", "Психология", "Пьеса", "Религия", "Роман", "Русская классика", "Стихи, поэзия", "Техническая литература", "Триллер", "Ужасы, мистика", "Учебная литература", "Фантастика", "Философия", "Фэнтези", "Энциклопедия, справочник", "18+"].map((item) => (
                  <TouchableOpacity key={item} onPress={() => genres.includes(item) ? setGenres(genres.filter((g) => g !== item)) : setGenres([...genres, item])} style={{ paddingVertical: 8 }}>
                    <ValueText style={{ color: genres.includes(item) ? "#890524" : "#2F2017", fontFamily: genres.includes(item) ? "Inter-Bold" : "Inter-Regular" }}>{item}</ValueText>
                  </TouchableOpacity>
                ))}
              </ScrollView>
            </View>
            <RedButton
              name="Сохранить"
              onPress={async () => {
                try {
                  // Отправляем массив выбранных жанров на сервер
                  await api.put(`/api/users_book_review/reviews/${reviewId}/genres`, {
                    genres: genres // массив строк ["Фэнтези", "Детектив"]
                  });

                  setGenreMenuVisible(false);
                  Alert.alert("Успех", "Жанры обновлены!");

                  // Обновляем данные на экране (чтобы убедиться, что всё сохранилось)
                  fetchBookDetails();

                } catch (error) {
                  console.error("Ошибка обновления жанров:", error);
                  Alert.alert("Ошибка", "Не удалось сохранить жанры");
                }
              }}
            />
          </View>
        )}

        {/* --- Модалка рейтинга --- */}
        {ratingMenuVisible && (
          <View style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, backgroundColor: "rgba(0,0,0,0.5)", justifyContent: "center", alignItems: "center", padding: 20 }}>
            <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, padding: 20, width: "100%", maxHeight: "70%" }}>
              <ScrollView>
                {Object.keys(ratings).map((key) => (
                  <View key={key} style={{ marginBottom: 20 }}>
                    <ValueText style={{ marginBottom: 6 }}>{key}</ValueText>
                    <RatingStars rating={ratings[key]} size={50} filledImage={ratingImages[key].filled} emptyImage={ratingImages[key].empty} onRate={(newRating) => setRatings({ ...ratings, [key]: newRating })} />
                  </View>
                ))}
              </ScrollView>
            </View>
            <RedButton name="Сохранить" onPress={handleSaveRating} />
          </View>
        )}

        {/* --- Модалка цитат/заметок --- */}
        {quoteNoteMenuVisible && (
          <View style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, backgroundColor: "rgba(0,0,0,0.5)", justifyContent: "center", alignItems: "center", padding: 20 }}>
            <View style={{ backgroundColor: "#fdf5e2", borderRadius: 20, padding: 20, width: "100%", maxHeight: "70%" }}>
              <ScrollView>
                <View style={{ flexDirection: "row", justifyContent: "space-around", marginBottom: 15 }}>
                  <TouchableOpacity onPress={() => setIsQuoteMode(true)}><ValueText style={{ fontFamily: isQuoteMode ? "Inter-Bold" : "Inter-Regular", color: isQuoteMode ? "#890524" : "#2F2017" }}>Цитата</ValueText></TouchableOpacity>
                  <TouchableOpacity onPress={() => setIsQuoteMode(false)}><ValueText style={{ fontFamily: !isQuoteMode ? "Inter-Bold" : "Inter-Regular", color: !isQuoteMode ? "#890524" : "#2F2017" }}>Заметка</ValueText></TouchableOpacity>
                </View>
                {isQuoteMode ? (
                  <>
                    <ValueText style={{ marginBottom: 6 }}>Текст цитаты</ValueText>
                    <TextInput style={{ borderWidth: 1, borderColor: "#a28c75", borderRadius: 8, padding: 8, marginBottom: 12 }} multiline value={newQuoteText} onChangeText={setNewQuoteText} placeholder="Введите цитату..." />
                    <ValueText style={{ marginBottom: 6 }}>Автор</ValueText>
                    <TextInput style={{ borderWidth: 1, borderColor: "#a28c75", borderRadius: 8, padding: 8, marginBottom: 12 }} value={newQuoteAuthor} onChangeText={setNewQuoteAuthor} placeholder="Введите автора..." />
                  </>
                ) : (
                  <>
                    <ValueText style={{ marginBottom: 6 }}>Текст заметки</ValueText>
                    <TextInput style={{ borderWidth: 1, borderColor: "#a28c75", borderRadius: 8, padding: 8, marginBottom: 12 }} multiline value={newNoteText} onChangeText={setNewNoteText} placeholder="Введите заметку..." />
                  </>
                )}
              </ScrollView>
            </View>
            <RedButton name="Сохранить" onPress={handleSaveEntry} />
          </View>
        )}

        <TabBar color={"#fdf5e2"} />
      </View>
    </TouchableWithoutFeedback>
  );
}

===== FILE: screens\BookSearchScreen.js =====

import React, { useState } from "react";
import { View, FlatList, TouchableOpacity, Image, ActivityIndicator, Text, Keyboard } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import { SafeAreaView } from "react-native-safe-area-context";
import axios from "axios"; 
import api from "../src/api/client"; // Наш клиент для бэкенда

import InputField from "../components/Input_field";

// ... (Стили Header, OwlReadsTitle оставляем без изменений) ...
const Header = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-horizontal: 16px;
  margin-bottom: 20px;
  padding-top: 10px;
`;

const OwlReadsTitle = styled.Text`
  color: #230109;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
`;

const ResultItem = styled.TouchableOpacity`
  flex-direction: row;
  background-color: #FDF5E2;
  border-radius: 12px;
  padding: 10px;
  margin-horizontal: 16px;
  margin-bottom: 12px;
  elevation: 3;
  shadow-color: #000;
  shadow-offset: 0px 2px;
  shadow-opacity: 0.1;
  shadow-radius: 4px;
  border-width: 1px;
  /* Если книга из нашей базы - подсветим рамку */
  border-color: ${({ isLocal }) => (isLocal ? "#890524" : "transparent")};
`;

const BookCover = styled.Image`
  width: 60px;
  height: 90px;
  border-radius: 4px;
  background-color: #E8DFC9;
`;

const BookInfo = styled.View`
  flex: 1;
  margin-left: 12px;
  justify-content: center;
`;

const BookTitle = styled.Text`
  font-family: "VollkornSC-Bold";
  font-size: 16px;
  color: #890524;
  margin-bottom: 4px;
`;

const BookAuthor = styled.Text`
  font-family: "Inter-Medium";
  font-size: 14px;
  color: #2F2017;
`;

const SourceBadge = styled.Text`
  font-family: "Inter-Regular";
  font-size: 10px;
  color: #A28C75;
  margin-top: 4px;
`;

const EmptyText = styled.Text`
  font-family: "Inter-Regular";
  font-size: 14px;
  color: #2F2017;
  text-align: center;
  margin-top: 20px;
  opacity: 0.6;
`;

const SearchRow = styled.View`
  flex-direction: row;
  align-items: center;
  margin-horizontal: 16px;
  margin-bottom: 20px;
  gap: 10px;
`;

const SearchButton = styled.TouchableOpacity`
  background-color: #890524;
  padding: 12px;
  border-radius: 14px;
  justify-content: center;
  align-items: center;
`;

export default function SearchBookScreen() {
  const navigation = useNavigation();
  const [query, setQuery] = useState("");
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);

  const handleSearch = async () => {
    if (!query.trim()) return;
    
    Keyboard.dismiss();
    setLoading(true);
    setResults([]); // Очищаем старые результаты
    
    console.log("Начинаем поиск:", query);

    try {
      // Запускаем два запроса параллельно: к нашему API и к Google
      const [localResponse, googleResponse] = await Promise.allSettled([
        api.get(`/api/literature/search?q=${query}`),
        axios.get(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=10`)
      ]);

      let combinedResults = [];

      // 1. Обрабатываем ответ от НАШЕГО сервера
      if (localResponse.status === 'fulfilled') {
        const localBooks = localResponse.value.data.map(book => ({
          id: `local_${book.id}`, // Уникальный ID
          originalId: book.id,    // ID в нашей БД
          title: book.title,
          author: book.author,
          year: book.year,
          cover: book.cover_url,
          source: 'local'         // Метка источника
        }));
        combinedResults = [...combinedResults, ...localBooks];
      }

      // 2. Обрабатываем ответ от Google Books
      if (googleResponse.status === 'fulfilled') {
        const items = googleResponse.value.data.items || [];
        const googleBooks = items.map((item) => {
          const info = item.volumeInfo;
          return {
            id: item.id,
            title: info.title,
            author: info.authors ? info.authors.join(", ") : "Неизвестный автор",
            pages: info.pageCount,
            year: info.publishedDate ? parseInt(info.publishedDate.substring(0, 4)) : null,
            language: info.language,
            description: info.description,
            cover: info.imageLinks?.thumbnail?.replace('http://', 'https://') || null,
            source: 'google'
          };
        });
        combinedResults = [...combinedResults, ...googleBooks];
      }

      setResults(combinedResults);

    } catch (error) {
      console.error("Ошибка поиска:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleSelectBook = (book) => {
    // Передаем книгу на экран добавления
    // Если source === 'local', мы знаем, что книга уже есть в БД (можно передать её ID)
    // Если source === 'google', мы просто заполняем поля
    navigation.navigate("BookManualAdd", { book: book });
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#FDF5E2" }}>
      
      <SafeAreaView style={{ flex: 1 }}>
        <Header>
          <TouchableOpacity onPress={() => navigation.goBack()} style={{ width: 35, height: 35 }}>
            <Image source={require("../assets/chevron_left.png")} style={{ width: 35, height: 35 }} resizeMode="contain" />
          </TouchableOpacity>
          <OwlReadsTitle>OwlReads</OwlReadsTitle>
          <View style={{ width: 35 }} />
        </Header>

        {/* Обновленная строка поиска */}
        <SearchRow>
          <View style={{ flex: 1 }}>
            <InputField 
              placeholder="Название или автор..." 
              value={query}
              onChangeText={setQuery}
              style={{ width: 'auto', marginHorizontal: 0 }} // Убираем отступы самого поля, так как они есть у SearchRow
              
              // Теперь эти пропсы будут работать благодаря исправлению в Шаге 1:
              returnKeyType="search"
              onSubmitEditing={handleSearch} 
            />
          </View>

          <SearchButton onPress={handleSearch}>
            <Image 
              source={require("../assets/search.png")} // Убедись, что есть иконка лупы, или используй add_book временно
              style={{ width: 24, height: 24, tintColor: '#FDF5E2' }} 
            />
          </SearchButton>
        </SearchRow>

        {loading ? (
          <ActivityIndicator size="large" color="#890524" style={{ marginTop: 20 }} />
        ) : (
          <FlatList
            data={results}
            keyExtractor={(item) => item.id}
            contentContainerStyle={{ paddingBottom: 40 }}
            ListEmptyComponent={
              <EmptyText>
                {query ? "Ничего не найдено" : "Введите запрос для поиска"}
              </EmptyText>
            }
            renderItem={({ item }) => (
              <ResultItem 
                onPress={() => handleSelectBook(item)}
                isLocal={item.source === 'local'} // Передаем проп для стиля
              >
                {item.cover ? (
                  <BookCover source={{ uri: item.cover }} resizeMode="cover" />
                ) : (
                  <BookCover source={require("../assets/default_cover_book.png")} resizeMode="cover" />
                )}
                
                <BookInfo>
                  <BookTitle numberOfLines={2}>{item.title}</BookTitle>
                  <BookAuthor numberOfLines={1}>{item.author}</BookAuthor>
                  <SourceBadge>
                    {item.source === 'local' ? "В библиотеке OwlReads" : "Google Books"}
                  </SourceBadge>
                </BookInfo>
              </ResultItem>
            )}
          />
        )}

      </SafeAreaView>
    </View>
  );
}

===== FILE: screens\ChatsScreen.js =====

import React, { useState } from "react";
import { View, FlatList } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native"; // <--- 1. Импорт навигации

// Импорты компонентов
import NavigationBar from "../components/Navigation_bar";
import ChatItem from "../components/Chat_item";
import AddNewChatItem from "../components/Add_new_chat";
import { TabBar } from "../components/Tab_bar";
import AddBookModal from "../components/Add_book_modal"; // <--- 2. Импорт модалки

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

export default function ChatsScreen() {
  const navigation = useNavigation(); // <--- 3. Хук навигации
  const [isAddBookModalVisible, setAddBookModalVisible] = useState(false); // <--- 4. Состояние модалки

  const icons = [
    { name: "home", source: require("../assets/home.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" }, // <--- 5. Указываем screen для перехвата
    { name: "message", source: require("../assets/message_active.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user.png"), screen: "Account" },
  ];

  const chats = [
    // Пока пустой список, как в твоем примере
  ];

  // --- 6. Логика перехвата нажатия ---
  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setAddBookModalVisible(true);
    } else {
      navigation.navigate(screenName);
    }
  };

  // Заглушки для действий
  const handleSearchBook = () => {
    setAddBookModalVisible(false);
    console.log("Поиск книги");
    // navigation.navigate("SearchBook");
  };

  const handleAddManual = () => {
    setAddBookModalVisible(false);
    console.log("Добавление вручную");
    // navigation.navigate("AddBookManual");
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <OwlReadsTitle>OwlReads</OwlReadsTitle>

      <FlatList
        data={chats}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <ChatItem title={item.title} message={item.message} />
        )}
        showsVerticalScrollIndicator={false}
        ListHeaderComponent={<AddNewChatItem />}
        contentContainerStyle={{ paddingBottom: 130 }}
      />

      {/* 7. Передаем перехватчик */}
      <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
      
      {/* 8. Скрываем TabBar при открытии меню */}
      {!isAddBookModalVisible && <TabBar color={"#D7C1AB"}/>}

      {/* 9. Модальное окно */}
      <AddBookModal 
        visible={isAddBookModalVisible}
        onClose={() => setAddBookModalVisible(false)}
        onSearch={handleSearchBook}
        onAdd={handleAddManual}
      />
    </View>
  );
}

===== FILE: screens\CorrespondenceScreen.js =====

import React, { useState, useRef, useEffect } from "react";
import { View, Image, TouchableOpacity, ScrollView } from "react-native";
import styled from "styled-components/native";
import { TabBar } from "../components/Tab_bar";
import UserMessageBubble from "../components/User_message_bubble";
import ReplyMessageBubble from "../components/Reply_message_bubble";

const HeaderWrapper = styled.View`
  background-color: #fdf5e2;
  border-bottom-left-radius: 18px;
  border-bottom-right-radius: 18px;
`;

const HeaderContainer = styled.View`
  flex-direction: row;
  align-items: center;
  padding-horizontal: 16px;
  padding-vertical: 10px;
  margin-top: 43px;
`;

const IconButton = styled(TouchableOpacity)`
  width: 35px;
  height: 35px;
`;

const ChatBlock = styled.View`
  flex: 1;
  flex-direction: row;
  align-items: center;
  margin: 0 12px;
`;

const ChatIconWrapper = styled.View`
  width: 50px;
  height: 50px;
  border-radius: 50px;
  background-color: #a28c75;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
`;

const OwlIcon = styled.Image`
  width: 37px;
  height: 37px;
`;

const ChatTitle = styled.Text`
  color: #2F2017;
  font-family: "Inter-Regular";
  font-size: 16px;
  font-weight: 400;
  flex-shrink: 1;
`;

const InputWrapper = styled.View`
  flex-direction: row;
  align-items: center;
  background-color: #fdf5e2;
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;
  padding: 10px 16px;
  margin-bottom: 48px;
`;

const MessageInput = styled.TextInput`
  flex: 1;
  font-family: "Inter-Regular";
  font-size: 16px;
  color: #2f2017;
  padding-vertical: 8px;
  padding-horizontal: 12px;
`;

export default function CorrespondenceScreen({ navigation }) {
  const [message, setMessage] = useState("");
  const [messages, setMessages] = useState([]);
  const scrollViewRef = useRef(null);

  const getCurrentTime = () => {
    const now = new Date();
    return `${now.getHours()}:${String(now.getMinutes()).padStart(2, "0")}`;
  };

  const handleSend = () => {
    if (message.trim().length > 0) {
      const userMsg = {
        type: "user",
        text: message,
        time: getCurrentTime(),
      };
      setMessages((prev) => [...prev, userMsg]);
      setMessage("");

      // Автоответ от системы
      setTimeout(() => {
        const replyMsg = {
          type: "system",
          text: "Это автоответ от Букли 🦉",
          time: getCurrentTime(),
        };
        setMessages((prev) => [...prev, replyMsg]);
      }, 500);
    }
  };

  // Автоскролл вниз при добавлении нового сообщения
  useEffect(() => {
    if (scrollViewRef.current) {
      scrollViewRef.current.scrollToEnd({ animated: true });
    }
  }, [messages]);

  return (
    <View style={{ flex: 1, backgroundColor: "#A28C75" }}>
      {/* Верхняя шапка */}
      <HeaderWrapper>
        <HeaderContainer>
          <IconButton onPress={() => navigation.goBack()}>
            <Image
              source={require("../assets/chevron_left.png")}
              style={{ width: 35, height: 35 }}
            />
          </IconButton>

          <ChatBlock>
            <ChatIconWrapper>
              <OwlIcon source={require("../assets/Owl_icon.png")} />
            </ChatIconWrapper>
            <ChatTitle numberOfLines={1}>Букля</ChatTitle>
          </ChatBlock>

          <IconButton>
            <Image
              source={require("../assets/more.png")}
              style={{ width: 35, height: 35 }}
            />
          </IconButton>
        </HeaderContainer>
      </HeaderWrapper>

      <View style={{ flex: 1, backgroundColor: "#A28C75" }}>
        {/* Основное содержимое чата */}
        <ScrollView
          ref={scrollViewRef}
          contentContainerStyle={{ flexGrow: 1, justifyContent: "flex-end" }}
          keyboardShouldPersistTaps="handled"
        >
          {messages.map((msg, index) =>
            msg.type === "user" ? (
              <UserMessageBubble key={index} text={msg.text} time={msg.time} />
            ) : (
              <ReplyMessageBubble key={index} text={msg.text} time={msg.time} />
            )
          )}
        </ScrollView>

        {/* Нижний блок ввода */}
        <InputWrapper>
          <MessageInput
            placeholder="Введите сообщение..."
            placeholderTextColor="#A28C75"
            value={message}
            onChangeText={setMessage}
          />
          <IconButton onPress={handleSend}>
            <Image
              source={require("../assets/send.png")}
              style={{ width: 35, height: 35 }}
            />
          </IconButton>
        </InputWrapper>

        {/* Нижняя панель */}
        <TabBar color={"#FDF5E2"} />
      </View>
    </View>
  );
}


===== FILE: screens\EntryScreen.js =====

import React, { useState } from "react";
import { View, Pressable, Alert, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import AsyncStorage from '@react-native-async-storage/async-storage';
import RedButton from "../components/Red_button";
import BackgroundPaper from "../components/Background_paper";
import InputField from "../components/Input_field";
import api from "../src/api/client";

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 50px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

const OwlReadsSubTitle = styled.Text`
  color: #2F2017;
  font-family: "KoPub-Batang-Regular";
  font-size: 15px;
  text-align: center;
  letter-spacing: 2.5px;
`;

const RegistrationCard = styled.View`
  margin-top: 165px;
  gap: 20px;
  align-items: center;
  width: auto;
  flex-direction: column;
  justify-content: center;
  width: auto;
  margin-left: 32px;
  margin-right: 32px;
`;

const RegistrationCardTitle = styled.Text`
  color: #890524;
  font-family: "VollkornSC-Regular";
  font-size: 25px;
  text-align: center;
`;

const ForgotPasswordContainer = styled.View`
  width: 100%;
  align-items: flex-end;
`;

const ForgotPasswordText = styled.Text`
  color: #890524;
  font-family: "Inter-Regular";
  font-size: 13px;
  text-align: right;
`;

export default function EntryScreen({ navigation }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  
  // Ошибки для конкретных полей
  const [errors, setErrors] = useState({});
  const [isLoading, setIsLoading] = useState(false);

  const handleForgotPassword = () => {
    console.log("Переход на экран восстановления пароля");
    // navigation.navigate("ForgotPassword");
  };

  const handleLogin = async () => {
    // 1. Сброс ошибок
    setErrors({});
    let valid = true;
    let newErrors = {};

    // 2. Валидация
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!email.trim()) {
      newErrors.email = "Введите email*";
      valid = false;
    } else if (!emailRegex.test(email)) {
      newErrors.email = "Некорректный email*";
      valid = false;
    }

    if (!password) {
      newErrors.password = "Введите пароль*";
      valid = false;
    }

    if (!valid) {
      setErrors(newErrors);
      return;
    }

    // 3. Отправка запроса
    setIsLoading(true);
    try {
      const response = await api.post("/api/auth/login", {
        email: email,
        password: password
      });

      console.log("Вход успешен:", response.data);
      
      // СОХРАНЯЕМ ДАННЫЕ
      await AsyncStorage.setItem('userToken', response.data.access_token);
      await AsyncStorage.setItem('userId', String(response.data.user_id)); // Важно сохранить ID

      navigation.navigate("Home");

    } catch (error) {
      console.error("Ошибка входа:", error);
      if (error.response && error.response.status === 401) {
        Alert.alert("Ошибка входа", "Неверный email или пароль");
      } else {
        Alert.alert("Ошибка", "Проверьте соединение с интернетом");
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Очистка ошибки при вводе
  const clearError = (field) => {
    setErrors((prev) => ({ ...prev, [field]: "" }));
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ top: 100 }}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <OwlReadsSubTitle>Начни свою {"\n"} книжную историю!</OwlReadsSubTitle>
      </View>
      <BackgroundPaper />
      
      <RegistrationCard>
        <RegistrationCardTitle>Вход</RegistrationCardTitle>
        
        <InputField
          value={email}
          onChangeText={(text) => { setEmail(text); clearError("email"); }}
          placeholder="Электронная почта"
          error={errors.email}
          keyboardType="email-address"
          autoCapitalize="none"
        />
        
        <InputField
          value={password}
          onChangeText={(text) => { setPassword(text); clearError("password"); }}
          placeholder="Пароль"
          error={errors.password}
          secureTextEntry={true}
        />
        
        <ForgotPasswordContainer>
          <Pressable onPress={handleForgotPassword}>
            <ForgotPasswordText>Забыли пароль?</ForgotPasswordText>
          </Pressable>
        </ForgotPasswordContainer>

        {isLoading ? (
          <ActivityIndicator size="large" color="#890524" />
        ) : (
          // Важно: используем onPress, а не screen
          <RedButton name={"Продолжить чтение"} onPress={handleLogin} />
        )}
      </RegistrationCard>
    </View>
  );
}

===== FILE: screens\HomeScreen.js =====

// screens/HomeScreen.js
import React, { useEffect, useState } from "react";
import { View, Image } from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";

import Quote from "../components/Popular_quote";
import NavigationBar from "../components/Navigation_bar";
import { TabBar } from "../components/Tab_bar";
import AddBookModal from "../components/Add_book_modal";
import api from "../src/api/client";

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  justify-content: center;
  align-items: center;
  text-align: center;
  margin-top: 48px;
`;

export default function HomeScreen() {
  const navigation = useNavigation();
  const [quote, setQuote] = useState(null);
  
  const [isModalVisible, setModalVisible] = useState(false);

  const icons = [
    { name: "home", source: require("../assets/home_active.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" }, 
    { name: "message", source: require("../assets/message.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user.png"), screen: "Account" },
  ];

  useEffect(() => {
    async function fetchQuote() {
      try {
        const response = await api.get("/api/quotes/random");
        setQuote(response.data);
      } catch (error) {
        console.error("Ошибка загрузки цитаты:", error);
      }
    }
    fetchQuote();
  }, []);

  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setModalVisible(true); 
    } else {
      navigation.navigate(screenName); 
    }
  };

  const handleSearch = () => {
    setModalVisible(false);
    console.log("Идем искать книгу...");
  };

  const handleAddManual = () => {
    setModalVisible(false);
    console.log("Идем добавлять вручную...");
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ flexDirection: "column" }}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <Image
          source={require("../assets/Owl_and_bookshelves.png")}
          style={{ width: 368, height: 149, resizeMode: "cover", marginBottom: -4, marginLeft: 25, zIndex: 1 }}
        />
        {quote && (
          <Quote quote_text={quote.text} quote_author={`@${quote.book_title}`} />
        )}
      </View>

      <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
      
      <TabBar color={"#D7C1AB"} />

      <AddBookModal 
        visible={isModalVisible}
        onClose={() => setModalVisible(false)}
        onSearch={handleSearch}
        onAdd={handleAddManual}
      />
    </View>
  );
}

===== FILE: screens\LibraryScreen.js =====

import React, { useState, useCallback } from "react";
import { View, FlatList, TouchableWithoutFeedback, ActivityIndicator, Text } from "react-native";
import styled from "styled-components/native";
import { useNavigation, useFocusEffect } from "@react-navigation/native"; 
import AsyncStorage from '@react-native-async-storage/async-storage';

// Импорты компонентов
import NavigationBar from "../components/Navigation_bar";
import { BookCard } from "../components/Book_card";
import { TabBar } from "../components/Tab_bar";
import { TextBox } from "../components/TextBox_props";
import RatingStars from "../components/Rating_starts";
import RedButton from "../components/Red_button";
import AddBookModal from "../components/Add_book_modal"; 
import api from "../src/api/client"; // <--- API клиент

// ... (Стили оставляем без изменений: OwlReadsTitle, Separator, Overlay и т.д.) ...
const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 30px;
  font-weight: 400;
  justify-content: center;
  align-items: center;
  text-align: center;
  margin-top: 48px;
`;
const Separator = styled.View`
  height: 2px;
  background-color: #FDF5E2;
  margin-top: 5px;
`;
const Overlay = styled.View`
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.65);
  justify-content: flex-end;
  align-items: center;
`;
const Circle = styled.View`
  position: absolute;
  bottom: -337px;
  width: 770px;
  height: 770px;
  border-radius: 385px;
  background-color: #FDF5E2;
`;
const OverlayContent = styled.View`
  flex: 1;
  align-items: center;
  bottom: 0;
  position: absolute;
  width: 100%;
  padding: 12px;
  gap: 8px;
  padding-bottom: 60px;
`;
const OverlayCover = styled.Image`
  height: ${({ height }) => height || 160}px;
  width: ${({ width }) => width || 110}px;
  border-radius: 7px;
`;
const OverlayTitle = styled.Text`
  font-family: VollkornSC-Regular;
  font-size: 17px;
  color: #890524;
  align-self: flex-start;
`;
const OverlayAuthor = styled.Text`
  font-family: Inter-Regular;
  font-size: 14px;
  color: #2F2017;
  align-self: flex-start;
`;

export default function LibraryScreen() {
  const navigation = useNavigation();
  
  const [overlayVisible, setOverlayVisible] = useState(false);
  const [selectedBook, setSelectedBook] = useState(null);
  const [isAddBookModalVisible, setAddBookModalVisible] = useState(false);
  
  // --- Новые состояния ---
  const [books, setBooks] = useState([]);
  const [loading, setLoading] = useState(true);

  const icons = [
    { name: "home", source: require("../assets/home.png"), screen: "Home" },
    { name: "open_book", source: require("../assets/open_book_active.png"), screen: "Library" },
    { name: "add_book", source: require("../assets/add_book.png"), screen: "AddBookModal" },
    { name: "message", source: require("../assets/message.png"), screen: "Chats" },
    { name: "user", source: require("../assets/user.png"), screen: "Account" },
  ];

  const handleNavigationPress = (screenName) => {
    if (screenName === "AddBookModal") {
      setAddBookModalVisible(true);
    } else {
      navigation.navigate(screenName);
    }
  };

  const handleSearchBook = () => {
    setAddBookModalVisible(false);
    navigation.navigate("SearchBook"); // Убедись, что экран так называется в App.js
  };

  const handleAddManual = () => {
    setAddBookModalVisible(false);
    navigation.navigate("AddBookManual");
  };

  // --- Загрузка книг ---
  useFocusEffect(
    useCallback(() => {
      const fetchLibrary = async () => {
        setLoading(true);
        try {
          const userId = await AsyncStorage.getItem('userId');
          if (!userId) return;

          const response = await api.get(`/api/users_book_review/library/${userId}`);
          setBooks(response.data);
        } catch (error) {
          console.error("Ошибка загрузки библиотеки:", error);
        } finally {
          setLoading(false);
        }
      };

      fetchLibrary();
    }, [])
  );

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ flexDirection: "column", flex: 1 }}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <Separator />
        
        {loading ? (
          <ActivityIndicator size="large" color="#890524" style={{ marginTop: 20 }} />
        ) : (
          <FlatList
            data={books}
            keyExtractor={(item) => String(item.review_id)}
            renderItem={({ item }) => (
              <BookCard
                cover={item.cover_url ? { uri: item.cover_url } : require("../assets/default_cover_book.png")}
                category={item.category_name}
                categorycolor={item.category_color}
                title={item.title}
                author={item.author}
                rating={item.rating}
                onPress={() => {
                  setSelectedBook(item);
                  setOverlayVisible(true);
                }}
              />
            )}
            contentContainerStyle={{ paddingBottom: 100, paddingTop: 10 }}
            ListEmptyComponent={
              <Text style={{ textAlign: 'center', marginTop: 20, color: '#2F2017', fontFamily: 'Inter-Regular' }}>
                В вашей библиотеке пока нет книг.
              </Text>
            }
          />
        )}
      </View>

      <NavigationBar icons={icons} onPressOverride={handleNavigationPress} />
      
      {!isAddBookModalVisible && <TabBar color={"#D7C1AB"} />}

      <AddBookModal 
        visible={isAddBookModalVisible}
        onClose={() => setAddBookModalVisible(false)}
        onSearch={handleSearchBook}
        onAdd={handleAddManual}
      />

      {/* Оверлей */}
      {overlayVisible && selectedBook && (
        <TouchableWithoutFeedback onPress={() => setOverlayVisible(false)}>
          <Overlay>
            <Circle />
            <OverlayContent>
              <OverlayCover 
                source={selectedBook.cover_url ? { uri: selectedBook.cover_url } : require("../assets/default_cover_book.png")} 
                resizeMode="cover" 
              />

              <View style={{ alignSelf: 'center' }}>
                <TextBox text={selectedBook.category_name} color={selectedBook.category_color} />
              </View>

              <OverlayTitle>{selectedBook.title}</OverlayTitle>
              <OverlayAuthor>{selectedBook.author}</OverlayAuthor>

              <View style={{ alignSelf: 'flex-start', marginTop: 8 }}>
                <RatingStars
                  rating={selectedBook.rating}
                  size={40}
                  filledImage={require('../assets/star_filled.png')}
                  emptyImage={require('../assets/star_empty.png')}
                />
              </View>
              
              {/* Переход к деталям книги (нужно будет передать ID) */}
              <RedButton 
                name={"Подробнее"} 
                onPress={() => {
                    setOverlayVisible(false);
                    navigation.navigate("Book", { reviewId: selectedBook.review_id });
                    console.log("Переход к книге:", selectedBook.review_id);
                }}
              />
            </OverlayContent>
          </Overlay>
        </TouchableWithoutFeedback>
      )}
    </View>
  );
}

===== FILE: screens\RegistrationScreen.js =====

import React, { useState } from "react";
import { View, Pressable, Alert, ActivityIndicator } from "react-native";
import styled from "styled-components/native";
import RedButton from "../components/Red_button";
import BackgroundPaper from "../components/Background_paper";
import InputField from "../components/Input_field";
import api from "../src/api/client"; // Убедись, что путь правильный

// --- STYLED COMPONENTS (Без изменений) ---
const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 50px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

const OwlReadsSubTitle = styled.Text`
  color: #2F2017;
  font-family: "KoPub-Batang-Regular";
  font-size: 15px;
  text-align: center;
  letter-spacing: 2.5px;
`;

const RegistrationCard = styled.View`
  margin-top: 165px;
  gap: 20px;
  align-items: center;
  width: auto;
  flex-direction: column;
  justify-content: center;
  width: auto;
  margin-left: 32px;
  margin-right: 32px;
`;

const RegistrationCardTitle = styled.Text`
  color: #890524;
  font-family: "VollkornSC-Regular";
  font-size: 25px;
  text-align: center;
`;

const CheckboxContainer = styled.View`
  flex-direction: row;
  align-items: flex-start;
  margin-horizontal: 32px;
`;

const CheckboxBox = styled.View`
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border-width: 2px;
  border-color: #D3CDBF;
  background-color: ${(props) => (props.checked ? "#890524" : "transparent")};
  margin-right: 10px;
`;

const CheckboxLabel = styled.Text`
  color: #A28C75;
  font-family: "Inter-Regular";
  font-size: 13px;
  flex-shrink: 1;
`;

export default function RegistrationScreen({ navigation }) {
  const [step, setStep] = useState(1);
  const [isLoading, setIsLoading] = useState(false);

  // Данные формы
  const [username, setUserName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [passwordDuble, setPasswordDuble] = useState("");
  const [accepted, setAccepted] = useState(false);
  const [code, setCode] = useState("");

  // Ошибки
  const [errors, setErrors] = useState({});

  // --- ВАЛИДАЦИЯ ФОРМЫ ---
  const validateStep1 = () => {
    let valid = true;
    let newErrors = {};

    if (!username.trim()) {
      newErrors.username = "Введите имя пользователя*";
      valid = false;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email.trim()) {
      newErrors.email = "Введите email*";
      valid = false;
    } else if (!emailRegex.test(email)) {
      newErrors.email = "Некорректный формат email*";
      valid = false;
    }

    if (!password) {
      newErrors.password = "Введите пароль*";
      valid = false;
    } else if (password.length < 6) {
      newErrors.password = "Минимум 6 символов*";
      valid = false;
    }

    if (password !== passwordDuble) {
      newErrors.passwordDuble = "Пароли не совпадают*";
      valid = false;
    }

    setErrors(newErrors);
    return valid;
  };

  // --- ШАГ 1: РЕГИСТРАЦИЯ ---
  const handleRegister = async () => {
    // 1. Проверка полей
    if (!validateStep1()) return;

    // 2. Проверка чекбокса
    if (!accepted) {
      Alert.alert("Ошибка", "Необходимо принять условия соглашения");
      return;
    }

    setIsLoading(true);
    try {
      // 3. Отправка на бэкенд
      const payload = {
        username: username,
        email: email,
        password_hash: password, // Бэк сам захеширует
        agreement_accepted: accepted,
        profile_photo: null
      };

      // POST /api/users_personal_data/
      await api.post("/api/users_personal_data/", payload);
      
      // Если успешно (201 Created), переходим к вводу кода
      setStep(2);

    } catch (error) {
      console.error("Ошибка регистрации:", error);
      if (error.response) {
        const detail = error.response.data.detail;
        // Обработка ошибок от FastAPI
        if (typeof detail === "string") {
            if (detail.includes("Email")) {
                setErrors(prev => ({ ...prev, email: "Email уже занят*" }));
            } else if (detail.includes("username")) { // Если добавишь проверку юзернейма на бэке
                setErrors(prev => ({ ...prev, username: "Имя занято*" }));
            } else {
                Alert.alert("Ошибка", detail);
            }
        } else {
            Alert.alert("Ошибка", "Проверьте данные");
        }
      } else {
        Alert.alert("Ошибка сети", "Нет соединения с сервером");
      }
    } finally {
      setIsLoading(false);
    }
  };

  // --- ШАГ 2: ПОДТВЕРЖДЕНИЕ КОДА ---
  const handleConfirmRegistration = async () => {
    if (!code.trim()) {
      setErrors({ code: "Введите код подтверждения*" });
      return;
    }

    setIsLoading(true);
    try {
      // POST /api/users_personal_data/verify
      const payload = {
        email: email,
        code: code
      };

      await api.post("/api/users_personal_data/verify", payload);
      
      // Если успешно (200 OK), переходим к финалу
      setStep(3);

    } catch (error) {
      console.error("Ошибка верификации:", error);
      if (error.response && error.response.status === 400) {
        setErrors({ code: "Неверный код подтверждения*" });
      } else {
        Alert.alert("Ошибка", "Не удалось подтвердить код");
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleResendCode = () => {
    // Пока просто заглушка, так как на бэке нет отдельного эндпоинта resend
    // Можно попробовать вызвать create_user снова, но он вернет 400, если юзер есть.
    // Для MVP можно сказать пользователю проверить спам.
    Alert.alert("Инфо", "Проверьте папку Спам. Если письма нет, попробуйте зарегистрироваться заново через 10 минут.");
  };

  // Функция для очистки ошибки при вводе
  const clearError = (field) => {
    setErrors((prev) => ({ ...prev, [field]: "" }));
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB" }}>
      <View style={{ top: 100 }}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <OwlReadsSubTitle>Начни свою {"\n"} книжную историю!</OwlReadsSubTitle>
      </View>
      <BackgroundPaper />

      {/* --- ЭКРАН 1: ВВОД ДАННЫХ --- */}
      {step === 1 && (
        <RegistrationCard>
          <RegistrationCardTitle>Регистрация</RegistrationCardTitle>
          
          <InputField
            value={username}
            onChangeText={(text) => { setUserName(text); clearError("username"); }}
            placeholder="Имя пользователя"
            error={errors.username}
          />
          <InputField
            value={email}
            onChangeText={(text) => { setEmail(text); clearError("email"); }}
            placeholder="Электронная почта"
            error={errors.email}
            keyboardType="email-address"
            autoCapitalize="none"
          />
          <InputField
            value={password}
            onChangeText={(text) => { setPassword(text); clearError("password"); }}
            placeholder="Пароль"
            error={errors.password}
            secureTextEntry={true} // Скрываем пароль
          />
          <InputField
            value={passwordDuble}
            onChangeText={(text) => { setPasswordDuble(text); clearError("passwordDuble"); }}
            placeholder="Повторите пароль"
            error={errors.passwordDuble}
            secureTextEntry={true} // Скрываем пароль
          />

          <Pressable onPress={() => setAccepted(!accepted)}>
            <CheckboxContainer>
              <CheckboxBox checked={accepted} />
              <CheckboxLabel>
                Я ознакомлен(а) и принимаю условия Пользовательского соглашения и Политику конфиденциальности
              </CheckboxLabel>
            </CheckboxContainer>
          </Pressable>

          {isLoading ? (
            <ActivityIndicator size="large" color="#890524" />
          ) : (
            <RedButton name={"Зарегистрироваться"} onPress={handleRegister} />
          )}
        </RegistrationCard>
      )}

      {/* --- ЭКРАН 2: ВВОД КОДА --- */}
      {step === 2 && (
        <RegistrationCard>
          <RegistrationCardTitle>Подтверждение регистрации</RegistrationCardTitle>
          <CheckboxLabel style={{ marginHorizontal: 32, marginBottom: 10, textAlign: "center" }}>
            На вашу почту отправлен код подтверждения. Введите его ниже, чтобы завершить регистрацию.
          </CheckboxLabel>

          <InputField
            value={code}
            onChangeText={(text) => { setCode(text); clearError("code"); }}
            placeholder="Введите код из письма"
            error={errors.code}
            keyboardType="number-pad"
          />

          <Pressable onPress={handleResendCode}>
            <CheckboxLabel style={{ color: "#890524", marginHorizontal: 32, marginBottom: 162, textAlign: "right" }}>
              Отправить код ещё раз
            </CheckboxLabel>
          </Pressable>

          {isLoading ? (
            <ActivityIndicator size="large" color="#890524" />
          ) : (
            <RedButton name={"Подтвердить регистрацию"} onPress={handleConfirmRegistration} />
          )}
        </RegistrationCard>
      )}

      {/* --- ЭКРАН 3: УСПЕХ --- */}
      {step === 3 && (
        <RegistrationCard style={{ gap: 295 }}>
          <View style={{ gap: 20 }}>
            <RegistrationCardTitle>Подтверждение регистрации</RegistrationCardTitle>
            <CheckboxLabel style={{ marginHorizontal: 32, marginBottom: 10, textAlign: "center" }}>
              Ваша регистрация прошла успешно.
            </CheckboxLabel>
          </View>

          <RedButton 
            name={"Войти"} 
            onPress={() => navigation.navigate("Entry")} // Убедись, что экран называется "Entry"
          />
        </RegistrationCard>
      )}
    </View>
  );
}

===== FILE: screens\StartScreen.js =====

import React from "react";
import { View, Image} from "react-native";
import styled from "styled-components/native";
import { useNavigation } from "@react-navigation/native";
import RedButton from "../components/Red_button";

const OwlReadsTitle = styled.Text`
  color: #fdf5e2;
  font-family: "Marck Script-Regular";
  font-size: 50px;
  font-weight: 400;
  text-align: center;
  margin-top: 48px;
`;

const OwlReadsSubTitle = styled.Text`
  color: #2F2017;
  font-family: "KoPub-Batang-Regular";
  font-size: 15px;
  text-align: center;
  letter-spacing: 2.5px;
`;

const Buttons = styled.View`
  margin-top: auto;
  margin-bottom: 60px;
  gap: 10px;
  align-items: center;
  width: auto;
  flex-direction: column;
  justify-content: center;
  width: auto;
  margin-left: 32px;
  margin-right: 32px;
`;

const ButtonContainer = styled.TouchableOpacity`
  background-color: #D7C1AB;
  border: 1px solid #6C5141;
  border-radius: 14px;
  padding-vertical: 20px;
  margin-horizontal: 32px;
  align-items: center;
  justify-content: center;
  shadow-color: #230109;
  shadow-offset: 0px 4px;
  shadow-opacity: 0.3;
  shadow-radius: 4px;

  elevation: 6;
  width: 100%;
`;

const ButtonText = styled.Text`
  color: #2F2017;
  font-family: "Inter-Regular";
  font-size: 15px;
  text-align: center;
`;

const OwlImage = styled.Image`
  width: 242px;
  height: 293px;
  align-self: center;
  bottom: 240px;
  align-items: center;
  justify-content: center;
  position: absolute;
`;

export default function StartScreen() {
  const navigation = useNavigation();

  return (
    <View style={{ flex: 1, backgroundColor: "#D7C1AB", flexDirection: "column"}}>
      <View style={{top: 100}}>
        <OwlReadsTitle>OwlReads</OwlReadsTitle>
        <OwlReadsSubTitle>Начни свою {"\n"} книжную историю!</OwlReadsSubTitle>
      </View>

      <OwlImage source={require("../assets/Owl.png")}/>
      <Buttons>
        <RedButton screen={"Registration"} name={"Зарегистрироваться"}/>

        <ButtonContainer onPress={() => navigation.navigate("Entry")}>
          <ButtonText>Продолжить чтение</ButtonText>
        </ButtonContainer>
      </Buttons>     
    </View>
  );
}

===== FILE: src\api\client.js =====

import axios from "axios";

const api = axios.create({
  baseURL: process.env.EXPO_PUBLIC_API_URL,
});

export default api;
